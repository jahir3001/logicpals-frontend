-- ============================================
-- LOGICPALS FINAL PRODUCTION SCHEMA
-- STRATEGY: Manual Onboarding via App (No Auth Triggers)
-- ============================================

-- 1. CLEANUP (Wipe everything for a fresh start)
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
DROP FUNCTION IF EXISTS public.handle_new_user();
DROP VIEW IF EXISTS school_leaderboard;
DROP TABLE IF EXISTS attempts CASCADE;
DROP TABLE IF EXISTS problems CASCADE;
DROP TABLE IF EXISTS children CASCADE;
DROP TABLE IF EXISTS profiles CASCADE;

-- 2. CREATE TABLES

-- PROFILES (Parents)
CREATE TABLE profiles (
  id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email text UNIQUE NOT NULL,
  full_name text NOT NULL,
  phone text,
  role text DEFAULT 'parent',
  subscription_status text DEFAULT 'trial',
  created_at timestamptz DEFAULT now()
);

-- CHILDREN (Students)
CREATE TABLE children (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  parent_id uuid NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  name text NOT NULL,
  age integer,
  age_category text, -- '8-10', etc.
  school_name text DEFAULT 'My School',
  curriculum text,
  difficulty_level text DEFAULT 'medium',
  total_problems_solved integer DEFAULT 0,
  streak_days integer DEFAULT 0,
  last_activity_date date,
  created_at timestamptz DEFAULT now()
);

-- PROBLEMS (Content)
CREATE TABLE problems (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  title text NOT NULL,
  problem_text text NOT NULL,
  age_category text NOT NULL,
  difficulty text NOT NULL,
  hints jsonb,
  solution_explanation text,
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now()
);

-- ATTEMPTS (Activity)
CREATE TABLE attempts (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  child_id uuid NOT NULL REFERENCES children(id) ON DELETE CASCADE,
  problem_id uuid NOT NULL REFERENCES problems(id) ON DELETE CASCADE,
  solved_correctly boolean DEFAULT false,
  hints_used integer DEFAULT 0,
  questions_asked integer DEFAULT 0,
  ai_conversation jsonb,
  completed_at timestamptz DEFAULT now(),
  created_at timestamptz DEFAULT now()
);

-- 3. THE LEADERBOARD VIEW (The Engine)
CREATE VIEW school_leaderboard AS
SELECT 
  c.school_name,
  SUM(c.total_problems_solved) * 10 as total_points
FROM children c
WHERE c.school_name IS NOT NULL 
  AND c.school_name != ''
  AND c.school_name != 'My School'
GROUP BY c.school_name
ORDER BY total_points DESC;

-- 4. ROW LEVEL SECURITY (The Security)
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE children ENABLE ROW LEVEL SECURITY;
ALTER TABLE attempts ENABLE ROW LEVEL SECURITY;
ALTER TABLE problems ENABLE ROW LEVEL SECURITY;

-- Profiles: Users see/edit their own
CREATE POLICY "Users view own profile" ON profiles FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users insert own profile" ON profiles FOR INSERT WITH CHECK (auth.uid() = id);
CREATE POLICY "Users update own profile" ON profiles FOR UPDATE USING (auth.uid() = id);

-- Children: Parents see/edit their kids
CREATE POLICY "Parents view kids" ON children FOR SELECT USING (parent_id = auth.uid());
CREATE POLICY "Parents insert kids" ON children FOR INSERT WITH CHECK (parent_id = auth.uid());
CREATE POLICY "Parents update kids" ON children FOR UPDATE USING (parent_id = auth.uid());

-- Attempts: Parents see kids' attempts
CREATE POLICY "Parents view attempts" ON attempts FOR SELECT USING (
  child_id IN (SELECT id FROM children WHERE parent_id = auth.uid())
);
CREATE POLICY "Parents insert attempts" ON attempts FOR INSERT WITH CHECK (
  child_id IN (SELECT id FROM children WHERE parent_id = auth.uid())
);

-- Problems: Everyone reads active problems
CREATE POLICY "Public read problems" ON problems FOR SELECT USING (is_active = true);

-- Leaderboard: Everyone reads
GRANT SELECT ON school_leaderboard TO anon, authenticated;

-- 5. SEED DATA (Problems)
INSERT INTO problems (title, problem_text, age_category, difficulty, hints) VALUES
('Odd Number', 'I am an odd number. Take away a letter and I become even. What number am I?', '8-10', 'medium', '["Think of word play", "Write down the word SEVEN", "Remove the letter S"]'),
('Singara Math', 'If 3 Singaras cost 15 Taka, how much do 5 Singaras cost?', '8-10', 'easy', '["Find cost of 1 singara", "15 divided by 3 is 5", "Now multiply 5 by 5"]');