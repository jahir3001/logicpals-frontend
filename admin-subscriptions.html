<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LogicPals Console — Subscriptions</title>
  <link rel="stylesheet" href="/lp_design.css"/>
  <script src="/api/env"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{background:#f5f7fb;}
    .wrap{max-width:1100px;margin:0 auto;padding:24px;}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;background:#fff;border:1px solid rgba(15,23,42,.08);border-radius:16px;padding:14px 16px;box-shadow:0 10px 30px rgba(2,6,23,.06);}
    .h{display:flex;align-items:center;gap:12px;}
    .logo{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,#5b8cff,#7c3aed);color:#fff;font-weight:800}
    .btn{appearance:none;border:1px solid rgba(15,23,42,.12);background:#fff;border-radius:12px;padding:10px 12px;font-weight:700;font-size:13px;color:#0f172a;cursor:pointer;text-decoration:none;display:inline-flex;gap:8px;align-items:center}
    .btn.primary{background:#4f46e5;color:#fff;border-color:transparent}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(15,23,42,.10);background:#fff;border-radius:999px;padding:8px 12px;font-size:12px;color:#0f172a}
    .dot{width:8px;height:8px;border-radius:999px;background:#94a3b8}
    .dot.ok{background:#22c55e}
    .card{margin-top:18px;background:#fff;border:1px solid rgba(15,23,42,.08);border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.06);padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:820px){.row{grid-template-columns:1fr}}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(15,23,42,.12)}
    label{font-size:12px;color:#64748b}
    pre{white-space:pre-wrap;background:#0b1220;color:#e5e7eb;padding:12px;border-radius:12px;margin-top:12px}
    .muted{color:#64748b;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="h">
        <div class="logo">LP</div>
        <div>
          <div style="font-weight:900;color:#0f172a;">Subscriptions</div>
          <div class="muted">Admin-only — refund / charge / reconcile (RPC-only)</div>
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center">
        <div class="pill" id="authPill"><span class="dot" id="dot"></span><span id="authText">Loading…</span></div>
        <a class="btn" href="/admin.html">Back to Admin</a>
        <button class="btn primary" id="btnSignIn">Sign in</button>
        <button class="btn" id="btnSignOut" style="display:none;">Log out</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>Customer email</label>
          <input id="email" placeholder="student_or_parent@email.com"/>
        </div>
        <div>
          <label>Track</label>
          <select id="track">
            <option value="regular">Regular</option>
            <option value="olympiad">Olympiad</option>
          </select>
        </div>
        <div>
          <label>Action</label>
          <select id="action">
            <option value="list">List payments</option>
            <option value="refund">Refund (requires receipt)</option>
            <option value="reconcile">Reconcile status</option>
          </select>
        </div>
        <div>
          <label>Reference (receipt/txn id)</label>
          <input id="ref" placeholder="optional"/>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;">
        <button class="btn primary" id="run">Run</button>
        <button class="btn" id="trust">Load trust summary</button>
      </div>
      <pre id="out">Waiting…</pre>
      <div class="muted" style="margin-top:10px;">Expected RPCs: admin_list_subscriptions, admin_extend_subscription, admin_cancel_subscription, admin_trust_summary.</div>
    </div>
  </div>

  <dialog id="dlg" style="border:none;border-radius:16px;max-width:420px;width:calc(100% - 24px);padding:0;box-shadow:0 20px 70px rgba(2,6,23,.25);">
    <div style="padding:16px 16px 0 16px;background:#fff;border-bottom:1px solid rgba(15,23,42,.08);border-top-left-radius:16px;border-top-right-radius:16px;">
      <b style="font-size:16px;color:#0f172a;">Sign in</b>
      <div class="muted" style="font-size:13px;margin-top:4px;">Admin account email + password.</div>
    </div>
    <div style="padding:16px;background:#fff;border-bottom-left-radius:16px;border-bottom-right-radius:16px;">
      <label>Email</label>
      <input id="le" type="email" style="margin-top:6px"/>
      <div style="height:10px"></div>
      <label>Password</label>
      <input id="lp" type="password" style="margin-top:6px"/>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap;">
        <button class="btn" id="cancel" type="button">Cancel</button>
        <button class="btn primary" id="go" type="button">Sign in</button>
      </div>
    </div>
  </dialog>

  <script>
    const $=id=>document.getElementById(id);
    function env(){
      if(!window.__LP_ENV) throw new Error('Missing window.__LP_ENV. /api/env not loaded.');
      return window.__LP_ENV;
    }
    if(!window.supabase?.createClient) console.warn('Supabase UMD not loaded');

    let sb=null;

    function setAuth(ok, email){
      $('dot').className = ok ? 'dot ok' : 'dot';
      $('authText').textContent = ok ? ('Signed in' + (email?': '+email:'')) : 'Signed out';
      $('btnSignIn').style.display = ok ? 'none' : '';
      $('btnSignOut').style.display = ok ? '' : 'none';
    }

    async function refresh(){
      const { data } = await sb.auth.getSession();
      const s = data?.session;
      setAuth(!!s, s?.user?.email || '');
    }

    async function signin(){
      const { error } = await sb.auth.signInWithPassword({ email: $('le').value.trim(), password: $('lp').value });
      if(error){ $('out').textContent='Login failed: '+error.message; return; }
      $('dlg').close(); await refresh();
    }
    async function signout(){ await sb.auth.signOut(); await refresh(); }

    async function callRpc(name, args){
      const { data, error } = await sb.rpc(name, args||{});
      if(error) throw error;
      return data;
    }

    (async ()=>{
      const e = env();
      sb = window.supabase.createClient(e.SUPABASE_URL, e.SUPABASE_ANON_KEY);
      sb.auth.onAuthStateChange(()=>refresh());
      $('btnSignIn').onclick=()=>$('dlg').showModal();
      $('cancel').onclick=()=>$('dlg').close();
      $('go').onclick=signin;
      $('btnSignOut').onclick=signout;

      $('run').onclick=async ()=>{
        $('out').textContent='Running…';
        try{
          const email = $('email').value.trim();
          const track = $('track').value;
          const action = $('action').value;
          const ref = $('ref').value.trim() || null;

          if(action==='list'){
            const data = await callRpc('admin_list_subscriptions', { p_email: email, p_track: track });
            $('out').textContent = JSON.stringify(data, null, 2);
          }else if(action==='refund'){
            const data = await callRpc('admin_extend_subscription', { p_email: email, p_track: track, p_reference: ref });
            $('out').textContent = JSON.stringify(data, null, 2);
          }else{
            const data = await callRpc('admin_cancel_subscription', { p_email: email, p_track: track, p_reference: ref });
            $('out').textContent = JSON.stringify(data, null, 2);
          }
        }catch(err){
          $('out').textContent = 'ERROR: ' + (err?.message || String(err));
        }
      };

      $('trust').onclick=async ()=>{
        $('out').textContent='Loading trust summary…';
        try{
          const email = $('email').value.trim();
          const data = await callRpc('admin_trust_summary', { p_email: email });
          $('out').textContent = JSON.stringify(data, null, 2);
        }catch(err){
          $('out').textContent='ERROR: ' + (err?.message || String(err));
        }
      };

      await refresh();
    })();
  </script>
</body>
</html>
