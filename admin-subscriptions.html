<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LogicPals Admin — Subscriptions</title>
  <link rel="stylesheet" href="lp_design.css" />
</head>
<body>
  <div class="wrap">
    <div class="lp-topbar">
      <div class="lp-brand">
        <div class="lp-logo"></div>
        <div>
          <div class="lp-title">Subscriptions</div>
          <div class="lp-sub">Admin-only — list / extend / cancel (RPC-only)</div>
        </div>
      </div>
      <div class="lp-right">
        <div class="lp-badge" id="who">Signed out</div>
        <button class="lp-btn" id="btnBack">Back to Admin</button>
        <button class="lp-btn danger" id="btnSignOut">Log out</button>
      </div>
    </div>

    <div class="lp-card">
      <div class="lp-panelTitle">
        <h3>Manage a customer</h3>
        <span class="lp-statusPill" id="pill">Ready</span>
      </div>

      <div class="filters" style="margin-top:12px">
        <div class="full">
          <label>Customer email</label>
          <input id="email" placeholder="student_or_parent@email.com" autocomplete="email" />
        </div>

        <div class="full row">
          <button class="lp-btn primary" id="btnLoad">Load subscriptions</button>
          <button class="lp-btn" id="btnSummary">Load trust summary</button>
        </div>

        <div>
          <label>Extend months</label>
          <input id="extendMonths" placeholder="1" inputmode="numeric" />
        </div>
        <div>
          <label>Track</label>
          <select id="track">
            <option value="regular">Regular</option>
            <option value="olympiad">Olympiad</option>
          </select>
        </div>
        <div class="full row">
          <button class="lp-btn primary" id="btnExtend">Extend</button>
          <button class="lp-btn danger" id="btnCancel">Cancel</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="lp-muted">Output</div>
      <pre class="lp-mono" id="out" style="white-space:pre-wrap;margin:0;background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:14px;padding:10px;min-height:140px"></pre>

      <div class="lp-hint" style="margin-top:10px">
        Expected RPCs: <span class="lp-mono">admin_list_subscriptions</span>, <span class="lp-mono">admin_extend_subscription</span>,
        <span class="lp-mono">admin_cancel_subscription</span>, <span class="lp-mono">admin_trust_summary</span>.
      </div>
    </div>
  </div>

  <script src="/api/env"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.__LP_ENV || {};
    if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
      alert("Missing Supabase env. Ensure /api/env is deployed and SUPABASE_URL / SUPABASE_ANON_KEY are set.");
    }

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:false, storage: window.localStorage }
    });

    const out = document.getElementById('out');
    const pill = document.getElementById('pill');
    const setPill = (t, kind='ok') => {
      pill.textContent = t;
      const map = { ok:'rgba(79,140,255,.14)', warn:'rgba(255,200,0,.12)', err:'rgba(255,77,77,.12)' };
      pill.style.background = map[kind] || map.ok;
      pill.style.borderColor = kind==='err' ? 'rgba(255,77,77,.30)' : kind==='warn' ? 'rgba(255,200,0,.28)' : 'rgba(255,255,255,.10)';
    };

    async function getMyRole(){
      for(const fn of ['admin_get_my_role','admin_get_my_roles']){
        try{
          const { data, error } = await sb.rpc(fn);
          if(!error && data){
            if(typeof data === 'string') return data;
            if(Array.isArray(data) && data[0]) return (data[0].role || data[0]);
            if(typeof data.role === 'string') return data.role;
          }
        }catch(_){}
      }
      return null;
    }

    const { session } = await window.LPAuth.attach(sb, { requireAuth:true, redirectTo:'login_unified.html' });

    const role = await getMyRole();
    if(!role){
      out.textContent = JSON.stringify({ error:"No admin role. Ask a super_admin to assign you a role." }, null, 2);
      setPill('No access','err');
      throw new Error("No admin role");
    }

    document.getElementById('btnBack').onclick = ()=> window.location.href = './admin_clean_fixed.html';

    async function rpcCall(fn, args){
      const { data, error } = await sb.rpc(fn, args || {});
      if(error) throw error;
      return data;
    }

    document.getElementById('btnLoad').onclick = async ()=>{
      out.textContent = 'Loading…';
      try{
        const target_email = document.getElementById('email').value.trim().toLowerCase();
        const data = await rpcCall('admin_list_subscriptions', { target_email });
        out.textContent = JSON.stringify({ ok:true, data }, null, 2);
      }catch(e){
        out.textContent = JSON.stringify({
          error: (e?.message || String(e)),
          hint: "Create admin_list_subscriptions(target_email) to return both Regular and Olympiad subscription states without leaking other users."
        }, null, 2);
      }
    };

    document.getElementById('btnSummary').onclick = async ()=>{
      out.textContent = 'Loading…';
      try{
        const target_email = document.getElementById('email').value.trim().toLowerCase();
        const data = await rpcCall('admin_trust_summary', { target_email });
        out.textContent = JSON.stringify({ ok:true, data }, null, 2);
      }catch(e){
        out.textContent = JSON.stringify({
          error: (e?.message || String(e)),
          hint: "In Step 7, admin_trust_summary can return: roles, entitlements, recent scoring_events counts, bad_receipt_hashes, audit trail."
        }, null, 2);
      }
    };

    document.getElementById('btnExtend').onclick = async ()=>{
      out.textContent = 'Extending…';
      setPill('Working','warn');
      try{
        const target_email = document.getElementById('email').value.trim().toLowerCase();
        const track = document.getElementById('track').value;
        const months = Number(String(document.getElementById('extendMonths').value||'').trim() || 1);
        const data = await rpcCall('admin_extend_subscription', { target_email, track, months });
        out.textContent = JSON.stringify({ ok:true, data }, null, 2);
        setPill('Extended','ok');
      }catch(e){
        out.textContent = JSON.stringify({
          error: (e?.message || String(e)),
          hint: "Create admin_extend_subscription(target_email, track, months) with audit + max duration rules."
        }, null, 2);
        setPill('Failed','err');
      }
    };

    document.getElementById('btnCancel').onclick = async ()=>{
      out.textContent = 'Cancelling…';
      setPill('Working','warn');
      try{
        const target_email = document.getElementById('email').value.trim().toLowerCase();
        const track = document.getElementById('track').value;
        const data = await rpcCall('admin_cancel_subscription', { target_email, track });
        out.textContent = JSON.stringify({ ok:true, data }, null, 2);
        setPill('Cancelled','ok');
      }catch(e){
        out.textContent = JSON.stringify({
          error: (e?.message || String(e)),
          hint: "Create admin_cancel_subscription(target_email, track) and log who/why."
        }, null, 2);
        setPill('Failed','err');
      }
    };
  </script>

  <script src="lp_auth.js"></script>
</body>
</html>
