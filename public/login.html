<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LogicPals ‚Äî Login</title>
  <style>
    :root{--bg:#EEF2FF;--card:#fff;--text:#1F2937;--muted:#6B7280;--blue:#2563EB;--ring:rgba(37,99,235,.25);--border:#E5E7EB;--danger:#DC2626;}
    *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:radial-gradient(1200px 600px at 30% 20%, #E0E7FF 0%, rgba(224,231,255,0) 60%), radial-gradient(900px 600px at 80% 30%, #FEF3C7 0%, rgba(254,243,199,0) 55%), var(--bg); color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;}
    .card{width:min(520px,100%); background:var(--card); border:1px solid var(--border); border-radius:20px; box-shadow:0 22px 60px rgba(15,23,42,.12); padding:28px;}
    .h{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
    .logo{width:44px;height:44px;border-radius:14px; background:linear-gradient(135deg,#2563EB,#60A5FA); display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;}
    h1{margin:0;font-size:30px;letter-spacing:-.02em;}
    .sub{margin:0;color:var(--muted);font-size:14px;}
    label{display:block;margin-top:16px;font-size:13px;color:var(--muted);font-weight:700;}
    input{width:100%;margin-top:8px;padding:12px 14px;border:1px solid #CBD5E1;border-radius:12px;font-size:16px;outline:none;}
    input:focus{border-color:var(--blue); box-shadow:0 0 0 4px var(--ring);}
    .btn{margin-top:18px;width:100%;padding:12px 14px;border-radius:12px;border:0;background:var(--blue);color:#fff;font-weight:800;font-size:16px;cursor:pointer;}
    .btn[disabled]{opacity:.6;cursor:not-allowed;}
    .err{margin-top:14px; padding:10px 12px;border-radius:12px;background:rgba(220,38,38,.08); border:1px solid rgba(220,38,38,.25); color:var(--danger); font-size:13px; display:none;}
    .row{display:flex;gap:12px;justify-content:center;margin-top:16px;font-size:14px;color:var(--muted);}
    a{color:var(--blue);text-decoration:none;font-weight:700}
    .mini{margin-top:14px; display:flex; justify-content:space-between; gap:10px; align-items:center; font-size:12px; color:var(--muted)}
    .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border); background:#F8FAFC;}
    .dot{width:8px;height:8px;border-radius:999px;background:#9CA3AF}
    .dot.ok{background:#10B981}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="card">
    <div class="h">
      <div class="logo">LP</div>
      <div>
        <h1>Welcome Back üëã</h1>
        <p class="sub">Log in to continue your learning journey.</p>
      </div>
    </div>

    <div class="mini">
      <div class="tag"><span id="envDot" class="dot"></span><span id="envTag">Loading config‚Ä¶</span></div>
      <a href="/index.html">‚Üê Back to Home</a>
    </div>

    <form id="loginForm">
      <label>Email Address</label>
      <input id="email" type="email" autocomplete="email" required />
      <label>Password</label>
      <input id="password" type="password" autocomplete="current-password" required />
      <button id="btnLogin" class="btn" type="submit" disabled>Log In</button>
      <div id="err" class="err"></div>
    </form>

    <div class="row">
      <span>Don't have an account?</span>
      <a href="/signup.html">Sign Up Free</a>
    </div>
  </div>

<script>
(() => {
  "use strict";

  // Enterprise rule: ONE shared Supabase client per page, created ONLY after /api/env arrives.
  let supabaseClient = null;

  const $ = (id) => document.getElementById(id);
  const errBox = $("err");
  const btn = $("btnLogin");

  function setEnv(ok, msg){
    $("envDot").className = "dot" + (ok ? " ok" : "");
    $("envTag").textContent = msg;
  }
  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function clearErr(){
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  async function loadEnv(){
    // IMPORTANT: This must be same origin so it works on Vercel + local.
    const r = await fetch("/api/env", { cache: "no-store" });
    if(!r.ok) throw new Error("env_fetch_failed");
    const j = await r.json();
    if(!j?.SUPABASE_URL || !j?.SUPABASE_ANON_KEY) throw new Error("env_missing_keys");
    return j;
  }

  async function init(){
    try{
      setEnv(false, "Loading config‚Ä¶");
      const env = await loadEnv();
      supabaseClient = window.supabase.createClient(env.SUPABASE_URL, env.SUPABASE_ANON_KEY, {
        auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
      });
      window.supabaseClient = supabaseClient; // optional debug handle
      setEnv(true, "Config loaded");
      btn.disabled = false;

      // If already signed in, go straight to dashboard.
      const { data: { session } } = await supabaseClient.auth.getSession();
      if(session?.user){
        window.location.replace("/dashboard.html");
      }
    }catch(e){
      console.error(e);
      showErr("Login is unavailable: failed to load config. (Check /api/env on Vercel)");
      setEnv(false, "Config load failed");
      btn.disabled = true;
    }
  }

  $("loginForm").addEventListener("submit", async (ev) => {
    ev.preventDefault();
    clearErr();

    if(!supabaseClient){
      showErr("Please wait: still loading config.");
      return;
    }

    const email = $("email").value.trim();
    const password = $("password").value;

    btn.disabled = true;
    btn.textContent = "Signing in‚Ä¶";
    try{
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if(error) throw error;
      if(!data?.session) throw new Error("no_session_returned");

      // Enterprise navigation: replace to avoid weird history loops.
      window.location.replace("/dashboard.html");
    }catch(e){
      console.error(e);
      showErr("Login Failed: " + (e?.message || "unknown_error"));
      btn.disabled = false;
      btn.textContent = "Log In";
    }
  });

  // BFCache hardening: if the browser restores this page, re-check session/config.
  window.addEventListener("pageshow", (e) => {
    if(e.persisted){
      // safest: full reload to restore JS state
      window.location.reload();
    }
  });

  init();
})();
</script>
</body>
</html>
