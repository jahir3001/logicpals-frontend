<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LogicPals ‚Äî Login</title>
  <style>
    :root{
      --bg:#EEF4FF; --card:#ffffff; --text:#111827; --muted:#6B7280;
      --primary:#2563EB; --danger:#EF4444; --border:#E5E7EB;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .wrap{min-height:100vh;display:grid;place-items:center;padding:24px;}
    .card{width:min(520px,92vw);background:var(--card);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.12);padding:34px;}
    h1{margin:0 0 8px;font-size:34px;letter-spacing:-.02em;}
    p{margin:0 0 22px;color:var(--muted);}
    label{display:block;font-weight:600;margin:14px 0 6px;}
    input{width:100%;padding:12px 12px;border:1px solid var(--border);border-radius:10px;font-size:16px;}
    button{width:100%;margin-top:18px;padding:12px 14px;border-radius:10px;border:0;background:var(--primary);color:#fff;font-weight:700;font-size:16px;cursor:pointer;}
    button:disabled{opacity:.6;cursor:not-allowed;}
    .msg{margin-top:14px;padding:12px;border-radius:10px;border:1px solid var(--border);background:#F9FAFB;color:var(--muted);font-size:14px;}
    .msg.err{border-color:#FECACA;background:#FEF2F2;color:var(--danger);}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:14px;}
    .link{color:var(--primary);text-decoration:none;font-weight:600;}
    .tiny{font-size:12px;color:var(--muted);}
  </style>

  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Welcome Back üëã</h1>
      <p>Log in to continue your learning journey.</p>

      <form id="loginForm">
        <label>Email Address</label>
        <input id="email" type="email" autocomplete="email" required />

        <label>Password</label>
        <input id="password" type="password" autocomplete="current-password" required />

        <button id="btnLogin" type="submit" disabled>Loading‚Ä¶</button>
      </form>

      <div id="out" class="msg">Initializing‚Ä¶</div>

      <div class="row">
        <div class="tiny">Don't have an account? <a class="link" href="/signup.html">Sign Up Free</a></div>
      </div>
      <div class="row">
        <a class="link" href="/index.html">‚Üê Back to Home</a>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    let supabaseClient = null;

    function setMsg(text, isErr=false){
      const el = $('out');
      el.textContent = text;
      el.className = 'msg' + (isErr ? ' err' : '');
    }

    async function loadEnv() {
      // Single source of truth for URL/key: your existing Vercel route
      const res = await fetch('/api/env', { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load /api/env (' + res.status + ')');
      const env = await res.json();

      // Expect these keys from your /api/env implementation
      const url = env.SUPABASE_URL || env.supabaseUrl || env.url;
      const anon = env.SUPABASE_ANON_KEY || env.supabaseAnonKey || env.anonKey;

      if (!url || !anon) throw new Error('Missing SUPABASE_URL / SUPABASE_ANON_KEY from /api/env');
      return { url, anon };
    }

    async function initSupabase() {
      try {
        const { url, anon } = await loadEnv();

        supabaseClient = window.supabase.createClient(url, anon, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true
          }
        });

        $('btnLogin').disabled = false;
        $('btnLogin').textContent = 'Log In';
        setMsg('Ready.');
      } catch (e) {
        $('btnLogin').disabled = true;
        $('btnLogin').textContent = 'Log In';
        setMsg('Login init failed: ' + (e?.message || String(e)), true);
      }
    }

    $('loginForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();

      if (!supabaseClient) {
        setMsg('Supabase not initialized yet. Refresh the page.', true);
        return;
      }

      const email = $('email').value.trim();
      const password = $('password').value;

      try {
        $('btnLogin').disabled = true;
        $('btnLogin').textContent = 'Signing in‚Ä¶';

        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;

        setMsg('Signed in. Redirecting‚Ä¶');
        // Student dashboard (regular)
        window.location.href = '/dashboard.html';
      } catch (e) {
        setMsg('Login Failed: ' + (e?.message || String(e)), true);
      } finally {
        $('btnLogin').disabled = false;
        $('btnLogin').textContent = 'Log In';
      }
    });

    initSupabase();
  </script>
</body>
</html>