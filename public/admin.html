<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LogicPals Admin Console</title>
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{--bg:#f4f6ff;--card:#fff;--muted:#6b7280;--pri:#4f46e5;--danger:#ef4444;--ok:#10b981;--warn:#f59e0b;}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:radial-gradient(1200px 600px at 20% 10%, #e9e7ff 0%, transparent 60%), var(--bg);}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;background:var(--card);border-radius:18px;padding:14px 16px;box-shadow:0 10px 30px rgba(0,0,0,.06);}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#6d28d9,#4f46e5);display:grid;place-items:center;color:#fff;font-weight:800}
    .brand h1{font-size:16px;margin:0}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:12px}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{font-size:12px;color:var(--muted);border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;background:#fff;display:flex;align-items:center;gap:8px}
    .dot{width:8px;height:8px;border-radius:50%}
    .btn{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--pri);border-color:var(--pri);color:#fff}
    .btn.danger{border-color:#fecaca;background:#fff;color:var(--danger)}
    .grid{margin-top:16px;display:grid;grid-template-columns: 380px 1fr; gap:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);}
    .card h2{margin:0 0 4px;font-size:16px}
    .card p{margin:0;color:var(--muted);font-size:12px}
    .kv{margin-top:14px;border-top:1px solid #eef2ff;padding-top:12px;display:grid;grid-template-columns: 120px 1fr; row-gap:8px; column-gap:10px; font-size:13px}
    .kv .k{color:var(--muted)}
    .banner{margin-top:12px;border-radius:14px;padding:12px 12px;border:1px solid #e5e7eb;background:#f9fafb;font-size:13px}
    .banner.ok{border-color:#bbf7d0;background:#f0fdf4}
    .banner.warn{border-color:#fde68a;background:#fffbeb}
    .banner.bad{border-color:#fecaca;background:#fef2f2}
    .tabs{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:700;font-size:13px;cursor:pointer}
    .tab.active{border-color:#c7d2fe;background:#eef2ff;color:#3730a3}
    .panel{margin-top:12px}
    .row{display:grid;grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 980px){.row{grid-template-columns:1fr}}
    .tile{border:1px solid #e5e7eb;border-radius:16px;padding:14px;background:#fff}
    .tile h3{margin:0 0 6px;font-size:14px}
    .tile p{margin:0 0 10px;font-size:12px;color:var(--muted)}
    .tile .btn{padding:7px 10px;font-size:13px}
    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(17,24,39,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal{background:#fff;border-radius:18px;max-width:520px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:16px}
    .modal h3{margin:0 0 8px}
    .modal .x{float:right;border:1px solid #e5e7eb;background:#fff;border-radius:999px;width:34px;height:34px;cursor:pointer}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .field label{font-size:12px;color:var(--muted)}
    .field input{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-size:14px}
    .small{font-size:12px;color:var(--muted)}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}
  </style>
  <!-- Robust UMD build (no module import; avoids esm.sh flakiness) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">LP</div>
        <div>
          <h1>LogicPals Console</h1>
          <p>Enterprise Admin System</p>
        </div>
      </div>
      <div class="actions">
        <div id="bootPill" class="pill"><span class="dot" id="bootDot" style="background:#9ca3af"></span><span id="bootText">Loading…</span></div>
        <button class="btn" id="btnVisit">Visit Site</button>
        <button class="btn" id="btnDash">Dashboard</button>
        <button class="btn primary" id="btnSignIn">Sign in</button>
        <button class="btn danger" id="btnSignOut" style="display:none">Sign out</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Console Status</h2>
        <p>Access controlled via DB roles + RPC gates (Step 7)</p>

        <div class="kv" aria-label="status key-values">
          <div class="k">Project</div><div id="sProject">LogicPals-App</div>
          <div class="k">Auth state</div><div id="sAuth">unknown</div>
          <div class="k">Role</div><div id="sRole">unknown</div>
          <div class="k">User</div><div id="sUser">—</div>
        </div>

        <div id="bannerAuth" class="banner warn">
          Sign in to load admin capabilities. If your role is <b>super_admin</b>, you can assign roles and manage monetization.
        </div>
        <div class="banner ok">
          <b>Roadmap contract:</b> Admin UI never directly writes protected tables. All mutations go through RPC + audit events.
        </div>
        <div id="bannerBoot" class="banner bad" style="display:none"></div>
      </div>

      <div class="card">
        <h2>Admin Workspace</h2>
        <p>Clean controls with hard boundaries for Regular vs Olympiad</p>

        <div class="tabs" role="tablist">
          <button class="tab active" data-tab="overview">Overview</button>
          <button class="tab" data-tab="content">Content</button>
          <button class="tab" data-tab="monetization">Monetization</button>
          <button class="tab" data-tab="access">Access</button>
        </div>

        <div class="panel" id="panel">
          <div class="banner ok"><b>Step 7 readiness:</b> Explainability events + receipts are working. Next: surface trustworthy admin views + immutable audit.</div>

          <div class="row" style="margin-top:12px">
            <div class="tile">
              <h3>Regular Review</h3>
              <p>Content management for standard curriculum (admin_regular, super_admin).</p>
              <button class="btn" id="btnRegularSeed">Upload / Seed</button>
              <button class="btn" id="btnRegularQueue">Review Queue</button>
            </div>
            <div class="tile">
              <h3>Olympiad Review</h3>
              <p>Competition prep (admin_olympiad, super_admin). Strict separation.</p>
              <button class="btn" id="btnOlympSeed">Upload / Seed</button>
              <button class="btn" id="btnOlympQueue">Failed Criteria Queue</button>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="tile">
              <h3>Role Management</h3>
              <p>Assign admin roles (super_admin only). Uses RPC + RLS. Audit required.</p>
              <button class="btn" id="btnRoleMgr">Open Role Manager</button>
              <button class="btn" id="btnAudit">View Admin Audit</button>
            </div>
            <div class="tile">
              <h3>Monetization</h3>
              <p>Payments + subscriptions (manual activation / refunds). RPC-only with receipts.</p>
              <button class="btn" id="btnPayments">Payments</button>
              <button class="btn" id="btnSubs">Subscriptions</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sign-in Modal -->
  <div class="backdrop" id="authBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Admin sign in">
      <button class="x" id="authClose">✕</button>
      <h3>LogicPals Admin Account</h3>
      <div class="small">Admin console is email + password only.</div>

      <div class="field">
        <label>Email</label>
        <input id="email" type="email" placeholder="admin@email.com" autocomplete="username" />
      </div>
      <div class="field">
        <label>Password</label>
        <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
      </div>

      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px">
        <button class="btn primary" id="authDoSignIn">Sign in</button>
        <button class="btn danger" id="authDoSignOut">Sign out</button>
        <span class="small" id="authHint"></span>
      </div>

      <div class="banner" style="margin-top:12px">
        <b>Enterprise rule:</b> non-admin accounts are immediately signed out after role verification.
        <div class="small" style="margin-top:6px">Role RPC autodetect tries: <code>get_my_role</code>, <code>admin_get_role</code>, <code>rp_admin_get_role</code>, <code>current_role</code>…</div>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------
    // Enterprise Boot (no shortcuts)
    // ----------------------------
    const UI = {
      bootPill: document.getElementById('bootPill'),
      bootDot: document.getElementById('bootDot'),
      bootText: document.getElementById('bootText'),
      bannerBoot: document.getElementById('bannerBoot'),
      sAuth: document.getElementById('sAuth'),
      sRole: document.getElementById('sRole'),
      sUser: document.getElementById('sUser'),
      btnSignIn: document.getElementById('btnSignIn'),
      btnSignOut: document.getElementById('btnSignOut'),
      backdrop: document.getElementById('authBackdrop'),
      authClose: document.getElementById('authClose'),
      authDoSignIn: document.getElementById('authDoSignIn'),
      authDoSignOut: document.getElementById('authDoSignOut'),
      authHint: document.getElementById('authHint'),
      email: document.getElementById('email'),
      password: document.getElementById('password'),
    };

    const CFG = {
      envEndpoint: '/api/env',
      adminHome: '/admin.html',
      allowedRoles: new Set(['super_admin','admin_regular','admin_olympiad']),
      roleRpcCandidates: [
        'get_my_role',
        'admin_get_role',
        'rp_admin_get_role',
        'current_role',
        'rp_current_role',
        'get_user_role'
      ],
      // cache key for autodetected role rpc
      roleRpcCacheKey: 'lp_role_rpc_v1'
    };

    function setBoot(state, text, color){
      UI.bootText.textContent = text;
      UI.bootDot.style.background = color;
      if(state === 'error'){
        UI.bootPill.style.borderColor = '#fecaca';
        UI.bootPill.style.background = '#fef2f2';
      } else if(state === 'ok'){
        UI.bootPill.style.borderColor = '#bbf7d0';
        UI.bootPill.style.background = '#f0fdf4';
      } else {
        UI.bootPill.style.borderColor = '#e5e7eb';
        UI.bootPill.style.background = '#fff';
      }
    }
    function showBootError(msg){
      UI.bannerBoot.style.display = 'block';
      UI.bannerBoot.textContent = msg;
      setBoot('error','Boot error', '#ef4444');
    }

    function openAuth(){ UI.backdrop.style.display='flex'; UI.backdrop.setAttribute('aria-hidden','false'); }
    function closeAuth(){ UI.backdrop.style.display='none'; UI.backdrop.setAttribute('aria-hidden','true'); UI.authHint.textContent=''; }

    UI.btnSignIn.addEventListener('click', openAuth);
    UI.authClose.addEventListener('click', closeAuth);
    UI.backdrop.addEventListener('click', (e)=>{ if(e.target===UI.backdrop) closeAuth(); });

    document.getElementById('btnVisit').addEventListener('click', ()=> location.href = '/');
    document.getElementById('btnDash').addEventListener('click', ()=> location.href = '/dashboard.html');
    document.getElementById('btnPayments').addEventListener('click', ()=> location.href = '/admin/admin-payments.html');
    document.getElementById('btnSubs').addEventListener('click', ()=> location.href = '/admin/admin-subscriptions.html');

    let sb = null;
    let env = null;

    function assertSupabaseLoaded(){
      if(!window.supabase || typeof window.supabase.createClient !== 'function'){
        const err = new Error('supabase_js_missing');
        err.code = 'supabase_js_missing';
        throw err;
      }
    }

    async function fetchEnv(){
      const r = await fetch(CFG.envEndpoint, { cache: 'no-store' });
      if(!r.ok){
        const t = await r.text().catch(()=> '');
        const err = new Error('env_fetch_failed: ' + r.status + ' ' + t);
        err.code = 'env_fetch_failed';
        throw err;
      }
      const j = await r.json();
      const url = j?.SUPABASE_URL || j?.supabaseUrl || j?.url;
      const key = j?.SUPABASE_ANON_KEY || j?.anonKey || j?.key;
      if(!url || !key){
        const err = new Error('env_missing_SUPABASE_URL_or_ANON_KEY');
        err.code = 'env_missing';
        throw err;
      }
      return { url, key };
    }

    function createClient(url, key){
      assertSupabaseLoaded();
      return window.supabase.createClient(url, key, {
        auth: { persistSession: true, autoRefreshToken: false, detectSessionInUrl: false, storageKey: 'lp_admin_auth', storage: window.sessionStorage },
        global: { headers: { 'X-Client-Info': 'logicpals-admin-console' } }
      });
    }

    function setSignedOutUI(){
      UI.sAuth.textContent = 'signed_out';
      UI.sRole.textContent = 'no_role';
      UI.sUser.textContent = '—';
      UI.btnSignOut.style.display = 'none';
      UI.btnSignIn.style.display = 'inline-block';
    }

    function setSignedInUI(email, role){
      UI.sAuth.textContent = 'authenticated';
      UI.sUser.textContent = email || '—';
      UI.sRole.textContent = role || 'unknown';
      UI.btnSignOut.style.display = 'inline-block';
      UI.btnSignIn.style.display = 'none';
    }

    async function safeSignOut(){
      try{
        if(sb) await sb.auth.signOut();
      }catch(e){ /* ignore */ }
      setSignedOutUI();
    }

    async function callRoleRpc(){
      // Use cached rpc name first
      const cached = localStorage.getItem(CFG.roleRpcCacheKey);
      const candidates = cached ? [cached, ...CFG.roleRpcCandidates.filter(x=>x!==cached)] : [...CFG.roleRpcCandidates];

      let lastErr = null;
      for(const name of candidates){
        try{
          const { data, error } = await sb.rpc(name, {});
          if(error){
            lastErr = error;
            // function missing / not found errors should continue to probe
            const msg = (error.message || '').toLowerCase();
            if(msg.includes('function') && msg.includes('not found')) continue;
            if(msg.includes('could not find the function')) continue;
            // If it exists but fails due to auth, bubble up.
            throw error;
          }
          // Normalize role output
          let role = null;
          if(typeof data === 'string') role = data;
          else if(data && typeof data === 'object'){
            role = data.role || data.current_role || data.name || null;
          }
          if(role){
            localStorage.setItem(CFG.roleRpcCacheKey, name);
            return String(role);
          }
          // If returns null/empty, treat as no_role (but rpc exists)
          localStorage.setItem(CFG.roleRpcCacheKey, name);
          return 'no_role';
        }catch(e){
          lastErr = e;
          // Continue probing if looks like missing function
          const msg = String(e?.message || e || '').toLowerCase();
          if(msg.includes('not found') || msg.includes('could not find the function') || msg.includes('pgrst202')) continue;
        }
      }
      // If all fail, return special value + keep error for UI
      const err = new Error('role_rpc_missing_or_failed');
      err.detail = lastErr;
      throw err;
    }

    async function verifyAdminOrSignOut(){
      const { data: { user } } = await sb.auth.getUser();
      if(!user){
        setSignedOutUI();
        return { ok:false, reason:'no_session' };
      }
      let role = 'unknown';
      try{
        role = await callRoleRpc();
      }catch(e){
        // If role rpc missing, lock UI and sign out (safer)
        await safeSignOut();
        showBootError('Access verification failed: role RPC not available. Create a role RPC (e.g., get_my_role) or ensure it is exposed.');
        return { ok:false, reason:'role_rpc_missing' };
      }

      const email = user.email || '';
      setSignedInUI(email, role);

      if(!CFG.allowedRoles.has(role)){
        // CRITICAL: Non-admin sessions get terminated immediately
        await safeSignOut();
        UI.authHint.textContent = 'Not authorized for admin. Signed out.';
        return { ok:false, reason:'not_admin', role };
      }
      return { ok:true, role, email };
    }

    async function bootstrap(){
      setBoot('loading','Loading…', '#9ca3af');
      try{
        env = await fetchEnv();
        sb = createClient(env.url, env.key);

        // Wire sign-out
        UI.btnSignOut.addEventListener('click', async ()=>{
          setBoot('loading','Signing out…', '#f59e0b');
          await safeSignOut();
          setBoot('ok','Ready', '#10b981');
        });
        UI.authDoSignOut.addEventListener('click', async ()=>{
          UI.authHint.textContent = 'Signing out…';
          await safeSignOut();
          UI.authHint.textContent = 'Signed out.';
        });

        UI.authDoSignIn.addEventListener('click', async ()=>{
          UI.authHint.textContent = '';
          const email = (UI.email.value || '').trim();
          const password = UI.password.value || '';
          if(!email || !password){
            UI.authHint.textContent = 'Enter email + password.';
            return;
          }
          setBoot('loading','Signing in…', '#f59e0b');
          UI.authHint.textContent = 'Signing in…';
          const { error } = await sb.auth.signInWithPassword({ email, password });
          if(error){
            UI.authHint.textContent = 'Login failed: ' + (error.message || 'unknown error');
            showBootError('Login failed.');
            return;
          }
          // verify role gate
          const verdict = await verifyAdminOrSignOut();
          if(!verdict.ok){
            UI.authHint.textContent = verdict.reason === 'not_admin'
              ? 'Not an admin. Session terminated.'
              : 'Access verification failed.';
            return;
          }
          closeAuth();
          setBoot('ok','Ready', '#10b981');
        });

        // React to auth state changes
        sb.auth.onAuthStateChange(async (_event, _session)=>{
          await verifyAdminOrSignOut();
        });

        // Initial verify
        const verdict = await verifyAdminOrSignOut();
        if(!verdict.ok){
          setBoot('ok','Ready', '#10b981'); // page is usable for sign-in even if signed out
        } else {
          setBoot('ok','Ready', '#10b981');
        }
      }catch(e){
        const msg = String(e?.message || e);
        if(msg.includes('supabase_js_missing')){
          showBootError('Supabase JS failed to load. Check if your network blocks cdn.jsdelivr.net, then retry.');
        } else if(msg.includes('env_fetch_failed')){
          showBootError('Failed to load /api/env. Verify Vercel function is deployed and returns SUPABASE_URL + SUPABASE_ANON_KEY.');
        } else if(msg.includes('env_missing')){
          showBootError('Missing SUPABASE_URL / SUPABASE_ANON_KEY from /api/env response.');
        } else {
          showBootError('Boot failure: ' + msg);
        }
        console.error(e);
        setSignedOutUI();
      }
    }

    // Tabs (UI-only)
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
      });
    });

    // Start
    bootstrap();
  </script>
</body>
</html>
