<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LogicPals Admin Console</title>

  <!-- Loads window.__LP_ENV via Vercel route -->
<!-- BFCache/Back button hardening: always revalidate -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --primary:#4f46e5; --primary-weak:#eef2ff;
      --success:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --shadow:0 18px 45px rgba(15,23,42,.08);
      --radius:18px; --radius-sm:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:radial-gradient(900px 600px at 18% 12%, rgba(79,70,229,.10), transparent 60%),
                 radial-gradient(900px 600px at 82% 20%, rgba(16,185,129,.08), transparent 60%),
                 var(--bg);
    }
    .shell{max-width:1180px;margin:22px auto;padding:0 18px;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:16px 18px;background:rgba(255,255,255,.9);border:1px solid var(--line);
      border-radius:22px;box-shadow:var(--shadow);backdrop-filter:saturate(140%) blur(12px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:240px;}
    .logo{
      width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,#6366f1,#8b5cf6);
      display:grid;place-items:center;color:#fff;font-weight:800;letter-spacing:.5px;
      box-shadow:0 14px 28px rgba(79,70,229,.25);
    }
    .brand h1{margin:0;font-size:15px;line-height:1.15}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:12px}

    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border:1px solid var(--line);border-radius:999px;
      background:#fff;color:var(--muted);font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:#cbd5e1;}
    .dot.ok{background:var(--success)}
    .dot.warn{background:var(--warn)}

    .btn{
      border:1px solid var(--line);background:#fff;color:var(--text);
      padding:10px 14px;border-radius:999px;font-weight:700;font-size:13px;cursor:pointer;
      transition:transform .06s ease, box-shadow .12s ease, background .12s ease, opacity .12s ease;
    }
    .btn:hover{box-shadow:0 10px 22px rgba(15,23,42,.08)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{box-shadow:0 14px 26px rgba(79,70,229,.22)}
    .btn.ghost{background:transparent}
    .btn[disabled]{opacity:.45;cursor:not-allowed;box-shadow:none}
    .btn.danger{border-color:rgba(239,68,68,.30); color:#991b1b; background:rgba(239,68,68,.06)}
    .btn.danger:hover{box-shadow:0 10px 22px rgba(239,68,68,.12)}

    .grid{display:grid;grid-template-columns:360px 1fr;gap:16px;margin-top:16px;}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);}
    .card .hd{padding:18px 18px 12px;border-bottom:1px solid var(--line);}
    .card .hd h2{margin:0;font-size:16px}
    .card .hd small{color:var(--muted)}
    .card .bd{padding:16px 18px;}
    .kv{display:grid;grid-template-columns:120px 1fr;row-gap:10px;column-gap:12px;margin-top:10px;font-size:13px}
    .k{color:var(--muted)}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0;}
    .tab{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700;font-size:13px}
    .tab.active{background:var(--primary-weak);border-color:rgba(79,70,229,.30);color:#1e1b4b}
    .panel{display:none}
    .panel.active{display:block}

    .banner{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px 14px;border-radius:14px;border:1px solid rgba(16,185,129,.25);
      background:rgba(16,185,129,.08);color:#064e3b;font-size:13px;
    }
    .banner.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#7c2d12}
    .banner.danger{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10);color:#7f1d1d}

    .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin-top:14px;}
    @media (max-width: 980px){.cards{grid-template-columns:1fr}}
    .mini{border:1px solid var(--line);border-radius:var(--radius-sm);background:#fff;padding:14px;}
    .mini h3{margin:0 0 6px;font-size:14px}
    .mini p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
    .mini .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    dialog{
      width:min(520px, calc(100% - 24px));
      border:none;border-radius:18px;box-shadow:0 30px 80px rgba(2,6,23,.35);
      padding:0;overflow:hidden;
    }
    dialog::backdrop{background:rgba(2,6,23,.45)}
    .modal-hd{padding:16px 18px;border-bottom:1px solid var(--line);background:#fff;display:flex;align-items:center;justify-content:space-between}
    .modal-hd strong{font-size:14px}
    .modal-bd{padding:16px 18px;background:#fff}
    .field{display:grid;gap:6px;margin:10px 0}
    .field label{font-size:12px;color:var(--muted)}
    .input{
      padding:12px 12px;border-radius:12px;border:1px solid var(--line);
      background:#fff;font-size:14px;outline:none;
    }
    .input:focus{border-color:rgba(79,70,229,.55);box-shadow:0 0 0 4px rgba(79,70,229,.10)}
    .help{color:var(--muted);font-size:12px;line-height:1.35}
    .out{margin-top:12px;padding:12px;border-radius:12px;border:1px dashed var(--line);background:#fafafa;color:#0f172a;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;min-height:56px}

    .gate-overlay{
      display:none;
      position:absolute; inset:0;
      background:rgba(246,247,251,.78);
      backdrop-filter: blur(6px);
      border-radius: var(--radius);
      border:1px dashed rgba(100,116,139,.35);
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .gate-overlay.active{display:flex}
    .gate-box{
      max-width:520px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:0 24px 60px rgba(2,6,23,.20);
      padding:16px 16px 14px;
    }
    .gate-box h3{margin:0 0 6px;font-size:14px}
    .gate-box p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
    .gate-box .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

/* === Enterprise auth UI states (injected) === */
.pill.is-ready, .chip.is-ready { border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.08); }
.pill.is-loading, .chip.is-loading { border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.08); }
.pill.is-error, .chip.is-error { border-color: rgba(225,29,72,.35); background: rgba(225,29,72,.08); }
.dot.err, .statusDot.err { background: #e11d48 !important; }
#loginMsg.msgErr { color: #e11d48; }
#loginMsg.msgOk { color: #16a34a; }
#loginMsg.msgInfo { color: #64748b; }
/* DOM warning cleanup (not required, but nicer) */
dialog form { margin: 0; }
</style>
  <script src="/assets/js/env-loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="shell">
    <header class="topbar">
      <div class="brand">
        <div class="logo">LP</div>
        <div>
          <h1>LogicPals Console</h1>
          <p>Enterprise Admin System</p>
        </div>
      </div>

      <div class="actions">
        <div class="pill" id="statusPill"><span class="dot" id="statusDot"></span><span id="statusText">Loading…</span></div>
        <button class="btn" id="btnVisit" type="button">Visit Site</button>
        <button class="btn" id="btnDashboard" type="button">Dashboard</button>
        <button class="btn danger" id="btnTopLogout" type="button" style="display:none">Sign out</button>
        <button class="btn primary" id="btnAuth" type="button">Sign in</button>
      </div>
    </header>

    <div class="grid">
      <aside class="card">
        <div class="hd">
          <h2>Console Status</h2>
          <small>Access controlled via DB roles + RPC gates (Step 7)</small>
        </div>
        <div class="bd">
          <div class="kv">
            <div class="k">Project</div><div>LogicPals-App</div>
            <div class="k">Auth state</div><div id="kvAuth">unknown</div>
            <div class="k">Role</div><div id="kvRole">unknown</div>
            <div class="k">User</div><div id="kvUser">—</div>
          </div>

          <div class="banner warn" style="margin-top:14px" id="roleHint">
            <div>Sign in to load admin capabilities. If your role is <b>super_admin</b>, you can assign roles and manage monetization.</div>
          </div>

          <div class="banner" style="margin-top:12px">
            <div><b>Roadmap contract:</b> Admin UI never directly writes protected tables. All mutations go through <b>RPC</b> + <b>audit events</b>.</div>
          </div>

          <div class="banner danger" style="margin-top:12px; display:none" id="logoutWarn">
            <div><b>Security:</b> You are signed out. Admin workspace is locked until you sign in again.</div>
          </div>
        </div>
      </aside>

      <main class="card" id="workspaceCard" style="position:relative">
        <div class="hd">
          <h2>Admin Workspace</h2>
          <small>Clean controls with hard boundaries for Regular vs Olympiad</small>
          <div class="tabs" style="margin-top:12px">
            <button class="tab active" data-tab="overview" type="button">Overview</button>
            <button class="tab" data-tab="content" type="button">Content</button>
            <button class="tab" data-tab="monetization" type="button">Monetization</button>
            <button class="tab" data-tab="access" type="button">Access</button>
          </div>
        </div>

        <div class="bd" id="workspaceBody">
          <section class="panel active" id="tab-overview">
            <div class="banner" style="margin-bottom:14px">
              <div><b>Step 7 readiness:</b> Explainability events + receipts are working. Next: surface trustworthy admin views + immutable audit.</div>
            </div>
            <div class="cards">
              <div class="mini">
                <h3>Regular Review</h3>
                <p>Content management for standard curriculum (admin_regular, super_admin).</p>
                <div class="row">
                  <button class="btn gated" id="btnRegUpload" type="button">Upload / Seed</button>
                  <button class="btn gated" id="btnRegQueue" type="button">Review Queue</button>
                </div>
              </div>
              <div class="mini">
                <h3>Olympiad Review</h3>
                <p>Competition prep (admin_olympiad, super_admin). Strict separation + no hints in mock mode.</p>
                <div class="row">
                  <button class="btn gated" id="btnOlyUpload" type="button">Upload / Seed</button>
                  <button class="btn gated" id="btnOlyQueue" type="button">Failed Criteria Queue</button>
                </div>
              </div>
              <div class="mini">
                <h3>Role Management</h3>
                <p>Assign admin roles (super_admin only). Uses RPC + RLS. Audit required.</p>
                <div class="row">
                  <button class="btn gated" id="btnRoles" type="button">Open Role Manager</button>
                  <button class="btn gated" id="btnAudit" type="button">View Admin Audit</button>
                </div>
              </div>
              <div class="mini">
                <h3>Monetization</h3>
                <p>Payments + subscriptions (manual activation / refunds). RPC-only with receipts.</p>
                <div class="row">
                  <button class="btn gated" id="btnPayments" type="button">Payments</button>
                  <button class="btn gated" id="btnSubs" type="button">Subscriptions</button>
                </div>
              </div>
            </div>
          </section>

          <section class="panel" id="tab-content">
            <div class="banner warn" style="margin-bottom:14px">
              <div><b>Note:</b> UI is ready. We will enable actions after admin RPCs are confirmed (Step 7).</div>
            </div>
            <div class="cards">
              <div class="mini">
                <h3>Regular Problem Upload</h3>
                <p>Upload/seed problems via RPC. No direct inserts.</p>
                <div class="row"><button class="btn gated" id="goRegUpload" type="button">Open</button></div>
              </div>
              <div class="mini">
                <h3>Olympiad Problem Upload</h3>
                <p>Upload/seed problems via RPC. Strict criteria enforced.</p>
                <div class="row"><button class="btn gated" id="goOlyUpload" type="button">Open</button></div>
              </div>
              <div class="mini">
                <h3>Olympiad Failed Criteria Review</h3>
                <p>Review problems that failed gate scoring + explainability.</p>
                <div class="row"><button class="btn gated" id="goOlyReview" type="button">Open</button></div>
              </div>
              <div class="mini">
                <h3>Audit Timeline</h3>
                <p>Immutable admin actions: who changed what, when, and why.</p>
                <div class="row"><button class="btn gated" id="goAudit" type="button">Open</button></div>
              </div>
            </div>
          </section>

          <section class="panel" id="tab-monetization">
            <div class="cards">
              <div class="mini">
                <h3>Payments</h3>
                <p>Refund / charge / reconcile. Admin-only endpoints.</p>
                <div class="row"><button class="btn gated" id="goPayments" type="button">Open Payments</button></div>
              </div>
              <div class="mini">
                <h3>Subscriptions</h3>
                <p>List / extend / cancel. Admin-only endpoints.</p>
                <div class="row"><button class="btn gated" id="goSubs" type="button">Open Subscriptions</button></div>
              </div>
              <div class="mini">
                <h3>Trust Summary</h3>
                <p>Receipts, eligibility, explainability, warnings.</p>
                <div class="row"><button class="btn gated" id="goTrust" type="button">Open Trust Summary</button></div>
              </div>
              <div class="mini">
                <h3>Pricing Config</h3>
                <p>Future: tier catalog + promotions (gated by Step 8 A/B testing).</p>
                <div class="row"><button class="btn" disabled type="button">Coming soon</button></div>
              </div>
            </div>
          </section>

          <section class="panel" id="tab-access">
            <div class="banner warn" style="margin-bottom:14px">
              <div><b>Role assignment</b> must be <b>super_admin</b> only. If not super_admin, this section stays read-only.</div>
            </div>
            <div class="mini">
              <h3>Access & Roles</h3>
              <p>We will wire these to Step 7 RPCs once you confirm your function names.</p>
              <div class="row">
                <button class="btn gated" id="openRoleManager" type="button">Open Role Manager</button>
                <button class="btn gated" id="openAdminAudit" type="button">View Admin Audit</button>
              </div>
              <div class="out" id="accessOut">Waiting…</div>
            </div>
          </section>
        </div>

        <div class="gate-overlay" id="gateOverlay" aria-live="polite">
          <div class="gate-box">
            <h3>Admin workspace locked</h3>
            <p>You are signed out. For security, all admin actions and navigation are disabled until you sign in again.</p>
            <div class="row">
              <button class="btn primary" id="btnGateSignIn" type="button">Sign in</button>
              <button class="btn" id="btnGateReload" type="button">Reload</button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <dialog id="dlgLogin">
    <div class="modal-hd">
      <strong>LogicPals Admin Account</strong>
      <button class="btn ghost" id="btnCloseDlg" type="button">✕</button>
    </div>
    <div class="modal-bd">
      <div class="field">
        <label for="email">Email</label>
        <input class="input" id="email" type="email" placeholder="admin@example.com" autocomplete="email" />
      </div>
      <div class="field">
        <label for="password">Password</label>
        <input class="input" id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
      </div>
      <div class="help">Admin console is email + password only.</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <button class="btn primary" id="btnDoLogin" type="button">Sign in</button>
        <button class="btn danger" id="btnDoLogout" type="button" style="display:none">Sign out</button>
      </div>
      <div class="out" id="authOut">Waiting…</div>
    </div>
  </dialog>

  <script>
(() => {
  'use strict';

  const ADMIN_ALLOWED = new Set(['super_admin','admin','admin_regular','admin_olympiad']);
  const ROLE_RPC_CANDIDATES = [
    'get_my_role',
    'rpc_lp_my_role',
    'admin_get_my_role',
    'admin_get_role',
    'rp_admin_get_role',
    'current_role'
  ];

  const AUTH_STORAGE_KEY = 'lp_admin_auth_v1';
  const $ = (id) => document.getElementById(id);

  const elPill = $('statusPill');
  const elDot = $('statusDot');
  const elPillText = $('statusPillText');

  const elAuth = $('kvAuth');
  const elRole = $('kvRole');
  const elUser = $('kvUser');

  const btnAccount = $('btnAuth');
  const btnTopLogout = $('btnTopLogout');

  const elGate = $('gateLocked');
  const btnGateSignIn = $('btnGateSignIn');
  const btnGateReload = $('btnGateReload');

  const dlg = $('dlg');
  const btnClose = $('btnCloseDlg');
  const inEmail = $('inEmail');
  const inPass = $('inPass');
  const btnDoLogin = $('btnDoLogin');
  const btnDoLogout = $('btnDoLogout');
  const elLoginMsg = $('loginMsg');

  const btnUploadSeed = $('btnUploadSeed');
  const btnReviewQueue = $('btnReviewQueue');
  const btnRoleMgr = $('btnRoleManager');
  const btnAudit = $('btnAuditViewer');
  const btnPayments = $('btnPayments');
  const btnSubs = $('btnSubscriptions');

  let supa = null;
  let env = null;

  function setChip(state, text) {
    // state: 'ready' | 'loading' | 'error'
    elPill?.classList.remove('is-ready','is-loading','is-error');
    elDot?.classList.remove('ok','warn','err');
    if (state === 'ready') {
      elPill?.classList.add('is-ready');
      elDot?.classList.add('ok');
    } else if (state === 'error') {
      elPill?.classList.add('is-error');
      elDot?.classList.add('err');
    } else {
      elPill?.classList.add('is-loading');
      elDot?.classList.add('warn');
    }
    if (elPillText) elPillText.textContent = text;
  }

  function setKV(authState, role, userEmail) {
    if (elAuth) elAuth.textContent = authState || 'unknown';
    if (elRole) elRole.textContent = role || 'unknown';
    if (elUser) elUser.textContent = userEmail || '—';
  }

  function showModal(open) {
    if (!dlg) return;
    if (open) dlg.showModal();
    else dlg.close();
  }

  function setModalMessage(msg, kind='info') {
    if (!elLoginMsg) return;
    elLoginMsg.textContent = msg || '';
    elLoginMsg.classList.remove('msgErr','msgOk','msgInfo');
    if (kind === 'err') elLoginMsg.classList.add('msgErr');
    else if (kind === 'ok') elLoginMsg.classList.add('msgOk');
    else elLoginMsg.classList.add('msgInfo');
  }

  function setWorkspaceEnabled(isAdmin) {
    const disable = !isAdmin;
    [btnUploadSeed, btnReviewQueue, btnRoleMgr, btnAudit, btnPayments, btnSubs].forEach((b) => {
      if (b) b.disabled = disable;
    });
    if (elGate) elGate.style.display = isAdmin ? 'none' : 'block';
  }

  async function fetchEnv() {
    const res = await fetch('/api/env', { cache: 'no-store' });
    if (!res.ok) throw new Error(`env_fetch_failed_${res.status}`);
    const j = await res.json();
    const url = j.supabase_url || j.SUPABASE_URL || j.NEXT_PUBLIC_SUPABASE_URL;
    const anon = j.supabase_anon_key || j.SUPABASE_ANON_KEY || j.NEXT_PUBLIC_SUPABASE_ANON_KEY;
    if (!url || !anon) throw new Error('env_missing_supabase');
    return { url, anon };
  }

  function createSupabaseClient() {
    if (!window.supabase || !window.supabase.createClient) throw new Error('supabase_js_missing');
    if (!env) throw new Error('env_not_loaded');
    if (supa) return supa;
    supa = window.supabase.createClient(env.url, env.anon, {
      auth: {
        storageKey: AUTH_STORAGE_KEY,
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: false,
        lock: false,
      },
      global: { headers: { 'X-Client-Info': 'logicpals-admin-static' } }
    });
    return supa;
  }

  async function rpcTryGetRole() {
    for (const fn of ROLE_RPC_CANDIDATES) {
      try {
        const { data, error } = await supa.rpc(fn, {});
        if (error) continue;
        if (typeof data === 'string') return data;
        if (data && typeof data === 'object') {
          if (typeof data.role === 'string') return data.role;
          if (typeof data.current_role === 'string') return data.current_role;
        }
      } catch (_) {}
    }
    return null;
  }

  async function verifyAdminOrKick() {
    const { data: { session } } = await supa.auth.getSession();
    if (!session) {
      setKV('signed_out', 'no_role', null);
      setChip('loading', 'Signed out');
      setWorkspaceEnabled(false);
      btnDoLogout && (btnDoLogout.style.display = 'none');
      showModal(true); // restore previous behavior: prompt login immediately
      return { isAdmin: false, role: null };
    }

    const email = session.user?.email || null;
    let role = await rpcTryGetRole();

    if (!role) {
      setKV('authenticated', 'unknown', email);
      setChip('error', 'Role RPC missing');
      setWorkspaceEnabled(false);
      btnDoLogout && (btnDoLogout.style.display = 'inline-flex');
      setModalMessage('Signed in, but role verification RPC is missing. Create public.get_my_role() then reload.', 'err');
      showModal(true);
      return { isAdmin: false, role: null };
    }

    role = String(role);
    const isAdmin = ADMIN_ALLOWED.has(role);
    setKV('authenticated', role, email);

    if (!isAdmin) {
      setChip('error', 'Not authorized');
      setWorkspaceEnabled(false);
      btnDoLogout && (btnDoLogout.style.display = 'inline-flex');
      setModalMessage(`This account role is "${role}" (not admin). For security you are being signed out.`, 'err');
      try { await supa.auth.signOut(); } catch (_) {}
      setKV('signed_out', 'no_role', null);
      setChip('loading', 'Signed out');
      showModal(true);
      return { isAdmin: false, role };
    }

    setChip('ready', 'Ready');
    setWorkspaceEnabled(true);
    btnDoLogout && (btnDoLogout.style.display = 'inline-flex');
    setModalMessage('', 'info');
    showModal(false);
    return { isAdmin: true, role };
  }

  async function doLogin() {
    setModalMessage('Signing in…', 'info');
    setChip('loading', 'Signing in…');

    const email = (inEmail?.value || '').trim();
    const password = (inPass?.value || '').trim();
    if (!email || !password) {
      setModalMessage('Email + password required.', 'err');
      setChip('error', 'Missing credentials');
      return;
    }

    const { error } = await supa.auth.signInWithPassword({ email, password });
    if (error) {
      setModalMessage(error.message || 'Sign-in failed.', 'err');
      setChip('error', 'Sign-in failed');
      return;
    }

    await verifyAdminOrKick();
  }

  async function doLogout() {
    setModalMessage('Signing out…', 'info');
    setChip('loading', 'Signing out…');
    try { await supa.auth.signOut(); } catch (_) {}
    setKV('signed_out', 'no_role', null);
    setWorkspaceEnabled(false);
    setChip('loading', 'Signed out');
    showModal(true);
  }

  function navTo(path) { window.location.href = path; }

  function wireUi() {
    btnAccount?.addEventListener('click', () => showModal(true));
    btnClose?.addEventListener('click', () => showModal(false));
    btnDoLogin?.addEventListener('click', (e) => { e.preventDefault(); doLogin(); });
    btnDoLogout?.addEventListener('click', (e) => { e.preventDefault(); doLogout(); });
    btnTopLogout?.addEventListener('click', (e) => { e.preventDefault(); doLogout(); });

    btnGateSignIn?.addEventListener('click', () => showModal(true));
    btnGateReload?.addEventListener('click', () => window.location.reload());

    $('btnVisitSite')?.addEventListener('click', () => navTo('/index.html'));
    $('btnDashboard')?.addEventListener('click', () => navTo('/dashboard.html'));

    btnPayments?.addEventListener('click', () => navTo('/admin/admin-payments.html'));
    btnSubs?.addEventListener('click', () => navTo('/admin/admin-subscriptions.html'));

    // Placeholder admin actions (safe)
    btnUploadSeed?.addEventListener('click', () => alert('Upload/Seed: wire to admin RPCs'));
    btnReviewQueue?.addEventListener('click', () => alert('Review Queue: wire to admin RPCs'));
    btnRoleMgr?.addEventListener('click', () => alert('Role Manager: wire to admin RPCs'));
    btnAudit?.addEventListener('click', () => alert('Admin Audit Viewer: wire to audit RPCs'));
  }

  async function boot() {
    try {
      setChip('loading', 'Loading…');
      setKV('unknown', 'unknown', '—');
      setWorkspaceEnabled(false);

      env = await fetchEnv();
      createSupabaseClient();
      wireUi();

      supa.auth.onAuthStateChange(async () => {
        try { await verifyAdminOrKick(); } catch (_) {}
      });

      await verifyAdminOrKick();
    } catch (err) {
      console.error(err);
      setChip('error', 'Boot error');
      setWorkspaceEnabled(false);
      setModalMessage(String(err?.message || err), 'err');
      showModal(true);
    }
  }

  boot();
})();
</script>
</body>
</html>
