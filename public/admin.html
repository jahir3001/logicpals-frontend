<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LogicPals Admin Console</title>

  <!-- BFCache/Back button hardening: always revalidate -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --primary:#2563EB; --primary-weak:#e8efff;
      --success:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --shadow:0 18px 45px rgba(15,23,42,.08);
      --radius:18px; --radius-sm:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:radial-gradient(900px 600px at 18% 12%, rgba(37,99,235,.12), transparent 60%),
                 radial-gradient(900px 600px at 82% 20%, rgba(245,158,11,.10), transparent 60%),
                 var(--bg);
    }
    .shell{max-width:1180px;margin:22px auto;padding:0 18px;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:16px 18px;background:rgba(255,255,255,.9);border:1px solid var(--line);
      border-radius:22px;box-shadow:var(--shadow);backdrop-filter:saturate(140%) blur(12px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:240px;}
    .logo{
      width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,#2563EB,#60A5FA);
      display:grid;place-items:center;color:#fff;font-weight:900;letter-spacing:.5px;
      box-shadow:0 14px 28px rgba(37,99,235,.25);
    }
    .brand h1{margin:0;font-size:15px;line-height:1.15}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:12px}

    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border:1px solid var(--line);border-radius:999px;
      background:#fff;color:var(--muted);font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:#cbd5e1;}
    .dot.ok{background:var(--success)}
    .dot.warn{background:var(--warn)}

    .btn{
      border:1px solid var(--line);background:#fff;color:var(--text);
      padding:10px 14px;border-radius:999px;font-weight:800;font-size:13px;cursor:pointer;
      transition:transform .06s ease, box-shadow .12s ease, background .12s ease, opacity .12s ease;
    }
    .btn:hover{box-shadow:0 10px 22px rgba(15,23,42,.08)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{box-shadow:0 14px 26px rgba(37,99,235,.22)}
    .btn.ghost{background:transparent}
    .btn[disabled]{opacity:.45;cursor:not-allowed;box-shadow:none}
    .btn.danger{border-color:rgba(239,68,68,.30); color:#991b1b; background:rgba(239,68,68,.06)}
    .btn.danger:hover{box-shadow:0 10px 22px rgba(239,68,68,.12)}

    .grid{display:grid;grid-template-columns:360px 1fr;gap:16px;margin-top:16px;}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);}
    .card .hd{padding:18px 18px 12px;border-bottom:1px solid var(--line);}
    .card .hd h2{margin:0;font-size:16px}
    .card .hd small{color:var(--muted)}
    .card .bd{padding:16px 18px;}

    .kv{display:grid;grid-template-columns:120px 1fr;row-gap:10px;column-gap:12px;margin-top:10px;font-size:13px}
    .k{color:var(--muted)}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0;}
    .tab{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:800;font-size:13px}
    .tab.active{background:var(--primary-weak);border-color:rgba(37,99,235,.28);color:#1e3a8a}
    .panel{display:none}
    .panel.active{display:block}

    .banner{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px 14px;border-radius:14px;border:1px solid rgba(16,185,129,.25);
      background:rgba(16,185,129,.08);color:#064e3b;font-size:13px;
    }
    .banner.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#7c2d12}
    .banner.danger{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10);color:#7f1d1d}

    .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin-top:14px;}
    @media (max-width: 980px){.cards{grid-template-columns:1fr}}
    .mini{border:1px solid var(--line);border-radius:var(--radius-sm);background:#fff;padding:14px;}
    .mini h3{margin:0 0 6px;font-size:14px}
    .mini p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
    .mini .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    dialog{
      width:min(520px, calc(100% - 24px));
      border:none;border-radius:18px;box-shadow:0 30px 80px rgba(2,6,23,.35);
      padding:0;overflow:hidden;
    }
    dialog::backdrop{background:rgba(2,6,23,.45)}
    .modal-hd{padding:16px 18px;border-bottom:1px solid var(--line);background:#fff;display:flex;align-items:center;justify-content:space-between}
    .modal-hd strong{font-size:14px}
    .modal-bd{padding:16px 18px;background:#fff}
    .field{display:grid;gap:6px;margin:10px 0}
    .field label{font-size:12px;color:var(--muted)}
    .input{
      padding:12px 12px;border-radius:12px;border:1px solid var(--line);
      background:#fff;font-size:14px;outline:none;
    }
    .input:focus{border-color:rgba(37,99,235,.55);box-shadow:0 0 0 4px rgba(37,99,235,.10)}
    .help{color:var(--muted);font-size:12px;line-height:1.35}
    .out{margin-top:12px;padding:12px;border-radius:12px;border:1px dashed var(--line);background:#fafafa;color:#0f172a;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;min-height:56px}

    .gate-overlay{
      display:none;
      position:absolute; inset:0;
      background:rgba(246,247,251,.78);
      backdrop-filter: blur(6px);
      border-radius: var(--radius);
      border:1px dashed rgba(100,116,139,.35);
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .gate-overlay.active{display:flex}
    .gate-box{
      max-width:520px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:0 24px 60px rgba(2,6,23,.20);
      padding:16px 16px 14px;
    }
    .gate-box h3{margin:0 0 6px;font-size:14px}
    .gate-box p{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
    .gate-box .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

    /* Metrics table */
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
    .select{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:700;font-size:13px;}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;overflow:hidden;border:1px solid var(--line);border-radius:14px;background:#fff}
    th,td{padding:10px 12px;font-size:13px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    th{background:#f8fafc;color:#0f172a;font-weight:900}
    tr:last-child td{border-bottom:none}
    .tag{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px;font-weight:800;color:#334155}
    .tag.ok{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.08);color:#064e3b}
    .tag.warn{border-color:rgba(245,158,11,.40);background:rgba(245,158,11,.12);color:#7c2d12}
  </style>
  <script src="/assets/js/env-loader.js"></script>
</head>

<body>
  <div class="shell">
    <header class="topbar">
      <div class="brand">
        <div class="logo">LP</div>
        <div>
          <h1>LogicPals Console</h1>
          <p>Enterprise Admin System</p>
        </div>
      </div>

      <div class="actions">
        <div class="pill" id="statusPill"><span class="dot" id="statusDot"></span><span id="statusText">Loading…</span></div>
        <button class="btn" id="btnVisit" type="button">Visit Site</button>
        <button class="btn" id="btnDashboard" type="button">Dashboard</button>
        <button class="btn danger" id="btnTopLogout" type="button" style="display:none">Sign out</button>
        <button class="btn primary" id="btnAuth" type="button">Sign in</button>
      </div>
    </header>

    <div class="grid">
      <aside class="card">
        <div class="hd">
          <h2>Console Status</h2>
          <small>Access controlled via DB roles + RPC gates (Step 7)</small>
        </div>
        <div class="bd">
          <div class="kv">
            <div class="k">Project</div><div>LogicPals-App</div>
            <div class="k">Auth state</div><div id="kvAuth">unknown</div>
            <div class="k">Role</div><div id="kvRole">unknown</div>
            <div class="k">User</div><div id="kvUser">—</div>
          </div>

          <div class="banner warn" style="margin-top:14px" id="roleHint">
            <div>Sign in to load admin capabilities. If your role is <b>super_admin</b>, you can manage experiments, roles, and monetization.</div>
          </div>

          <div class="banner" style="margin-top:12px">
            <div><b>Roadmap contract:</b> Admin UI never writes protected tables directly. Mutations must go through <b>RPC</b> + <b>audit events</b>.</div>
          </div>

          <div class="banner danger" style="margin-top:12px; display:none" id="logoutWarn">
            <div><b>Security:</b> You are signed out. Admin workspace is locked until you sign in again.</div>
          </div>
        </div>
      </aside>

      <main class="card" id="workspaceCard" style="position:relative">
        <div class="hd">
          <h2>Admin Workspace</h2>
          <small>Strict Regular vs Olympiad separation • A/B metrics are per-track</small>
          <div class="tabs" style="margin-top:12px">
            <button class="tab active" data-tab="overview" type="button">Overview</button>
            <button class="tab" data-tab="ab" type="button">A/B Metrics</button>
            <button class="tab" data-tab="content" type="button">Content</button>
            <button class="tab" data-tab="monetization" type="button">Monetization</button>
            <button class="tab" data-tab="access" type="button">Access</button>
          </div>
        </div>

        <div class="bd" id="workspaceBody">
          <section class="panel active" id="tab-overview">
            <div class="banner" style="margin-bottom:14px">
              <div><b>Status:</b> Steps 1–8 exist. This console provides safe, read-only admin views until each admin mutation has an audit-backed RPC.</div>
            </div>
            <div class="cards">
              <div class="mini">
                <h3>A/B Metrics</h3>
                <p>Verified loop: get-variant → log-metric → aggregation. Next: dashboard hardening + audit alignment.</p>
                <div class="row">
                  <button class="btn gated" id="btnGoAB" type="button">Open A/B Panel</button>
                </div>
              </div>
              <div class="mini">
                <h3>Regular Review</h3>
                <p>Content management for standard curriculum (admin_regular, super_admin).</p>
                <div class="row">
                  <button class="btn gated" id="btnRegUpload" type="button">Upload / Seed</button>
                  <button class="btn gated" id="btnRegQueue" type="button">Review Queue</button>
                </div>
              </div>
              <div class="mini">
                <h3>Olympiad Review</h3>
                <p>Competition prep (admin_olympiad, super_admin). Strict separation.</p>
                <div class="row">
                  <button class="btn gated" id="btnOlyUpload" type="button">Upload / Seed</button>
                  <button class="btn gated" id="btnOlyQueue" type="button">Failed Criteria Queue</button>
                </div>
              </div>
              <div class="mini">
                <h3>Monetization</h3>
                <p>Payments + subscriptions (manual activation / refunds). RPC-only with receipts.</p>
                <div class="row">
                  <button class="btn gated" id="btnPayments" type="button">Payments</button>
                  <button class="btn gated" id="btnSubs" type="button">Subscriptions</button>
                </div>
              </div>
            </div>
          </section>

          <!-- A/B METRICS PANEL (NO external metrics-summary.js needed) -->
          <section class="panel" id="tab-ab">
            <div class="banner" style="margin-bottom:14px">
              <div>
                <b>Enterprise guarantees:</b> Per-track experiments + per-track variants + metric idempotency.
                This panel is <b>read-only</b> and calls your existing Vercel routes under <span class="mono">/api/ab/*</span>.
              </div>
            </div>

            <div class="mini">
              <h3>Experiment selector</h3>
              <p>Select an experiment key and track, then refresh. If the API route names differ, update only the <span class="mono">API</span> constants in this file.</p>

              <div class="controls">
                <span class="tag" id="abAuthTag">Auth: unknown</span>
                <select class="select" id="abTrack">
                  <option value="regular">Regular</option>
                  <option value="olympiad">Olympiad</option>
                  <option value="both">Both</option>
                </select>
                <select class="select" id="abWindow">
                  <option value="7">Last 7 days</option>
                  <option value="30" selected>Last 30 days</option>
                  <option value="0">All-time</option>
                </select>
                <input class="select" id="abKey" style="min-width:280px" placeholder="experiment_key (e.g. reg_home_tutor_hint_v1)" />
                <button class="btn primary gated" id="abRefresh" type="button">Refresh</button>
                <button class="btn gated" id="abLoadKeys" type="button">Load keys</button>
              </div>

              <div class="out" id="abOut">Waiting…</div>
            </div>

            <div class="cards" style="margin-top:14px">
              <div class="mini">
                <h3>Variant performance</h3>
                <p>Exposures vs metric users (conversion) for the chosen window. Per-track only.</p>
                <div id="abTableWrap"></div>
              </div>
              <div class="mini">
                <h3>Event counts</h3>
                <p>Event totals by <span class="mono">event_name</span> for the chosen window.</p>
                <div id="abEventsWrap"></div>
              </div>
            </div>
          </section>

          <section class="panel" id="tab-content">
            <div class="banner warn" style="margin-bottom:14px">
              <div><b>Note:</b> UI is ready. We will enable actions after admin RPCs are confirmed (Step 7).</div>
            </div>
            <div class="cards">
              <div class="mini">
                <h3>Regular Problem Upload</h3>
                <p>Upload/seed problems via RPC. No direct inserts.</p>
                <div class="row"><button class="btn gated" id="goRegUpload" type="button">Open</button></div>
              </div>
              <div class="mini">
                <h3>Olympiad Problem Upload</h3>
                <p>Upload/seed problems via RPC. Strict criteria enforced.</p>
                <div class="row"><button class="btn gated" id="goOlyUpload" type="button">Open</button></div>
              </div>
              <div class="mini">
                <h3>Olympiad Failed Criteria Review</h3>
                <p>Review problems that failed gate scoring + explainability.</p>
                <div class="row"><button class="btn gated" id="goOlyReview" type="button">Open</button></div>
              </div>
              <div class="mini">
                <h3>Audit Timeline</h3>
                <p>Immutable admin actions: who changed what, when, and why.</p>
                <div class="row"><button class="btn gated" id="goAudit" type="button">Open</button></div>
              </div>
            </div>
          </section>

          <section class="panel" id="tab-monetization">
            <div class="cards">
              <div class="mini">
                <h3>Payments</h3>
                <p>Refund / charge / reconcile. Admin-only endpoints.</p>
                <div class="row"><button class="btn gated" id="goPayments" type="button">Open Payments</button></div>
              </div>
              <div class="mini">
                <h3>Subscriptions</h3>
                <p>List / extend / cancel. Admin-only endpoints.</p>
                <div class="row"><button class="btn gated" id="goSubs" type="button">Open Subscriptions</button></div>
              </div>
              <div class="mini">
                <h3>Trust Summary</h3>
                <p>Receipts, eligibility, explainability, warnings.</p>
                <div class="row"><button class="btn gated" id="goTrust" type="button">Open Trust Summary</button></div>
              </div>
              <div class="mini">
                <h3>Pricing Config</h3>
                <p>Future: tier catalog + promotions (gated by Step 8 A/B testing).</p>
                <div class="row"><button class="btn" disabled type="button">Coming soon</button></div>
              </div>
            </div>
          </section>

          <section class="panel" id="tab-access">
            <div class="banner warn" style="margin-bottom:14px">
              <div><b>Role assignment</b> must be <b>super_admin</b> only. If not super_admin, this section stays read-only.</div>
            </div>
            <div class="mini">
              <h3>Access & Roles</h3>
              <p>We will wire these to Step 7 RPCs once you confirm your function names.</p>
              <div class="row">
                <button class="btn gated" id="openRoleManager" type="button">Open Role Manager</button>
                <button class="btn gated" id="openAdminAudit" type="button">View Admin Audit</button>
              </div>
              <div class="out" id="accessOut">Waiting…</div>
            </div>
          </section>
        </div>

        <div class="gate-overlay" id="gateOverlay" aria-live="polite">
          <div class="gate-box">
            <h3>Admin workspace locked</h3>
            <p>You are signed out. For security, all admin actions and navigation are disabled until you sign in again.</p>
            <div class="row">
              <button class="btn primary" id="btnGateSignIn" type="button">Sign in</button>
              <button class="btn" id="btnGateReload" type="button">Reload</button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <dialog id="dlgLogin">
    <div class="modal-hd">
      <strong>LogicPals Admin Account</strong>
      <button class="btn ghost" id="btnCloseDlg" type="button">✕</button>
    </div>
    <div class="modal-bd">
      <div class="field">
        <label for="email">Email</label>
        <input class="input" id="email" type="email" placeholder="admin@example.com" autocomplete="email" />
      </div>
      <div class="field">
        <label for="password">Password</label>
        <input class="input" id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
      </div>
      <div class="help">Admin console is email + password only.</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <button class="btn primary" id="btnDoLogin" type="button">Sign in</button>
        <button class="btn danger" id="btnDoLogout" type="button" style="display:none">Sign out</button>
      </div>
      <div class="out" id="authOut">Waiting…</div>
    </div>
  </dialog>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const $ = (id) => document.getElementById(id);

    // ====== API ROUTES (only edit these if your filenames differ) ======
    const API = {
      env: '/api/env',
      abAdminBundle: '/api/ab/admin-bundle',
      abRefreshDashboard: '/api/ab/refresh-dashboard',
    };

    async function fetchEnv() {
      const r = await fetch(API.env, { method: 'GET' });
      if (!r.ok) throw new Error('env_fetch_failed');
      const j = await r.json();
      const supabaseUrl = j.supabaseUrl || j.SUPABASE_URL || j.url;
      const supabaseAnonKey = j.supabaseAnonKey || j.SUPABASE_ANON_KEY || j.anonKey;
      if (!supabaseUrl || !supabaseAnonKey) throw new Error('missing_supabase_env');
      return { supabaseUrl, supabaseAnonKey };
    }

    const env = await fetchEnv();
    const supabase = createClient(env.supabaseUrl, env.supabaseAnonKey, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });
    window.supabase = supabase;

    const dlg = $('dlgLogin');
    const openDlg = () => dlg.showModal();
    const closeDlg = () => dlg.close();
    $('btnCloseDlg').addEventListener('click', closeDlg);

    const setStatus = (kind, text) => {
      $('statusText').textContent = text;
      $('statusDot').className = 'dot ' + (kind === 'ok' ? 'ok' : kind === 'warn' ? 'warn' : '');
    };

    const setTab = (key) => {
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === key));
      document.querySelectorAll('.panel').forEach(p => p.classList.toggle('active', p.id === `tab-${key}`));
    };
    document.querySelectorAll('.tab').forEach(btn => btn.addEventListener('click', () => setTab(btn.dataset.tab)));

    const gateWorkspace = (locked) => {
      $('gateOverlay').classList.toggle('active', locked);
      $('logoutWarn').style.display = locked ? 'flex' : 'none';
      document.querySelectorAll('.gated').forEach(btn => btn.disabled = locked);
    };

    $('btnGateSignIn').addEventListener('click', () => openDlg());
    $('btnGateReload').addEventListener('click', () => location.reload());

    $('btnVisit').addEventListener('click', () => location.href = '/');
    $('btnDashboard').addEventListener('click', () => location.href = '/dashboard.html');

    $('btnGoAB').addEventListener('click', () => setTab('ab'));

    const guardedNav = (path) => async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { gateWorkspace(true); openDlg(); return; }
      location.href = path;
    };
    $('btnPayments').addEventListener('click', guardedNav('/admin-payments.html'));
    $('btnSubs').addEventListener('click', guardedNav('/admin-subscriptions.html'));
    $('goPayments').addEventListener('click', guardedNav('/admin-payments.html'));
    $('goSubs').addEventListener('click', guardedNav('/admin-subscriptions.html'));
    $('goTrust').addEventListener('click', guardedNav('/admin-subscriptions.html#trust'));

    const notYet = (label) => () => alert(label + "\n\nNext step: confirm / implement the admin RPCs, then we wire these buttons.");
    [
      'btnRegUpload','btnRegQueue','btnOlyUpload','btnOlyQueue',
      'goRegUpload','goOlyUpload','goOlyReview','goAudit','openRoleManager','openAdminAudit'
    ].forEach((id) => $(id)?.addEventListener('click', notYet('This module is UI-ready but RPC wiring is pending.')));

    async function safeGetRole() {
      try {
        const { data, error } = await supabase.rpc('rpc_lp_my_role');
        if (error) throw error;
        return data ?? 'unknown';
      } catch (e) {
        console.error('rpc_lp_my_role failed:', e);
        $('accessOut').textContent = 'Role RPC failed:\n' + (e?.message || String(e));
        return 'unknown';
      }
    }

    function getProjectRefFromUrl(url) {
      try { return new URL(url).hostname.split('.')[0]; } catch { return null; }
    }

    function hardClearAuthStorage() {
      const ref = getProjectRefFromUrl(env.supabaseUrl || env.SUPABASE_URL || env.url);
      const prefixes = ['supabase.auth.','sb-'];
      const rm = (store) => {
        const keys = [];
        for (let i=0; i<store.length; i++) keys.push(store.key(i));
        keys.forEach(k => {
          if (!k) return;
          const ok = prefixes.some(p => k.startsWith(p)) || (ref && k.startsWith(`sb-${ref}-`));
          if (ok) { try { store.removeItem(k); } catch {} }
        });
      };
      rm(localStorage);
      rm(sessionStorage);
    }

    async function hardLogout() {
      gateWorkspace(true);
      setStatus('warn', 'Signing out…');
      try { await supabase.auth.signOut({ scope: 'local' }); } catch (e) { console.warn('signOut failed:', e); }
      try {
        const keys = [];
        for (let i = 0; i < localStorage.length; i++) keys.push(localStorage.key(i));
        keys.filter(k => k && (k.startsWith('sb-') || k.includes('supabase'))).forEach(k => localStorage.removeItem(k));
      } catch (_) {}
      try { sessionStorage.clear(); } catch (_) {}

      const bust = Date.now();
      try { history.replaceState(null, '', '/admin.html?logged_out=1&t=' + bust); } catch (_) {}
      window.location.replace('/admin.html?logged_out=1&t=' + bust);
    }

    $('btnDoLogout').addEventListener('click', hardLogout);
    $('btnTopLogout').addEventListener('click', hardLogout);

    $('btnAuth').addEventListener('click', async () => {
      await refreshUI();
      openDlg();
    });

    $('btnDoLogin').addEventListener('click', async () => {
      $('authOut').textContent = 'Signing in…';
      const email = $('email').value.trim();
      const password = $('password').value;
      if (!email || !password) { $('authOut').textContent = 'Please enter email + password.'; return; }
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { $('authOut').textContent = 'Sign-in failed: ' + error.message; setStatus('warn','Auth error'); return; }
      await refreshUI();
      closeDlg();
    });

    // ===== A/B panel helpers =====
    function setAbOut(msg) { $('abOut').textContent = msg; }

    async function getJWTOrThrow() {
      const { data: { session } } = await supabase.auth.getSession();
      const jwt = session?.access_token;
      if (!jwt) throw new Error('missing_auth');
      return jwt;
    }

    async function postJson(url, body, jwt) {
      const r = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + jwt,
        },
        body: JSON.stringify(body || {})
      });
      const text = await r.text();
      let json;
      try { json = JSON.parse(text); } catch { json = { raw: text }; }
      if (!r.ok) {
        const e = new Error('http_' + r.status);
        e.payload = json;
        throw e;
      }
      return json;
    }

    function renderTable(rows, cols) {
      if (!rows?.length) return '<div class="help">No rows.</div>';
      const head = '<tr>' + cols.map(c => `<th>${c.label}</th>`).join('') + '</tr>';
      const body = rows.map(r => {
        return '<tr>' + cols.map(c => {
          const v = (typeof c.get === 'function') ? c.get(r) : r[c.key];
          const safe = (v === null || v === undefined) ? '' : String(v);
          return `<td>${safe}</td>`;
        }).join('') + '</tr>';
      }).join('');
      return `<table><thead>${head}</thead><tbody>${body}</tbody></table>`;
    }

    async function abLoadKeys() {
      setAbOut('Loading experiment keys…');
      try {
        const jwt = await getJWTOrThrow();
        const j = await postJson(API.abAdminBundle, { action: 'list_experiments' }, jwt);

        // Expecting either: { ok:true, result:[{experiment_key, track, status, is_killswitched}...] }
        const list = j?.result || j?.data || j?.experiments || [];
        const keys = Array.from(new Set(list.map(x => x.experiment_key).filter(Boolean))).sort();
        if (!keys.length) {
          setAbOut('No experiments returned. If admin-bundle uses a different payload shape, adjust parsing in abLoadKeys().\nRaw: ' + JSON.stringify(j, null, 2));
          return;
        }
        $('abKey').value = keys[0];
        setAbOut('Loaded ' + keys.length + ' keys. Selected: ' + keys[0]);
      } catch (e) {
        setAbOut('Load keys failed: ' + (e?.payload ? JSON.stringify(e.payload, null, 2) : (e?.message || String(e))));
      }
    }

    async function abRefresh() {
      const key = $('abKey').value.trim();
      const track = $('abTrack').value;
      const windowDays = Number($('abWindow').value);

      if (!key) { setAbOut('Please enter experiment_key.'); return; }

      setAbOut('Refreshing metrics…');
      $('abTableWrap').innerHTML = '';
      $('abEventsWrap').innerHTML = '';

      try {
        const jwt = await getJWTOrThrow();
        const payload = { experiment_key: key, track, window_days: windowDays };
        const j = await postJson(API.abRefreshDashboard, payload, jwt);

        // Expected shape (recommended):
        // { ok:true, result:{ variants:[{track, variant_key, exposed_users, metric_users, conversion}], events:[{track,event_name,events,value_sum}] , meta:{...}} }
        const result = j?.result || j;
        const variants = result?.variants || result?.rows || [];
        const events = result?.events || [];

        const vTable = renderTable(variants, [
          { label: 'track', key: 'track' },
          { label: 'variant_key', key: 'variant_key' },
          { label: 'exposed_users', key: 'exposed_users' },
          { label: 'metric_users', key: 'metric_users' },
          { label: 'conversion', get: (r) => {
              const c = r.conversion;
              if (c === null || c === undefined || Number.isNaN(Number(c))) return '';
              return (Math.round(Number(c) * 10000) / 100).toFixed(2) + '%';
            }
          },
        ]);

        const eTable = renderTable(events, [
          { label: 'track', key: 'track' },
          { label: 'event_name', key: 'event_name' },
          { label: 'events', key: 'events' },
          { label: 'value_sum', key: 'value_sum' },
        ]);

        $('abTableWrap').innerHTML = vTable;
        $('abEventsWrap').innerHTML = eTable;

        setAbOut('OK.\nRequest: ' + JSON.stringify(payload) + '\nResponse: ' + JSON.stringify(j, null, 2));
      } catch (e) {
        setAbOut('Refresh failed: ' + (e?.payload ? JSON.stringify(e.payload, null, 2) : (e?.message || String(e))));
      }
    }

    $('abRefresh').addEventListener('click', abRefresh);
    $('abLoadKeys').addEventListener('click', abLoadKeys);

    // ===== core auth UI =====
    async function refreshUI() {
      const { data: { session } } = await supabase.auth.getSession();
      const signedIn = !!session?.user;

      $('kvAuth').textContent = signedIn ? 'authenticated' : 'signed out';
      $('kvUser').textContent = signedIn ? (session.user.email || session.user.id) : '—';

      $('btnTopLogout').style.display = signedIn ? 'inline-flex' : 'none';
      $('btnDoLogout').style.display = signedIn ? 'inline-flex' : 'none';
      $('btnDoLogin').style.display = signedIn ? 'none' : 'inline-flex';
      $('btnAuth').textContent = signedIn ? 'Account' : 'Sign in';

      gateWorkspace(!signedIn);

      const role = signedIn ? await safeGetRole() : 'unknown';
      $('kvRole').textContent = role || 'unknown';

      // A/B auth tag
      if (!signedIn) {
        $('abAuthTag').className = 'tag warn';
        $('abAuthTag').textContent = 'Auth: signed out';
      } else {
        $('abAuthTag').className = 'tag ok';
        $('abAuthTag').textContent = 'Auth: ok (' + (role || 'unknown') + ')';
      }

      setStatus('ok', 'Ready');

      if (!signedIn) {
        $('authOut').textContent = 'Signed out.';
        $('accessOut').textContent = 'Signed out. Workspace locked.';
        const qp = new URLSearchParams(location.search);
        if (qp.get('logged_out') === '1') hardClearAuthStorage();
        setAbOut('Signed out. Sign in to load A/B metrics.');
      } else {
        $('authOut').textContent = `Signed in as ${session.user.email || session.user.id}. Role: ${role}`;
        $('accessOut').textContent = `Role: ${role}`;
      }
    }

  
    // === BFCache hardening (Back button fix) ===
   window.addEventListener("pageshow", (e) => {
   if (e.persisted) {
    // admin console: safest behavior
    window.location.reload();
    }
  });
<script>
</body>
</html>
