<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LogicPals Console — Admin</title>
  <style>
    :root{
      --primary:#4F46E5; --bg1:#EEF2FF; --bg2:#ECFEFF; --card:#fff; --text:#0F172A;
      --muted:#64748B; --border:#E2E8F0; --ok:#10B981; --warn:#F59E0B; --bad:#EF4444;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;min-height:100vh;background:radial-gradient(900px 500px at 15% 10%, var(--bg1) 0%, #F8FAFC 55%, var(--bg2) 100%);color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1120px;margin:0 auto;padding:18px 14px 44px}

    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 14px;background:rgba(255,255,255,.78);border:1px solid var(--border);border-radius:18px;backdrop-filter: blur(10px)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:16px;background:linear-gradient(135deg,#6366F1,#22C55E);display:grid;place-items:center;color:#fff;font-weight:900}
    .brand h1{margin:0;font-size:16px;line-height:1.15}
    .brand p{margin:0;color:var(--muted);font-size:12px}

    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;color:var(--muted);font-size:12px;display:inline-flex;gap:8px;align-items:center}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--warn)}
    .dot.ok{background:var(--ok)}
    .btn{border:1px solid var(--border);background:#fff;border-radius:999px;padding:10px 12px;font-weight:800;font-size:13px;cursor:pointer}
    .btn.primary{border-color:transparent;background:var(--primary);color:#fff}
    .btn.danger{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08);color:#991B1B}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:380px 1fr;gap:14px;margin-top:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 20px 50px rgba(15,23,42,.08)}
    .card .hd{padding:14px 14px 0}
    .card h2{margin:0;font-size:14px}
    .card p{margin:6px 0 0;color:var(--muted);font-size:12px}
    .card .bd{padding:14px}

    .kv{display:grid;grid-template-columns:120px 1fr;gap:8px 10px;font-size:13px}
    .kv .k{color:var(--muted)}

    .tag{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;color:var(--muted)}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--border);padding:14px}
    .tab{border:1px solid var(--border);border-radius:999px;padding:8px 12px;background:#fff;font-weight:800;font-size:12px;cursor:pointer}
    .tab.active{border-color:rgba(79,70,229,.25);background:rgba(79,70,229,.08);color:#3730A3}

    .panel{padding:14px;display:none}
    .panel.active{display:block}

    .callout{border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.08);border-radius:14px;padding:12px;color:#7C4A00;font-size:12px}
    .callout.ok{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.08);color:#065F46}

    .cards{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .mini{border:1px solid var(--border);border-radius:16px;padding:12px;background:linear-gradient(180deg,#fff,#F9FAFB)}
    .mini h3{margin:0;font-size:13px}
    .mini p{margin:6px 0 10px;color:var(--muted);font-size:12px}
    .mini .row{display:flex;gap:10px;flex-wrap:wrap}

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .cards{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="top">
      <div class="brand">
        <div class="logo">LP</div>
        <div>
          <h1>LogicPals Console</h1>
          <p>Enterprise Admin System</p>
        </div>
      </div>

      <div class="actions">
        <span class="pill"><span id="authDot" class="dot"></span><span id="authText">Loading…</span></span>
        <button class="btn" id="btnVisit" type="button">Visit Site</button>
        <button class="btn" id="btnDash" type="button">Dashboard</button>
        <button class="btn primary" id="btnAuth" type="button" disabled>Sign in</button>
        <button class="btn danger" id="btnSignOut" type="button" style="display:none">Sign out</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="hd">
          <h2>Console Status</h2>
          <p>Access controlled via DB roles + RPC gates (Step 7)</p>
        </div>
        <div class="bd">
          <div class="kv">
            <div class="k">Project</div><div>LogicPals-App</div>
            <div class="k">Auth state</div><div id="kvAuth">unknown</div>
            <div class="k">Role</div><div id="kvRole">unknown</div>
            <div class="k">User</div><div id="kvUser">—</div>
          </div>

          <div style="margin-top:12px" class="callout" id="authCallout">
            Sign in to load admin capabilities. If your role is <b>super_admin</b>, you can manage experiments, roles, and monetization.
          </div>

          <div style="margin-top:10px" class="callout ok">
            <b>Roadmap contract:</b> Admin UI never directly writes protected tables. All mutations go through <b>RPC</b> + <b>audit events</b>.
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <h2>Admin Workspace</h2>
          <p>Clean controls with hard boundaries for Regular vs Olympiad</p>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="overview">Overview</button>
          <button class="tab" data-tab="content">Content</button>
          <button class="tab" data-tab="monetization">Monetization</button>
          <button class="tab" data-tab="access">Access</button>
        </div>

        <div id="panel-overview" class="panel active">
          <div class="callout ok">Step 7 readiness: Explainability events + receipts are working. Next: surface trustworthy admin views + immutable audit.</div>
          <div style="height:12px"></div>
          <div class="cards">
            <div class="mini">
              <h3>Regular Review</h3>
              <p>Content management for standard curriculum (admin_regular, super_admin).</p>
              <div class="row">
                <button class="btn" id="goRegularUpload" type="button">Upload / Seed</button>
                <button class="btn" id="goRegularQueue" type="button">Review Queue</button>
              </div>
            </div>
            <div class="mini">
              <h3>Olympiad Review</h3>
              <p>Competition prep (admin_olympiad, super_admin). Strict separation + no hints in mock mode.</p>
              <div class="row">
                <button class="btn" id="goOlympiadUpload" type="button">Upload / Seed</button>
                <button class="btn" id="goOlympiadQueue" type="button">Failed Criteria Queue</button>
              </div>
            </div>
            <div class="mini">
              <h3>Role Management</h3>
              <p>Assign admin roles (super_admin only). Uses RPC + RLS. Audit required.</p>
              <div class="row">
                <button class="btn" id="goRoles" type="button">Open Role Manager</button>
                <button class="btn" id="goAudit" type="button">View Admin Audit</button>
              </div>
            </div>
            <div class="mini">
              <h3>Monetization</h3>
              <p>Payments + subscriptions (manual activation / refunds). RPC-only with receipts.</p>
              <div class="row">
                <button class="btn" id="goPayments" type="button">Payments</button>
                <button class="btn" id="goSubs" type="button">Subscriptions</button>
              </div>
            </div>
          </div>
        </div>

        <div id="panel-content" class="panel">
          <div class="callout">Content tools will be wired once the corresponding admin RPCs are QC-verified.</div>
        </div>

        <div id="panel-monetization" class="panel">
          <div class="callout">Monetization tools require <b>super_admin</b> and will hard-fail without role.</div>
          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" id="goPayments2" type="button">Open Payments</button>
            <button class="btn" id="goSubs2" type="button">Open Subscriptions</button>
          </div>
        </div>

        <div id="panel-access" class="panel">
          <div class="callout">Access & role controls are enforced server-side (RLS + RPC). UI only reflects state.</div>
        </div>
      </section>
    </div>
  </div>

  <script type="module" src="/assets/js/env-loader.js"></script>
  <script type="module">
    const $ = (id) => document.getElementById(id);

    const tabs = Array.from(document.querySelectorAll('.tab'));
    function activateTab(name){
      tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
      ['overview','content','monetization','access'].forEach(k => {
        document.getElementById('panel-'+k).classList.toggle('active', k===name);
      });
    }
    tabs.forEach(t => t.addEventListener('click', () => activateTab(t.dataset.tab)));

    function setAuthPill(ok, msg){
      $('authDot').className = 'dot' + (ok ? ' ok' : '');
      $('authText').textContent = msg;
    }

    async function safeGetRole(client){
      // Use your real RPC if you have it. This MUST be server-truth (RLS-enforced).
      try{
        const { data, error } = await client.rpc('get_my_role');
        if (error) throw error;
        return (data && (data.role || data)) || 'unknown';
      } catch {
        return 'unknown';
      }
    }

    function gateWorkspace(locked){
      // Disable sensitive buttons when signed out.
      const ids = ['goPayments','goSubs','goPayments2','goSubs2','goRoles','goAudit','goRegularUpload','goRegularQueue','goOlympiadUpload','goOlympiadQueue'];
      ids.forEach(id => { const el = $(id); if (el) el.disabled = locked; });
    }

    async function guardedNav(path, requireSuperAdmin=false){
      const client = await window.lpGetClient();
      const { data } = await client.auth.getSession();
      const signedIn = !!data?.session?.user;
      if (!signedIn){
        const next = encodeURIComponent(path);
        location.href = '/admin-login.html?next=' + next;
        return;
      }
      if (requireSuperAdmin){
        const role = await safeGetRole(client);
        if (role !== 'super_admin'){
          alert('Access denied: super_admin required. Current role: ' + (role || 'unknown'));
          return;
        }
      }
      location.href = path;
    }

    async function refreshUI(){
      const client = await window.lpGetClient();
      const { data } = await client.auth.getSession();
      const session = data?.session || null;
      const signedIn = !!session?.user;

      $('kvAuth').textContent = signedIn ? 'authenticated' : 'signed out';
      $('kvUser').textContent = signedIn ? (session.user.email || session.user.id) : '—';

      $('btnAuth').disabled = false;
      $('btnAuth').textContent = signedIn ? 'Account' : 'Sign in';
      $('btnSignOut').style.display = signedIn ? 'inline-flex' : 'none';

      gateWorkspace(!signedIn);

      if (!signedIn){
        $('kvRole').textContent = 'unknown';
        $('authCallout').className = 'callout';
        setAuthPill(false, 'Signed out');
        return;
      }

      const role = await safeGetRole(client);
      $('kvRole').textContent = role || 'unknown';
      setAuthPill(true, 'Auth: ok (' + (role || 'unknown') + ')');
      $('authCallout').className = 'callout ok';
      $('authCallout').innerHTML = 'Signed in as <b>' + (session.user.email || session.user.id) + '</b>. Role: <b>' + (role || 'unknown') + '</b>.';
    }

    // Top nav
    $('btnVisit').addEventListener('click', () => location.href = '/index.html');
    $('btnDash').addEventListener('click', () => location.href = '/dashboard.html');

    $('btnAuth').addEventListener('click', async () => {
      const client = await window.lpGetClient();
      const { data } = await client.auth.getSession();
      const signedIn = !!data?.session?.user;
      if (!signedIn) return (location.href = '/admin-login.html?next=' + encodeURIComponent('/admin.html'));
      // If signed in, keep user here (or route to account page later)
      alert('You are signed in.');
    });

    $('btnSignOut').addEventListener('click', async () => {
      const client = await window.lpGetClient();
      await client.auth.signOut();
      location.replace('/admin.html');
    });

    // Workspace buttons
    $('goPayments').addEventListener('click', () => guardedNav('/admin/admin-payments.html', true));
    $('goSubs').addEventListener('click', () => guardedNav('/admin/admin-subscriptions.html', true));
    $('goPayments2').addEventListener('click', () => guardedNav('/admin/admin-payments.html', true));
    $('goSubs2').addEventListener('click', () => guardedNav('/admin/admin-subscriptions.html', true));

    $('goRoles').addEventListener('click', () => guardedNav('/admin/admin-roles.html', true));
    $('goAudit').addEventListener('click', () => guardedNav('/admin/admin-audit.html', true));

    $('goRegularUpload').addEventListener('click', () => alert('Wire to Regular upload when admin RPC is ready.'));
    $('goRegularQueue').addEventListener('click', () => alert('Wire to Regular review queue when ready.'));
    $('goOlympiadUpload').addEventListener('click', () => alert('Wire to Olympiad upload when admin RPC is ready.'));
    $('goOlympiadQueue').addEventListener('click', () => alert('Wire to Olympiad failed-criteria queue when ready.'));

    // Boot
    (async () => {
      try{
        const client = await window.lpGetClient();
        client.auth.onAuthStateChange(() => refreshUI());
        await refreshUI();
        setAuthPill(false, $('kvAuth').textContent === 'authenticated' ? 'Auth ok' : 'Signed out');
      } catch(e){
        setAuthPill(false, 'Init failed');
        console.error(e);
      }
    })();
  </script>
</body>
</html>
