<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>LogicPals Tutor</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Outfit:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    :root{--primary:#6c5ce7;--success:#00d2a0;--warning:#feca57;--bg:#0c0e1a;--card:rgba(20,24,52,.55);--border:rgba(255,255,255,.06);--text:#f0f0f5;--text2:#9899b3;--muted:#5d5f7e;--bad:#ff6b6b;--as:rgba(108,92,231,.12);--ys:rgba(254,202,87,.10);--glow:rgba(108,92,231,.35);--font:'Plus Jakarta Sans',-apple-system,sans-serif;--font-d:'Outfit',-apple-system,sans-serif;--font-m:'JetBrains Mono',monospace;}
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:var(--font);background:var(--bg);color:var(--text);height:100dvh;display:flex;flex-direction:column;overflow:hidden;-webkit-font-smoothing:antialiased;}
    .subscription-banner{background:linear-gradient(135deg,rgba(254,202,87,.15),rgba(254,202,87,.08));border-bottom:2px solid rgba(254,202,87,.2);padding:12px 20px;text-align:center;font-weight:700;font-size:13px;color:var(--warning);display:none;animation:slideDown .3s ease;}
    .subscription-banner.show{display:block;}
    @keyframes slideDown{from{transform:translateY(-100%);}to{transform:translateY(0);}}
    .banner-link{color:var(--warning);text-decoration:underline;cursor:pointer;margin-left:8px;font-weight:800;}
    header{background:rgba(12,14,26,.75);backdrop-filter:blur(24px) saturate(1.6);padding:10px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);z-index:20;flex-shrink:0;}
    .logo{font-family:var(--font-d);font-weight:800;color:#b8b0f0;font-size:18px;letter-spacing:-.3px;}
    .header-right{display:flex;align-items:center;gap:8px;}
    .timer-badge{background:var(--card);color:var(--text2);font-weight:600;padding:6px 12px;border-radius:100px;font-size:13px;font-family:var(--font-m);border:1px solid var(--border);}
    .exit-btn{background:rgba(255,255,255,.04);color:var(--text2);padding:6px 12px;border-radius:10px;font-size:12px;font-weight:700;border:1px solid var(--border);cursor:pointer;font-family:var(--font);}
    .exit-btn:hover{background:rgba(255,255,255,.08);color:var(--text);}
    .olympiad-btn{background:var(--ys);color:var(--warning);padding:6px 12px;border-radius:10px;font-size:12px;font-weight:700;border:1px solid rgba(254,202,87,.2);cursor:pointer;text-decoration:none;display:inline-block;}
    .status-bar{background:rgba(12,14,26,.6);border-bottom:1px solid var(--border);padding:8px 16px;display:flex;justify-content:center;gap:15px;flex-shrink:0;z-index:15;}
    .stat-pill{font-size:12px;font-weight:700;display:flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;}
    .stat-pill.hints{background:var(--ys);color:var(--warning);border:1px solid rgba(254,202,87,.15);}
    .stat-pill.questions{background:var(--as);color:#b8b0f0;border:1px solid rgba(108,92,231,.15);}
    .main-content{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;width:100%;max-width:800px;margin:0 auto;}
    .problem-container{padding:10px 16px;background:var(--bg);flex-shrink:0;}
    .problem-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:15px;backdrop-filter:blur(16px);position:relative;overflow:hidden;transition:all .3s ease;}
    .problem-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--primary),#a29bfe,var(--success));border-radius:16px 16px 0 0;}
    .problem-header{display:flex;justify-content:space-between;margin-bottom:8px;align-items:center;}
    .badge{padding:4px 10px;border-radius:100px;font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.4px;}
    .badge.difficulty{background:var(--ys);color:var(--warning);border:1px solid rgba(254,202,87,.15);}
    .badge.category{background:var(--as);color:#b8b0f0;border:1px solid rgba(108,92,231,.15);margin-left:5px;}
    .problem-text{font-family:var(--font-d);font-size:16px;font-weight:700;color:var(--text);line-height:1.5;background:linear-gradient(135deg,rgba(254,202,87,.06),rgba(254,202,87,.03));padding:14px;border-radius:12px;border-left:4px solid rgba(254,202,87,.4);}
    .toggle-btn{display:none;width:100%;background:rgba(12,14,26,.6);border:none;border-bottom:1px solid var(--border);color:var(--muted);font:600 12px var(--font);padding:7px;cursor:pointer;flex-shrink:0;}
    .problem-card.minimized .problem-text{display:none;}
    .problem-card.minimized{padding:10px;}
    .chat-container{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;}
    .message{max-width:85%;padding:14px 18px;border-radius:18px;font-size:15px;line-height:1.45;font-weight:500;animation:popIn .3s;}
    .message.ai{align-self:flex-start;background:var(--card);color:var(--text);border:1px solid var(--border);border-bottom-left-radius:4px;}
    .message.user{align-self:flex-end;background:linear-gradient(135deg,var(--primary),#8b7cf6);color:white;border-bottom-right-radius:4px;box-shadow:0 4px 16px var(--glow);}
    .message.hint{align-self:center;background:linear-gradient(135deg,rgba(254,202,87,.08),rgba(254,202,87,.04));color:var(--warning);border:1px dashed rgba(254,202,87,.25);font-size:13px;text-align:center;width:90%;font-weight:600;}
    .message.system{align-self:center;background:rgba(255,255,255,.03);color:var(--muted);border:1px solid var(--border);font-size:13px;text-align:center;width:90%;}
    @keyframes popIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
    .input-area{background:rgba(12,14,26,.8);backdrop-filter:blur(16px);padding:10px 16px;border-top:1px solid var(--border);flex-shrink:0;width:100%;z-index:20;padding-bottom:env(safe-area-inset-bottom,10px);}
    .typing-indicator{font-size:12px;color:var(--muted);margin-bottom:5px;opacity:0;transition:.2s;height:15px;}
    .input-wrapper{display:flex;gap:8px;align-items:center;max-width:800px;margin:0 auto;}
    .round-btn{width:44px;height:44px;border-radius:50%;border:1px solid var(--border);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.12s;flex-shrink:0;background:var(--card);font-family:var(--font);}
    .round-btn:active{transform:scale(.93);}
    .round-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
    .hint-btn{background:var(--ys);color:var(--warning);border-color:rgba(254,202,87,.2);}
    .hint-btn.exhausted{opacity:.4;cursor:not-allowed;}
    .mic-btn{background:rgba(255,255,255,.03);color:var(--text2);}
    .mic-btn.recording{background:rgba(255,107,107,.12);color:var(--bad);border-color:rgba(255,107,107,.2);animation:pulse 1.5s infinite;}
    .send-btn{background:linear-gradient(135deg,var(--primary),#8b7cf6);color:white;border:none;box-shadow:0 2px 12px var(--glow);}
    input[type="text"]{flex:1;padding:0 20px;border:2px solid var(--border);border-radius:100px;font:500 15px var(--font);outline:none;height:44px;background:rgba(255,255,255,.04);color:var(--text);}
    input[type="text"]::placeholder{color:var(--muted);}
    input[type="text"]:focus{border-color:rgba(108,92,231,.3);background:rgba(255,255,255,.06);box-shadow:0 0 0 3px rgba(108,92,231,.08);}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(8,10,22,.7);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:1000;}
    .modal-content{background:rgba(20,24,52,.85);backdrop-filter:blur(24px);border:1px solid var(--border);padding:32px 24px;border-radius:20px;width:90%;max-width:400px;text-align:center;box-shadow:0 24px 64px rgba(0,0,0,.4);animation:popUp .4s;}
    @keyframes popUp{from{transform:scale(.85);opacity:0;}to{transform:scale(1);opacity:1;}}
    .modal-title{font-family:var(--font-d);font-size:28px;font-weight:800;margin-bottom:10px;}
    .modal-title.correct{color:var(--success);}
    .insight-box{background:rgba(0,210,160,.08);border:1px solid rgba(0,210,160,.12);padding:16px;border-radius:14px;margin:15px 0;text-align:left;}
    .next-btn{width:100%;background:var(--success);color:#fff;border:none;padding:14px;border-radius:14px;font:800 16px var(--font);margin-top:10px;cursor:pointer;box-shadow:0 4px 16px rgba(0,210,160,.25);}
    .summary-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:16px 0;}
    .summary-stat{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:12px;padding:10px 6px;text-align:center;}
    .summary-stat .val{font-family:var(--font-d);font-size:18px;font-weight:800;color:var(--text);}
    .summary-stat .lbl{font-size:10px;color:var(--muted);font-weight:600;margin-top:3px;text-transform:uppercase;letter-spacing:.3px;}
    .auth-gate{position:fixed;inset:0;background:rgba(8,10,22,.92);backdrop-filter:blur(16px);display:none;align-items:center;justify-content:center;z-index:2000;flex-direction:column;gap:16px;}
    .auth-gate.show{display:flex;}
    .auth-gate h2{font-family:var(--font-d);font-size:22px;font-weight:800;}
    .auth-gate p{color:var(--muted);font-size:14px;max-width:320px;text-align:center;line-height:1.5;}
    .auth-gate .login-btn{background:linear-gradient(135deg,var(--primary),#8b7cf6);color:#fff;border:none;padding:14px 32px;border-radius:14px;font:700 15px var(--font);cursor:pointer;box-shadow:0 4px 20px var(--glow);}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,107,107,.4);}70%{box-shadow:0 0 0 12px rgba(255,107,107,0);}100%{box-shadow:0 0 0 0 rgba(255,107,107,0);}}
    @media(max-width:600px){.toggle-btn{display:block;}.problem-container{padding:0 10px;}.problem-card{border-radius:0 0 16px 16px;border-top:none;}.problem-card::before{border-radius:0;}.problem-card.minimized{display:none;}.status-bar{padding:5px;gap:10px;}.chat-container{padding:10px;}.input-area{padding:8px 12px;}}
    @media(prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important;}}
  </style>
</head>
<body>
  <div class="auth-gate" id="authGate">
    <h2>&#128274; Sign in required</h2>
    <p>You need to be signed in to practice. Please log in to continue.</p>
    <button class="login-btn" id="authLoginBtn">Go to Login</button>
  </div>
  <div class="subscription-banner" id="subscriptionBanner"><span id="bannerText"></span><span class="banner-link" id="bannerLink">Take Action &#8594;</span></div>
  <header>
    <div class="logo">&#129504; LogicPals</div>
    <div class="header-right">
      <a href="olympiad.html" class="olympiad-btn">&#127942; Olympiad</a>
      <div class="timer-badge">&#9201;&#65039; <span id="timeDisplay">00:00</span></div>
      <button class="exit-btn" id="exitBtn">Exit</button>
    </div>
  </header>
  <div class="status-bar">
    <div class="stat-pill hints">&#128161; Hints: <span id="hintCount">0/3</span></div>
    <div class="stat-pill questions">&#10067; Asked: <span id="questionCount">0</span></div>
  </div>
  <button class="toggle-btn" id="toggleBtn">Show Mystery Question &#128317;</button>
  <div class="main-content">
    <div class="problem-container">
      <div class="problem-card" id="problemCard">
        <div class="problem-header">
          <div><span class="badge difficulty" id="diffBadge">MEDIUM</span><span class="badge category" id="catBadge">LOGIC</span></div>
          <div style="font-size:12px;font-weight:700;color:var(--muted)">Problem <span id="probNum">1</span>/10</div>
        </div>
        <div class="problem-text" id="problemText">Loading mystery...</div>
      </div>
    </div>
    <div class="chat-container" id="chatContainer">
      <div class="message system">Hi! Ready to solve this mystery? Read the problem above! &#128070;</div>
    </div>
  </div>
  <div class="input-area">
    <div class="typing-indicator" id="typing">LogicPals is thinking...</div>
    <div class="input-wrapper">
      <button class="round-btn hint-btn" id="hintBtn" title="Hint">&#128161;</button>
      <input type="text" id="textInput" placeholder="Type your answer..." autocomplete="off" />
      <button class="round-btn mic-btn" id="micBtn" title="Voice">&#127908;</button>
      <button class="round-btn send-btn" id="sendBtn" title="Send">&#10148;</button>
    </div>
  </div>
  <div class="modal-overlay" id="successModal">
    <div class="modal-content">
      <div style="font-size:50px;margin-bottom:10px;" id="modalEmoji">&#127881;</div>
      <div class="modal-title correct" id="modalTitle">YOU DID IT!</div>
      <div style="color:var(--text2);font-weight:600;margin-bottom:15px;">Time: <span id="finalTime">0:00</span> &#8226; Hints: <span id="finalHints">0</span></div>
      <div class="insight-box" id="insightBox">
        <div style="color:var(--success);font-weight:800;font-size:12px;text-transform:uppercase;letter-spacing:.4px;">&#129504; What you just learned</div>
        <div style="color:var(--success);font-size:14px;line-height:1.4;margin-top:5px;" id="learningInsight">You practiced <b>Lateral Thinking</b>!</div>
      </div>
      <div class="summary-stats">
        <div class="summary-stat"><div class="val" id="sessionSolved">0</div><div class="lbl">Solved</div></div>
        <div class="summary-stat"><div class="val" id="sessionAcc">0%</div><div class="lbl">Accuracy</div></div>
        <div class="summary-stat"><div class="val" id="sessionSpeed">—</div><div class="lbl">Avg time</div></div>
      </div>
      <button class="next-btn" id="nextBtn">Next Mystery &#128640;</button>
    </div>
  </div>
<script>
(function(){
  'use strict';

  // ═══ ENV ═══
  async function LP_getEnv(){
    if(window.__LP_ENV?.SUPABASE_URL && window.__LP_ENV?.SUPABASE_ANON_KEY) return window.__LP_ENV;
    const r=await fetch('/api/env',{cache:'no-store',credentials:'same-origin'});
    if(!r.ok) throw new Error('/api/env failed: '+r.status);
    const d=await r.json();
    const env={SUPABASE_URL:d.SUPABASE_URL||d.supabaseUrl||d.url, SUPABASE_ANON_KEY:d.SUPABASE_ANON_KEY||d.supabaseAnonKey||d.anonKey};
    window.__LP_ENV=env;
    return env;
  }
  function LP_showFatal(m){ console.error('[FATAL]',m); document.getElementById('problemText').innerText='\u26A0\uFE0F '+m; }
  function LP_getTrack(){ return new URLSearchParams(location.search).get('track')==='olympiad'?'olympiad':'regular'; }
  async function LP_loadScript(src){ return new Promise((ok,no)=>{const s=document.createElement('script');s.src=src;s.async=true;s.onload=ok;s.onerror=()=>no(new Error('Failed: '+src));document.head.appendChild(s);}); }

  // ═══ STATE ═══
  const STORAGE_KEY='logicpals.auth';
  const TRACK=LP_getTrack();
  const LOGIN_URL='/login.html?next='+encodeURIComponent(location.pathname+location.search);

  let sb=null, currentProblem=null, currentChildId=null, currentUserId=null;
  let hintsUsed=0, chatLog=[], startTime=null, timerInt=null;
  let isProcessing=false, questionsAsked=0, userSubscription=null;
  let problemCount=0, sessionCorrect=0, sessionTotal=0;
  let firstInputTime=null; // tracks time_to_first_input
  let sessionId=null;       // UUID for this practice session
  let sessionTimes=[];      // track solve times for avg speed
  const UUID_RE=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  function isValidUUID(v){return typeof v==='string'&&UUID_RE.test(v);}

  const localPuzzles=[
    {id:'999',problem_text:'A farmer has 17 sheep and all but 9 die. How many are left?',solution_explanation:'9',answer_key:'9',category:'logic',difficulty:'medium',hints:['Read carefully!','It says "all but 9"','The answer is in the question.']},
    {id:'998',problem_text:'If you have 3 apples and take away 2, how many do YOU have?',solution_explanation:'2',answer_key:'2',category:'logic',difficulty:'easy',hints:['You took them!','How many did you take?','You have the 2 you took.']},
    {id:'997',problem_text:'What is half of 2+2?',solution_explanation:'2',answer_key:'2',category:'arithmetic',difficulty:'easy',hints:['Do the addition first.','2+2=4.','Half of 4 is 2.']}
  ];

  const learningInsights={
    logic:'LATERAL THINKING — looking at problems creatively!',
    arithmetic:'NUMBER SENSE — understanding how numbers relate!',
    'word-problem':'COMPREHENSION — understanding what questions really ask!',
    pattern:'PATTERN RECOGNITION — spotting what comes next!',
    algebra:'ABSTRACT THINKING — working with unknowns!',
    geometry:'SPATIAL REASONING — visualizing shapes and spaces!'
  };

  // ═══ UUID generator ═══
  function uuid(){ return crypto.randomUUID ? crypto.randomUUID() : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c==='x'?r:(r&0x3|0x8)).toString(16);}); }

  // ═══ DOM ═══
  const $=id=>document.getElementById(id);
  let dom={};
  function cacheDom(){
    ['problemText','diffBadge','catBadge','probNum','problemCard','toggleBtn',
     'chatContainer','textInput','sendBtn','hintBtn','micBtn','typing',
     'hintCount','questionCount','timeDisplay',
     'successModal','modalTitle','modalEmoji','finalTime','finalHints','learningInsight','insightBox',
     'nextBtn','sessionSolved','sessionAcc','sessionSpeed',
     'subscriptionBanner','bannerText','bannerLink',
     'authGate','authLoginBtn','exitBtn'
    ].forEach(id=>{dom[id]=$(id);});
  }

  // ═══ UI HELPERS ═══
  function addMessage(role,text,animate=true){
    const div=document.createElement('div');
    div.className='message '+role;
    div.innerText=text;
    if(!animate)div.style.animation='none';
    dom.chatContainer.appendChild(div);
    dom.chatContainer.scrollTop=dom.chatContainer.scrollHeight;
  }
  function updateStats(){
    dom.hintCount.innerText=hintsUsed+'/3';
    dom.questionCount.innerText=String(questionsAsked);
    if(hintsUsed>=3){dom.hintBtn.classList.add('exhausted');dom.hintBtn.title='No hints left';}
    else{dom.hintBtn.classList.remove('exhausted');dom.hintBtn.title='Hint ('+(3-hintsUsed)+' left)';}
  }
  function renderProblem(){
    if(!currentProblem)return;
    dom.problemText.innerText=currentProblem.problem_text||'Mystery loading...';
    dom.diffBadge.innerText=(currentProblem.difficulty||'MEDIUM').toUpperCase();
    dom.catBadge.innerText=(currentProblem.category||'LOGIC').toUpperCase();
    dom.probNum.innerText=String(problemCount||1);
    if(window.innerWidth<=600){dom.problemCard.classList.remove('minimized');dom.toggleBtn.innerText='Hide Mystery \uD83D\uDD3C';}
  }
  function toggleProblem(){
    const h=dom.problemCard.classList.toggle('minimized');
    dom.toggleBtn.innerText=h?'Show Mystery \uD83D\uDD3D':'Hide Mystery \uD83D\uDD3C';
  }
  function startTimer(){
    if(timerInt)clearInterval(timerInt);
    timerInt=setInterval(()=>{
      if(!startTime)return;
      const d=Math.floor((Date.now()-startTime)/1000);
      dom.timeDisplay.innerText=String(Math.floor(d/60)).padStart(2,'0')+':'+String(d%60).padStart(2,'0');
    },1000);
  }
  function showSubscriptionBanner(type,days){
    if(!dom.subscriptionBanner)return;
    if(type==='expired'){dom.bannerText.textContent='\u26A0\uFE0F Your free trial has ended!';dom.bannerLink.onclick=()=>location.href='upgrade.html';}
    else if(type==='trial_ending'){dom.bannerText.textContent='\u23F0 Only '+days+' days left!';dom.bannerLink.onclick=()=>location.href='upgrade.html';}
    else{dom.bannerText.textContent='\u26A0\uFE0F Subscription check unavailable.';dom.bannerLink.style.display='none';}
    dom.subscriptionBanner.classList.add('show');
  }

  // ═══ STATE PERSISTENCE ═══
  function saveState(){
    try{localStorage.setItem('lp_state',JSON.stringify({
      problem:currentProblem,hints:hintsUsed,questions:questionsAsked,
      chat:chatLog,timeStart:startTime,track:TRACK,
      problemCount,sessionCorrect,sessionTotal,firstInputTime,sessionId,sessionTimes
    }));}catch(_){}
  }
  function restoreState(s){
    currentProblem=s.problem;hintsUsed=s.hints||0;questionsAsked=s.questions||0;
    chatLog=s.chat||[];startTime=s.timeStart||Date.now();
    problemCount=s.problemCount||1;sessionCorrect=s.sessionCorrect||0;sessionTotal=s.sessionTotal||0;
    firstInputTime=s.firstInputTime||null;sessionId=s.sessionId||uuid();sessionTimes=s.sessionTimes||[];
    renderProblem();updateStats();
    dom.chatContainer.innerHTML='<div class="message system">Welcome back! Picking up where we left off. \uD83E\uDDE0</div>';
    chatLog.forEach(m=>{if(m.role!=='system')addMessage(m.role==='assistant'?'ai':'user',m.content,false);});
    startTimer();
  }
  function clearStateAndExit(){localStorage.removeItem('lp_state');location.href='dashboard.html';}

  // ═══ CORE: Load puzzle ═══
  async function loadNextPuzzle(clearMemory){
    if(userSubscription?.expired && window.SubscriptionGuard?.showUpgradeModal){
      SubscriptionGuard.showUpgradeModal('Your free trial has ended! Upgrade to continue.','champion');return;
    }
    if(clearMemory)localStorage.removeItem('lp_state');
    dom.successModal.style.display='none';
    dom.chatContainer.innerHTML='<div class="message system">Hi! Ready to solve this? Read the mystery above! \uD83D\uDC46</div>';
    dom.textInput.value='';
    hintsUsed=0;questionsAsked=0;chatLog=[];firstInputTime=null;
    problemCount++;
    updateStats();

    let puzzle=localPuzzles[Math.floor(Math.random()*localPuzzles.length)];
    try{
      if(sb){
        const level=TRACK==='olympiad'?'olympiad':'regular';
        const{data,error}=await sb.from('problems').select('*').eq('is_active',true).eq('olympiad_level',level);
        if(!error&&data?.length>0) puzzle=data[Math.floor(Math.random()*data.length)];
      }
    }catch(e){console.warn('[Learn] Problem fetch failed:',e);}

    currentProblem=puzzle;
    startTime=Date.now();
    saveState();renderProblem();startTimer();
    dom.textInput.focus();
  }

  // ═══ CORE: Send answer ═══
  async function sendText(){
    const text=dom.textInput.value.trim();
    if(!text||isProcessing)return;

    // Track first input timing
    if(!firstInputTime) firstInputTime=Date.now();

    isProcessing=true;questionsAsked++;updateStats();
    dom.sendBtn.disabled=true;dom.typing.style.opacity=1;
    addMessage('user',text);dom.textInput.value='';
    chatLog.push({role:'user',content:text});saveState();

    // Local answer check
    const cleanInput=text.toLowerCase().replace(/[^a-z0-9]/g,'');
    const sources=[currentProblem?.answer_key,currentProblem?.solution_explanation].filter(Boolean);
    let isCorrect=false;
    for(const src of sources){
      for(const a of src.toLowerCase().split('|')){
        const ca=a.replace(/[^a-z0-9]/g,'');
        if(ca.length>0&&cleanInput.includes(ca)){isCorrect=true;break;}
      }
      if(isCorrect)break;
    }

    if(isCorrect){
      await logAttempt(true,text);
      finishPuzzle(true);
      isProcessing=false;dom.sendBtn.disabled=false;dom.typing.style.opacity=0;
      return;
    }

    // Ask tutor API
    try{
      const res=await fetch('/api/tutor',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({problem_text:currentProblem?.problem_text,solution_explanation:currentProblem?.solution_explanation,chatLog,track:TRACK})
      });
      let data=null;try{data=await res.json();}catch(_){}
      const reply=data?.reply||"Hmm, that's not quite right. Try a different angle!";
      addMessage('ai',reply);chatLog.push({role:'assistant',content:reply});saveState();

      const rl=reply.toLowerCase();
      if((rl.includes('correct')||rl.includes('\uD83C\uDF89'))&&cleanInput.length>1){
        await logAttempt(true,text);finishPuzzle(true);
      }
      // Don't log wrong attempt per message — only log once when problem is finished or skipped
    }catch(e){
      console.error('[Learn] Tutor error:',e);
      addMessage('ai',"Hmm, that doesn't seem right. Try again!");
    }

    isProcessing=false;dom.sendBtn.disabled=false;dom.typing.style.opacity=0;
    dom.textInput.focus();
  }

  // ═══ LOG ATTEMPT — ONE record per problem ═══
  async function logAttempt(solvedCorrectly,submittedAnswer){
    if(!sb)return;
    // Must have at least one identity
    if(!currentChildId&&!currentUserId){console.warn('[Learn] No identity to log attempt');return;}
    // Only save DB problems (valid UUIDs), skip local fallback puzzles
    const pid=currentProblem?.id;
    if(!isValidUUID(pid)){console.log('[Learn] Local puzzle, skipping DB save. id=',pid);return;}

    const now=new Date().toISOString();
    const elapsed=startTime?Math.round((Date.now()-startTime)/1000):null;
    const ttfi=firstInputTime&&startTime?Math.round((firstInputTime-startTime)/1000):null;
    if(solvedCorrectly&&elapsed) sessionTimes.push(elapsed);

    const row={
      problem_id: pid,
      solved_correctly: solvedCorrectly,
      is_correct: solvedCorrectly,
      hints_used: hintsUsed,
      questions_asked: questionsAsked,
      attempt_number: problemCount,
      submitted_answer: submittedAnswer||null,
      ai_conversation: chatLog.length>0?chatLog:null,
      time_spent_seconds: elapsed,
      time_to_first_input_seconds: ttfi,
      started_at: startTime?new Date(startTime).toISOString():null,
      completed_at: now,
      session_id: sessionId||null,
      mode: TRACK,
      difficulty_tier: currentProblem?.difficulty||null,
      attempt_state: solvedCorrectly?'completed':'skipped'
    };
    if(currentChildId) row.child_id=currentChildId;
    if(currentUserId) row.user_id=currentUserId;

    
    // Add track for server-side verification (regular|olympiad)
    row.track = TRACK;

    // Enterprise path: server-side attempt logging
    const ALLOW_CLIENT_FALLBACK = false; // keep FALSE in production

    // Get JWT
    let jwt = null;
    try{
      const s = await sb.auth.getSession();
      jwt = s?.data?.session?.access_token || null;
    }catch(e){ jwt = null; }

    if(!jwt){
      console.warn('[attempt] No JWT/session. Attempt not logged.');
      if(!ALLOW_CLIENT_FALLBACK) return;
    }

    // 1) Server endpoint
    try{
      const r = await fetch('/api/attempt/log', {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          ...(jwt ? {'Authorization': 'Bearer ' + jwt} : {})
        },
        body: JSON.stringify({ data: row })
      });

      if(r.ok){
        const out = await r.json();
        if(DEBUG) console.log('[attempt] server logged', out);
        return;
      }

      let body=null;
      try{ body = await r.json(); }catch(_){}
      console.warn('[attempt] server refused', r.status, body?.error || '');
      if(!ALLOW_CLIENT_FALLBACK) return;
    }catch(e){
      console.warn('[attempt] server network error');
      if(!ALLOW_CLIENT_FALLBACK) return;
    }

    // 2) Controlled rollback only (disabled by default)
    try{
      const { data, error } = await sb.from('attempts').insert(row).select('id').single();
      if(error) throw error;
      if(DEBUG) console.log('[attempt] client fallback logged', data?.id);
    }catch(e){
      console.warn('[attempt] client fallback failed');
    }
  }

  // ═══ FINISH PUZZLE ═══
  function finishPuzzle(correct){
    localStorage.removeItem('lp_state');
    sessionCorrect++;sessionTotal++;
    addMessage('ai','Correct! \uD83C\uDF89 Amazing job!');
    try{confetti({particleCount:150,spread:70,origin:{y:0.6}});}catch(_){}

    dom.finalTime.innerText=dom.timeDisplay.innerText;
    dom.finalHints.innerText=String(hintsUsed);

    const cat=(currentProblem?.category||'logic').toLowerCase();
    dom.learningInsight.innerHTML='You practiced <b>'+(learningInsights[cat]||'Critical Thinking')+'</b>';
    dom.sessionSolved.innerText=String(sessionCorrect);
    const acc=sessionTotal>0?Math.round(sessionCorrect/sessionTotal*100):0;
    dom.sessionAcc.innerText=acc+'%';
    const avgT=sessionTimes.length>0?Math.round(sessionTimes.reduce((a,b)=>a+b,0)/sessionTimes.length):null;
    dom.sessionSpeed.innerText=avgT?avgT+'s':'\u2014';

    setTimeout(()=>{dom.successModal.style.display='flex';},700);
  }

  // ═══ HINT ═══
  function useHint(){
    if(hintsUsed>=3)return;
    let hints=currentProblem?.hints;
    if(!hints||!Array.isArray(hints)||!hints.length) hints=['Think carefully about the wording!','Read the problem one more time.','The answer might be simpler than you think.'];
    addMessage('hint','\uD83D\uDCA1 HINT: '+hints[Math.min(hintsUsed,hints.length-1)]);
    hintsUsed++;updateStats();saveState();
  }

  // ═══ VOICE ═══
  let recognition=null,isRecording=false;
  function ensureRecognizer(){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR)return null;
    const r=new SR();r.lang='en-US';r.interimResults=false;r.maxAlternatives=1;
    r.onstart=()=>{isRecording=true;dom.micBtn.classList.add('recording');};
    r.onend=()=>{isRecording=false;dom.micBtn.classList.remove('recording');};
    r.onerror=(e)=>{isRecording=false;dom.micBtn.classList.remove('recording');if(e.error==='not-allowed')addMessage('system','Mic access denied.');};
    r.onresult=(e)=>{const t=e.results?.[0]?.[0]?.transcript||'';if(t.trim()){dom.textInput.value=t.trim();sendText();}};
    return r;
  }
  function toggleRecording(){
    if(!(window.SpeechRecognition||window.webkitSpeechRecognition)){addMessage('system','Voice requires Chrome/Edge/Safari.');return;}
    if(!recognition)recognition=ensureRecognizer();if(!recognition)return;
    try{if(isRecording)recognition.stop();else recognition.start();}catch(e){isRecording=false;dom.micBtn.classList.remove('recording');}
  }

  // ═══ BOOT ═══
  window.addEventListener('load',async()=>{
    cacheDom();
    sessionId=uuid();

    dom.exitBtn.addEventListener('click',clearStateAndExit);
    dom.toggleBtn.addEventListener('click',toggleProblem);
    dom.hintBtn.addEventListener('click',useHint);
    dom.sendBtn.addEventListener('click',sendText);
    dom.micBtn.addEventListener('click',toggleRecording);
    dom.nextBtn.addEventListener('click',()=>loadNextPuzzle(true));
    dom.textInput.addEventListener('keypress',e=>{if(e.key==='Enter')sendText();});
    dom.authLoginBtn.addEventListener('click',()=>location.assign(LOGIN_URL));

    try{
      const env=await LP_getEnv();
      if(!env?.SUPABASE_URL||!env?.SUPABASE_ANON_KEY) return LP_showFatal('Missing Supabase config.');

      sb=supabase.createClient(env.SUPABASE_URL,env.SUPABASE_ANON_KEY,{
        auth:{storageKey:STORAGE_KEY,persistSession:true,autoRefreshToken:true,detectSessionInUrl:true}
      });

      // Auth — no redirect, overlay instead
      let user=null;
      try{const{data}=await sb.auth.getSession();if(data?.session?.user)user=data.session.user;}catch(_){}
      if(!user){try{const{data}=await sb.auth.getUser();if(data?.user)user=data.user;}catch(_){}}
      if(!user){dom.authGate.classList.add('show');return;}
      currentUserId=user.id;
      console.log('[Learn] Auth OK:',user.id,user.email);

      // Subscription guard (graceful)
      try{await LP_loadScript('/assets/js/subscription-guard.js');}catch(_){}
      try{
        if(window.SubscriptionGuard?.getUserSubscription){
          userSubscription=await SubscriptionGuard.getUserSubscription();
          if(userSubscription?.expired)showSubscriptionBanner('expired');
          else if(userSubscription?.tier==='free_trial'&&SubscriptionGuard.getUserTierInfo){
            const t=await SubscriptionGuard.getUserTierInfo();
            if(t?.daysRemaining<=3)showSubscriptionBanner('trial_ending',t.daysRemaining);
          }
        }
      }catch(_){}

      // Child ID
      try{
        const{data,error}=await sb.from('children').select('id,name').eq('parent_id',user.id).single();
        if(data?.id){currentChildId=data.id;console.log('[Learn] Child:',data.id,data.name);}
        else console.warn('[Learn] No child profile:',error?.message);
      }catch(_){}
      if(!currentChildId) console.warn('[Learn] No child_id — will use user_id for attempts');

      // Responsive
      if(window.innerWidth>600)dom.toggleBtn.style.display='none';
      else dom.problemCard.classList.add('minimized');

      // Restore or fresh
      try{
        const raw=localStorage.getItem('lp_state');
        if(raw){
          const p=JSON.parse(raw);
          if(p?.track&&p.track!==TRACK){localStorage.removeItem('lp_state');await loadNextPuzzle(false);}
          else restoreState(p);
        }else await loadNextPuzzle(false);
      }catch(_){await loadNextPuzzle(false);}

      dom.textInput.focus();
    }catch(e){console.error(e);LP_showFatal('Start failed: '+(e?.message||e));}
  });
})();
</script>
</body>
</html>
