<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>LogicPals Tutor</title>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Outfit:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Vendor libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- IMPORTANT:
       DO NOT load subscription-guard.js here.
       We will load it only AFTER /api/env is fetched and Supabase is initialized (deterministic boot).
  -->

  <style>
    :root{--primary:#6c5ce7;--success:#00d2a0;--warning:#feca57;--bg:#0c0e1a;--card:rgba(20,24,52,.55);--border:rgba(255,255,255,.06);--text:#f0f0f5;--text2:#9899b3;--muted:#5d5f7e;--bad:#ff6b6b;--as:rgba(108,92,231,.12);--ys:rgba(254,202,87,.10);--glow:rgba(108,92,231,.35);--font:'Plus Jakarta Sans',-apple-system,sans-serif;--font-d:'Outfit',-apple-system,sans-serif;--font-m:'JetBrains Mono',monospace;}
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:var(--font);background:var(--bg);color:var(--text);height:100dvh;display:flex;flex-direction:column;overflow:hidden;-webkit-font-smoothing:antialiased;}

    .subscription-banner{background:linear-gradient(135deg,rgba(254,202,87,.15),rgba(254,202,87,.08));border-bottom:2px solid rgba(254,202,87,.2);padding:12px 20px;text-align:center;font-weight:700;font-size:13px;color:var(--warning);display:none;animation:slideDown .3s ease;}
    .subscription-banner.show{display:block;}
    @keyframes slideDown{from{transform:translateY(-100%);}to{transform:translateY(0);}}
    .banner-link{color:var(--warning);text-decoration:underline;cursor:pointer;margin-left:8px;font-weight:800;}

    header{background:rgba(12,14,26,.75);backdrop-filter:blur(24px) saturate(1.6);-webkit-backdrop-filter:blur(24px) saturate(1.6);padding:10px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);z-index:20;flex-shrink:0;}
    .logo{font-family:var(--font-d);font-weight:800;color:#b8b0f0;font-size:18px;letter-spacing:-.3px;}
    .header-right{display:flex;align-items:center;gap:8px;}
    .timer-badge{background:var(--card);color:var(--text2);font-weight:600;padding:6px 12px;border-radius:100px;font-size:13px;font-family:var(--font-m);border:1px solid var(--border);}
    .exit-btn{background:rgba(255,255,255,.04);color:var(--text2);padding:6px 12px;border-radius:10px;font-size:12px;font-weight:700;border:1px solid var(--border);cursor:pointer;}
    .exit-btn:hover{background:rgba(255,255,255,.08);color:var(--text);}
    .olympiad-btn{background:var(--ys);color:var(--warning);padding:6px 12px;border-radius:10px;font-size:12px;font-weight:700;border:1px solid rgba(254,202,87,.2);cursor:pointer;text-decoration:none;display:inline-block;}

    .status-bar{background:rgba(12,14,26,.6);border-bottom:1px solid var(--border);padding:8px 16px;display:flex;justify-content:center;gap:15px;flex-shrink:0;z-index:15;}
    .stat-pill{font-size:12px;font-weight:700;display:flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;}
    .stat-pill.hints{background:var(--ys);color:var(--warning);border:1px solid rgba(254,202,87,.15);}
    .stat-pill.questions{background:var(--as);color:#b8b0f0;border:1px solid rgba(108,92,231,.15);}

    .main-content{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;width:100%;max-width:800px;margin:0 auto;}
    .problem-container{padding:10px 16px;background:var(--bg);flex-shrink:0;}
    .problem-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:15px;backdrop-filter:blur(16px);position:relative;overflow:hidden;transition:all .3s ease;}
    .problem-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--primary),#a29bfe,var(--success));border-radius:16px 16px 0 0;}
    .problem-header{display:flex;justify-content:space-between;margin-bottom:8px;align-items:center;}
    .badge{padding:4px 10px;border-radius:100px;font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.4px;}
    .badge.difficulty{background:var(--ys);color:var(--warning);border:1px solid rgba(254,202,87,.15);}
    .badge.category{background:var(--as);color:#b8b0f0;border:1px solid rgba(108,92,231,.15);margin-left:5px;}
    .problem-text{font-family:var(--font-d);font-size:16px;font-weight:700;color:var(--text);line-height:1.5;background:linear-gradient(135deg,rgba(254,202,87,.06),rgba(254,202,87,.03));padding:14px;border-radius:12px;border-left:4px solid rgba(254,202,87,.4);}
    .toggle-btn{display:none;width:100%;background:rgba(12,14,26,.6);border:none;border-bottom:1px solid var(--border);color:var(--muted);font:600 12px var(--font);padding:7px;cursor:pointer;flex-shrink:0;}
    .problem-card.minimized .problem-text{display:none;}
    .problem-card.minimized{padding:10px;}

    .chat-container{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;}
    .message{max-width:85%;padding:14px 18px;border-radius:18px;font-size:15px;line-height:1.45;font-weight:500;animation:popIn .3s;}
    .message.ai{align-self:flex-start;background:var(--card);color:var(--text);border:1px solid var(--border);border-bottom-left-radius:4px;}
    .message.user{align-self:flex-end;background:linear-gradient(135deg,var(--primary),#8b7cf6);color:white;border-bottom-right-radius:4px;box-shadow:0 4px 16px var(--glow);}
    .message.hint{align-self:center;background:linear-gradient(135deg,rgba(254,202,87,.08),rgba(254,202,87,.04));color:var(--warning);border:1px dashed rgba(254,202,87,.25);font-size:13px;text-align:center;width:90%;font-weight:600;}
    .message.system{align-self:center;background:rgba(255,255,255,.03);color:var(--muted);border:1px solid var(--border);font-size:13px;text-align:center;width:90%;}
    @keyframes popIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

    .input-area{background:rgba(12,14,26,.8);backdrop-filter:blur(16px);padding:10px 16px;border-top:1px solid var(--border);flex-shrink:0;width:100%;z-index:20;padding-bottom:env(safe-area-inset-bottom,10px);}
    .typing-indicator{font-size:12px;color:var(--muted);margin-bottom:5px;opacity:0;transition:.2s;height:15px;}
    .input-wrapper{display:flex;gap:8px;align-items:center;max-width:800px;margin:0 auto;}
    .round-btn{width:44px;height:44px;border-radius:50%;border:1px solid var(--border);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.12s;flex-shrink:0;background:var(--card);}
    .round-btn:active{transform:scale(.93);}
    .hint-btn{background:var(--ys);color:var(--warning);border-color:rgba(254,202,87,.2);}
    .mic-btn{background:rgba(255,255,255,.03);color:var(--text2);}
    .mic-btn.recording{background:rgba(255,107,107,.12);color:var(--bad);border-color:rgba(255,107,107,.2);animation:pulse 1.5s infinite;}
    .send-btn{background:linear-gradient(135deg,var(--primary),#8b7cf6);color:white;border:none;box-shadow:0 2px 12px var(--glow);}
    input{flex:1;padding:0 20px;border:2px solid var(--border);border-radius:100px;font:500 15px var(--font);outline:none;height:44px;background:rgba(255,255,255,.04);color:var(--text);}
    input::placeholder{color:var(--muted);}
    input:focus{border-color:rgba(108,92,231,.3);background:rgba(255,255,255,.06);box-shadow:0 0 0 3px rgba(108,92,231,.08);}

    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(8,10,22,.7);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:1000;}
    .modal-content{background:rgba(20,24,52,.85);backdrop-filter:blur(24px);border:1px solid var(--border);padding:32px 24px;border-radius:20px;width:90%;max-width:400px;text-align:center;box-shadow:0 24px 64px rgba(0,0,0,.4);animation:popUp .4s;}
    @keyframes popUp{from{transform:scale(.85);opacity:0;}to{transform:scale(1);opacity:1;}}
    .modal-title{font-family:var(--font-d);font-size:28px;font-weight:800;color:var(--success);margin-bottom:10px;}
    .insight-box{background:rgba(0,210,160,.08);border:1px solid rgba(0,210,160,.12);padding:16px;border-radius:14px;margin:15px 0;text-align:left;}
    .next-btn{width:100%;background:var(--success);color:#fff;border:none;padding:14px;border-radius:14px;font:800 16px var(--font);margin-top:10px;cursor:pointer;box-shadow:0 4px 16px rgba(0,210,160,.25);}
    .next-btn:hover{box-shadow:0 6px 24px rgba(0,210,160,.35);}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,107,107,.4);}70%{box-shadow:0 0 0 12px rgba(255,107,107,0);}100%{box-shadow:0 0 0 0 rgba(255,107,107,0);}}
    @media(max-width:600px){.toggle-btn{display:block;}.problem-container{padding:0 10px;}.problem-card{border-radius:0 0 16px 16px;border-top:none;}.problem-card::before{border-radius:0;}.problem-card.minimized{display:none;}.status-bar{padding:5px;gap:10px;}.chat-container{padding:10px;}.input-area{padding:8px 12px;}}
    @media(prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important;}}
  </style>
</head>

<body>
  <div class="subscription-banner" id="subscriptionBanner">
    <span id="bannerText"></span>
    <span class="banner-link" onclick="handleBannerClick()">Take Action ‚Üí</span>
  </div>

  <header>
    <div class="logo">üß† LogicPals</div>
    <div class="header-right">
      <a href="olympiad.html" class="olympiad-btn">üèÜ Olympiad</a>
      <div class="timer-badge">‚è±Ô∏è <span id="timeDisplay">00:00</span></div>
      <button onclick="clearStateAndExit()" class="exit-btn">Exit</button>
    </div>
  </header>

  <div class="status-bar">
    <div class="stat-pill hints">üí° Hints: <span id="hintCount">0/3</span></div>
    <div class="stat-pill questions">‚ùì Asked: <span id="questionCount">0</span></div>
  </div>

  <button class="toggle-btn" id="toggleBtn" onclick="toggleProblem()">Show Mystery Question üîΩ</button>

  <div class="main-content">
    <div class="problem-container">
      <div class="problem-card" id="problemCard">
        <div class="problem-header">
          <div>
            <span class="badge difficulty" id="diffBadge">MEDIUM</span>
            <span class="badge category" id="catBadge">LOGIC</span>
          </div>
          <div style="font-size:12px;font-weight:700;color:var(--muted)">
            Problem <span id="probNum">1</span>/10
          </div>
        </div>
        <div class="problem-text" id="problemText">Loading mystery...</div>
      </div>
    </div>

    <div class="chat-container" id="chatContainer">
      <div class="message system">Hi! Ready to solve this mystery? Read the problem above! üëÜ</div>
    </div>
  </div>

  <div class="input-area">
    <div class="typing-indicator" id="typing">LogicPals is thinking...</div>
    <div class="input-wrapper">
      <button class="round-btn hint-btn" onclick="useHint()" title="Hint">üí°</button>
      <input type="text" id="textInput" placeholder="Type here..." autocomplete="off" />
      <button class="round-btn mic-btn" id="micBtn" onclick="toggleRecording()" title="Voice">üé§</button>
      <button class="round-btn send-btn" id="sendBtn" onclick="sendText()" title="Send">‚û§</button>
    </div>
  </div>

  <div class="modal-overlay" id="successModal">
    <div class="modal-content">
      <div style="font-size:50px;margin-bottom:10px;">üéâ</div>
      <div class="modal-title">YOU DID IT!</div>
      <div style="color:var(--text2);font-weight:600;margin-bottom:15px;">
        Time: <span id="finalTime">0:00</span> ‚Ä¢ Hints: <span id="finalHints">0</span>
      </div>
      <div class="insight-box">
        <div style="color:var(--success);font-weight:800;font-size:12px;text-transform:uppercase;letter-spacing:.4px;">üß† What you just learned</div>
        <div style="color:var(--success);font-size:14px;line-height:1.4;margin-top:5px;" id="learningInsight">You practiced <b>Lateral Thinking</b>!</div>
      </div>
      <button class="next-btn" onclick="loadNextPuzzle(true)">Next Mystery üöÄ</button>
    </div>
  </div>

  <script>
    // -----------------------------
    // Enterprise-grade deterministic bootstrap
    // -----------------------------
    async function LP_getEnv() {
      // prefer cached
      if (window.__LP_ENV && window.__LP_ENV.SUPABASE_URL && window.__LP_ENV.SUPABASE_ANON_KEY) return window.__LP_ENV;

      const url = '/api/env';
      const r = await fetch(url, { cache: 'no-store', credentials: 'same-origin' });
      if (!r.ok) throw new Error('GET /api/env failed: ' + r.status);
      const env = await r.json();
      window.__LP_ENV = env;
      return env;
    }

    function LP_showFatal(msg) {
      console.error(msg);
      alert(msg);
      // keep UI stable
      document.getElementById('problemText').innerText = '‚ö†Ô∏è ' + msg;
      document.getElementById('typing').style.opacity = 0;
    }

    function LP_getTrack() {
      const p = new URLSearchParams(location.search);
      const t = (p.get('track') || 'regular').toLowerCase();
      return (t === 'olympiad') ? 'olympiad' : 'regular';
    }

    async function LP_loadScript(src) {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = resolve;
        s.onerror = () => reject(new Error('Failed to load script: ' + src));
        document.head.appendChild(s);
      });
    }

    // -----------------------------
    // App state
    // -----------------------------
    let SB_URL = null;
    let SB_KEY = null;
    let sb = null;

    let currentProblem = null;
    let currentChildId = null;
    let hintsUsed = 0;
    let chatLog = [];
    let startTime = null;
    let timerInt = null;
    let isProcessing = false;
    let questionsAsked = 0;
    let userSubscription = null;

    const TRACK = LP_getTrack(); // "regular" | "olympiad"

    const learningInsights = {
      'logic': 'LATERAL THINKING - looking at problems in creative ways!',
      'arithmetic': 'NUMBER SENSE - understanding how numbers work together!',
      'word-problem': 'COMPREHENSION - understanding what the question really asks!',
      'pattern': 'PATTERN RECOGNITION - spotting what comes next!',
      'algebra': 'ABSTRACT THINKING - working with unknown values!'
    };

    const localPuzzles = [
      { id: "999", problem_text: "A farmer has 17 sheep and all but 9 die. How many are left?", solution_explanation: "9", category: "logic", difficulty: "medium", hints: ["Read carefully!", "It says 'all but 9'"] }
    ];

    // -----------------------------
    // Subscription banner helpers
    // -----------------------------
    function showSubscriptionBanner(type, daysRemaining = 0) {
      const banner = document.getElementById('subscriptionBanner');
      const bannerText = document.getElementById('bannerText');

      if (type === 'expired') {
        bannerText.textContent = '‚ö†Ô∏è Your free trial has ended!';
        banner.dataset.action = 'upgrade';
      } else if (type === 'trial_ending') {
        bannerText.textContent = `‚è∞ Only ${daysRemaining} days left in your free trial!`;
        banner.dataset.action = 'upgrade';
      } else if (type === 'error') {
        bannerText.textContent = '‚ö†Ô∏è Subscription check unavailable. Limited mode.';
        banner.dataset.action = '';
      }

      banner.classList.add('show');
    }

    function handleBannerClick() {
      const banner = document.getElementById('subscriptionBanner');
      const action = banner.dataset.action;
      if (action === 'upgrade') window.location.href = 'upgrade.html';
    }

    // -----------------------------
    // UI helpers
    // -----------------------------
    function addMessage(role, text, animate = true) {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      div.innerText = text;
      if (!animate) div.style.animation = 'none';
      const container = document.getElementById('chatContainer');
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function updateStats() {
      document.getElementById('hintCount').innerText = `${hintsUsed}/3`;
      document.getElementById('questionCount').innerText = String(questionsAsked);
    }

    function renderProblem() {
      if (!currentProblem) return;
      document.getElementById('problemText').innerText = currentProblem.problem_text || 'Mystery missing problem_text';
      document.getElementById('diffBadge').innerText = (currentProblem.difficulty || 'MEDIUM').toUpperCase();
      document.getElementById('catBadge').innerText = (currentProblem.category || 'LOGIC').toUpperCase();
      document.getElementById('probNum').innerText = '1';

      if (window.innerWidth <= 600) {
        document.getElementById('problemCard').classList.remove('minimized');
        document.getElementById('toggleBtn').innerText = "Hide Mystery üîº";
      }
    }

    function toggleProblem() {
      const card = document.getElementById('problemCard');
      const btn = document.getElementById('toggleBtn');
      const isHidden = card.classList.contains('minimized');

      if (isHidden) {
        card.classList.remove('minimized');
        btn.innerText = "Hide Mystery üîº";
      } else {
        card.classList.add('minimized');
        btn.innerText = "Show Mystery üîΩ";
      }
    }

    function startTimer() {
      if (timerInt) clearInterval(timerInt);
      timerInt = setInterval(() => {
        const diff = Math.floor((Date.now() - startTime) / 1000);
        const m = Math.floor(diff / 60).toString().padStart(2,'0');
        const s = (diff % 60).toString().padStart(2,'0');
        document.getElementById('timeDisplay').innerText = `${m}:${s}`;
      }, 1000);
    }

    function saveState() {
      const state = {
        problem: currentProblem,
        hints: hintsUsed,
        questions: questionsAsked,
        chat: chatLog,
        timeStart: startTime,
        track: TRACK
      };
      localStorage.setItem('lp_state', JSON.stringify(state));
    }

    function restoreState(state) {
      currentProblem = state.problem;
      hintsUsed = state.hints || 0;
      questionsAsked = state.questions || 0;
      chatLog = state.chat || [];
      startTime = state.timeStart || Date.now();

      renderProblem();
      updateStats();

      document.getElementById('chatContainer').innerHTML = '<div class="message system">Welcome back! I remembered where we left off. üß†</div>';
      chatLog.forEach(msg => {
        if (msg.role !== 'system') addMessage(msg.role === 'assistant' ? 'ai' : 'user', msg.content, false);
      });

      startTimer();
    }

    function clearStateAndExit() {
      localStorage.removeItem('lp_state');
      location.href = 'dashboard.html';
    }

    // -----------------------------
    // Core actions
    // -----------------------------
    async function loadNextPuzzle(clearMemory) {
      // subscription gate (if available)
      if (userSubscription && userSubscription.expired && window.SubscriptionGuard?.showUpgradeModal) {
        SubscriptionGuard.showUpgradeModal(
          'Your free trial has ended! Upgrade to continue solving unlimited problems.',
          'champion'
        );
        return;
      }

      if (clearMemory) localStorage.removeItem('lp_state');

      document.getElementById('successModal').style.display = 'none';
      document.getElementById('chatContainer').innerHTML = '<div class="message system">Hi! Ready to solve this? Read the mystery above! üëÜ</div>';
      document.getElementById('textInput').value = '';
      hintsUsed = 0;
      questionsAsked = 0;
      chatLog = [];
      updateStats();

      let puzzle = localPuzzles[0];

      // DB puzzle (best-effort). Enterprise: do not crash learn if DB query fails.
      try {
        const level = (TRACK === 'olympiad') ? 'olympiad' : 'regular';

        // NOTE: your schema may use different filter columns. This keeps your previous intent:
        // eq('is_active', true) and eq('olympiad_level', level)
        const { data, error } = await sb
          .from('problems')
          .select('*')
          .eq('is_active', true)
          .eq('olympiad_level', level);

        if (!error && data && data.length > 0) {
          puzzle = data[Math.floor(Math.random() * data.length)];
        }
      } catch (e) {
        console.warn('Problems fetch failed, using local puzzle:', e);
      }

      currentProblem = puzzle;
      startTime = Date.now();

      saveState();
      renderProblem();
      startTimer();
    }

    async function sendText() {
      const input = document.getElementById('textInput');
      const text = input.value.trim();
      if (!text || isProcessing) return;

      isProcessing = true;
      questionsAsked++;
      updateStats();

      document.getElementById('sendBtn').disabled = true;
      document.getElementById('typing').style.opacity = 1;

      addMessage('user', text);
      input.value = '';
      chatLog.push({ role: 'user', content: text });
      saveState();

      const cleanInput = text.toLowerCase().replace(/[^a-z0-9]/g, '');
      const answers = (currentProblem?.answer_key || currentProblem?.solution_explanation || "").toLowerCase().split('|');
      let isCorrect = false;

      if (cleanInput.length >= 1) {
        answers.forEach(a => {
          const cleanAns = a.toLowerCase().replace(/[^a-z0-9]/g, '');
          if (cleanAns.length > 0 && cleanInput.includes(cleanAns)) isCorrect = true;
        });
      }

      if (isCorrect) {
        finishPuzzle();
        isProcessing = false;
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('typing').style.opacity = 0;
        return;
      }

      try {
        const res = await fetch('/api/tutor', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            problem_text: currentProblem?.problem_text,
            solution_explanation: currentProblem?.solution_explanation,
            chatLog,
            track: TRACK
          })
        });

        let data = null;
        try { data = await res.json(); } catch {}
        const reply = (data && data.reply) ? data.reply : 'Sorry, something went wrong.';
        addMessage('ai', reply);
        chatLog.push({ role: 'assistant', content: reply });
        saveState();

        if ((reply.toLowerCase().includes('correct') || reply.includes('üéâ')) && cleanInput.length > 1) {
          finishPuzzle();
        }
      } catch(e) {
        console.error(e);
        addMessage('ai', 'Network error. Please try again.');
      }

      isProcessing = false;
      document.getElementById('sendBtn').disabled = false;
      document.getElementById('typing').style.opacity = 0;
      input.focus();
    }

    function finishPuzzle() {
      localStorage.removeItem('lp_state');
      addMessage('ai', "Correct! üéâ Amazing job!");
      try { confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); } catch {}

      document.getElementById('finalTime').innerText = document.getElementById('timeDisplay').innerText;
      document.getElementById('finalHints').innerText = hintsUsed;

      const cat = (currentProblem?.category || 'logic').toLowerCase();
      document.getElementById('learningInsight').innerHTML = `You practiced <b>${learningInsights[cat] || 'Critical Thinking'}</b>`;

      // Best-effort attempts logging
      if (currentChildId) {
        sb.from('attempts').insert([{
          child_id: currentChildId,
          problem_id: currentProblem?.id,
          solved_correctly: true,
          hints_used: hintsUsed
        }]).then(() => {}).catch(() => {});
      }

      setTimeout(() => { document.getElementById('successModal').style.display = 'flex'; }, 700);
    }

    function useHint() {
      if (hintsUsed >= 3) return;

      let hints = currentProblem?.hints;
      if (!hints || hints.length === 0) hints = ["Think carefully!", "Read the problem again."];

      const hint = hints[Math.min(hintsUsed, hints.length - 1)];
      addMessage('hint', `üí° HINT: ${hint}`);
      hintsUsed++;
      updateStats();
      saveState();
    }

    // -----------------------------
    // Microphone (speech) ‚Äì real toggle
    // -----------------------------
    let recognition = null;
    let isRecording = false;

    function ensureRecognizer() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return null;

      const r = new SR();
      r.lang = 'en-US';
      r.interimResults = false;
      r.maxAlternatives = 1;

      r.onstart = () => {
        isRecording = true;
        document.getElementById('micBtn').classList.add('recording');
      };
      r.onend = () => {
        isRecording = false;
        document.getElementById('micBtn').classList.remove('recording');
      };
      r.onerror = (e) => {
        console.warn('Speech error:', e);
        isRecording = false;
        document.getElementById('micBtn').classList.remove('recording');
      };
      r.onresult = (e) => {
        const transcript = e.results?.[0]?.[0]?.transcript || '';
        if (transcript.trim()) {
          document.getElementById('textInput').value = transcript.trim();
          sendText();
        }
      };
      return r;
    }

    function toggleRecording() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return alert("Voice input requires Chrome (SpeechRecognition).");

      if (!recognition) recognition = ensureRecognizer();
      if (!recognition) return alert("Voice input not supported on this device/browser.");

      try {
        if (isRecording) recognition.stop();
        else recognition.start();
      } catch (e) {
        console.warn('toggleRecording error:', e);
      }
    }

    // -----------------------------
    // Startup
    // -----------------------------
    window.addEventListener('load', async () => {
      try {
        // 1) ENV
        const env = await LP_getEnv();
        if (!env?.SUPABASE_URL || !env?.SUPABASE_ANON_KEY) {
          return LP_showFatal('Missing Supabase config. Ensure /api/env returns SUPABASE_URL & SUPABASE_ANON_KEY.');
        }
        SB_URL = env.SUPABASE_URL;
        SB_KEY = env.SUPABASE_ANON_KEY;

        // 2) Supabase client
        sb = supabase.createClient(SB_URL, SB_KEY, { auth: { persistSession: true } });

        // 3) Load subscription guard AFTER Supabase exists
        try {
          await LP_loadScript('/assets/js/subscription-guard.js');
        } catch (e) {
          console.warn(e);
          showSubscriptionBanner('error');
        }

        // 4) Login gate (if guard exists)
        if (window.SubscriptionGuard?.requireLogin) {
          const loggedIn = await SubscriptionGuard.requireLogin();
          if (!loggedIn) return;

          // optional subscription state
          try {
            userSubscription = await SubscriptionGuard.getUserSubscription();
            if (userSubscription?.expired) {
              showSubscriptionBanner('expired');
            } else if (userSubscription?.tier === 'free_trial' && SubscriptionGuard.getUserTierInfo) {
              const tierInfo = await SubscriptionGuard.getUserTierInfo();
              if (tierInfo?.daysRemaining <= 3) showSubscriptionBanner('trial_ending', tierInfo.daysRemaining);
            }
          } catch (e) {
            console.warn('Subscription lookup failed:', e);
            showSubscriptionBanner('error');
          }
        }

        // 5) child_id best-effort
        try {
          const { data: { session } } = await sb.auth.getSession();
          if (session?.user?.id) {
            const { data: child } = await sb.from('children').select('id').eq('parent_id', session.user.id).single();
            if (child?.id) currentChildId = child.id;
          }
        } catch {}

        // 6) responsive UI
        if (window.innerWidth > 600) {
          document.getElementById('toggleBtn').style.display = 'none';
        } else {
          document.getElementById('problemCard').classList.add('minimized');
        }

        // 7) state restore
        const savedStateRaw = localStorage.getItem('lp_state');
        if (savedStateRaw) {
          const parsed = JSON.parse(savedStateRaw);
          // if track changed, ignore old state
          if (parsed?.track && parsed.track !== TRACK) {
            localStorage.removeItem('lp_state');
            await loadNextPuzzle(false);
          } else {
            restoreState(parsed);
          }
        } else {
          await loadNextPuzzle(false);
        }

        // 8) enter-to-send
        document.getElementById('textInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') sendText();
        });

      } catch (e) {
        console.error(e);
        LP_showFatal('Learn failed to start: ' + (e?.message || String(e)));
      }
    });
  </script>
</body>
</html>