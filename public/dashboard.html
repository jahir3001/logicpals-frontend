<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LogicPals â€” Regular Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --primary:#6c5ce7; --accent:#feca57;
      --text:#f0f0f5; --muted:#5d5f7e; --text2:#9899b3;
      --bg:#0c0e1a; --card:rgba(20,24,52,.55); --border:rgba(255,255,255,.06);
      --good:#00d2a0; --bad:#ff6b6b;
      --shadow: 0 8px 40px rgba(0,0,0,.2);
      --radius:20px; --radius2:14px; --max:1100px; --tap:44px;
      --font:'Plus Jakarta Sans',-apple-system,sans-serif;
      --font-d:'Outfit',-apple-system,sans-serif;
      --glow:rgba(108,92,231,.35); --glow2:rgba(0,210,160,.25);
      --as:rgba(108,92,231,.12); --ys:rgba(254,202,87,.10);
    }
    *{box-sizing:border-box;}html,body{height:100%;}
    body{margin:0;font-family:var(--font);color:var(--text);background:var(--bg);-webkit-font-smoothing:antialiased;}
    body::before{content:'';position:fixed;top:-200px;left:-100px;width:600px;height:600px;background:radial-gradient(circle,var(--glow) 0%,transparent 70%);pointer-events:none;z-index:0;animation:drift 20s ease-in-out infinite alternate;}
    body::after{content:'';position:fixed;bottom:-200px;right:-100px;width:500px;height:500px;background:radial-gradient(circle,var(--glow2) 0%,transparent 70%);pointer-events:none;z-index:0;animation:drift 25s ease-in-out infinite alternate-reverse;}
    @keyframes drift{0%{transform:translate(0,0);}100%{transform:translate(60px,40px);}}
    a{color:inherit;text-decoration:none;}button{font:inherit;}

    .wrap{max-width:var(--max);margin:0 auto;padding:88px 16px 40px;position:relative;z-index:1;}
    .topbar{position:fixed;top:0;left:0;right:0;z-index:50;background:rgba(12,14,26,.75);backdrop-filter:blur(24px) saturate(1.6);border-bottom:1px solid var(--border);}
    .topbar-inner{max-width:var(--max);margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px;}
    .brand{display:flex;align-items:center;gap:10px;min-width:140px;}
    .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--primary),#a29bfe);box-shadow:0 4px 20px var(--glow);display:grid;place-items:center;color:#fff;font-weight:800;font-size:13px;}
    .brand-title{line-height:1.1;}.brand-title b{display:block;font-size:15px;font-weight:800;}.brand-title span{display:block;font-size:11px;color:var(--muted);font-weight:500;margin-top:1px;}
    .center-pill{flex:1;display:flex;justify-content:center;}
    .track-pill{display:inline-flex;align-items:center;gap:8px;padding:7px 14px;border-radius:100px;background:var(--as);border:1px solid rgba(108,92,231,.2);color:#b8b0f0;font-weight:700;font-size:12px;}
    .track-dot{width:8px;height:8px;border-radius:50%;background:var(--primary);box-shadow:0 0 8px var(--glow);animation:pdot 2s ease-in-out infinite;}
    @keyframes pdot{0%,100%{box-shadow:0 0 4px var(--glow);}50%{box-shadow:0 0 14px var(--glow);}}
    .actions{display:flex;gap:8px;align-items:center;min-width:140px;justify-content:flex-end;}

    .btn{height:var(--tap);border-radius:10px;border:1px solid var(--border);background:var(--card);backdrop-filter:blur(8px);padding:0 14px;display:inline-flex;align-items:center;gap:8px;cursor:pointer;color:var(--text2);font-weight:600;font-size:13px;transition:all .15s ease;}
    .btn:hover{background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.1);color:var(--text);}
    .btn:active{transform:scale(.97);}
    .btn-primary{background:linear-gradient(135deg,var(--primary),#8b7cf6);border:none;color:#fff;font-weight:700;box-shadow:0 4px 20px var(--glow),inset 0 1px 0 rgba(255,255,255,.15);}
    .btn-primary:hover{box-shadow:0 6px 28px var(--glow);transform:translateY(-1px);}
    .btn-accent{background:var(--ys);border:1px solid rgba(254,202,87,.2);color:var(--accent);font-weight:700;}
    .btn-accent:hover{background:rgba(254,202,87,.16);}
    .btn-ghost{background:transparent;border:1px solid transparent;color:var(--muted);}
    .btn-ghost:hover{color:var(--text2);background:rgba(255,255,255,.04);}
    .btn-secondary{background:var(--as);border:1px solid rgba(108,92,231,.2);color:#b8b0f0;font-weight:700;}
    .btn-secondary:hover{background:rgba(108,92,231,.18);}
    .btn-wide{padding:0 20px;height:48px;border-radius:var(--radius2);font-size:14px;}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}

    .status-strip{max-width:var(--max);margin:0 auto;padding:0 16px 8px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;font-size:12px;color:var(--text2);}
    .badge{display:inline-flex;align-items:center;gap:7px;padding:5px 12px;border-radius:100px;background:var(--card);border:1px solid var(--border);color:var(--text2);font-size:11px;font-weight:600;}
    .badge b{color:var(--muted);font-weight:600;font-size:11px;}
    .chip-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
    .dot-good{background:var(--good);box-shadow:0 0 8px var(--glow2);}
    .dot-warn{background:var(--accent);box-shadow:0 0 8px rgba(254,202,87,.25);}
    .dot-bad{background:var(--bad);box-shadow:0 0 10px rgba(255,107,107,.35);}

    .grid{display:grid;grid-template-columns:1fr;gap:16px;}
    @media(min-width:860px){.grid{grid-template-columns:1.3fr .7fr;align-items:start;}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);backdrop-filter:blur(16px);overflow:hidden;}
    .hero{padding:28px 24px 24px;position:relative;overflow:hidden;background:linear-gradient(145deg,rgba(108,92,231,.08),rgba(0,210,160,.04));}
    .hero-top{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;position:relative;z-index:1;}
    .hello{font-size:14px;color:var(--muted);font-weight:600;}
    .hero-head{margin-top:6px;font-family:var(--font-d);font-size:24px;font-weight:800;letter-spacing:-.5px;line-height:1.2;background:linear-gradient(135deg,var(--text) 40%,#b8b0f0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    .hero-focus{margin-top:16px;display:flex;flex-wrap:wrap;gap:8px;position:relative;z-index:1;}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:100px;background:var(--card);border:1px solid var(--border);font-size:12px;font-weight:600;color:var(--text2);}
    .pill strong{color:var(--primary);font-weight:700;}
    .ring{width:68px;height:68px;border-radius:999px;display:grid;place-items:center;background:conic-gradient(var(--primary) var(--p,40%),rgba(255,255,255,.06) 0);box-shadow:0 0 20px var(--glow);position:relative;z-index:1;}
    .ring > div{width:54px;height:54px;border-radius:999px;background:rgba(12,14,26,.9);display:grid;place-items:center;font-family:var(--font-d);font-weight:800;font-size:14px;color:#b8b0f0;border:1px solid var(--border);}
    .hero-actions{margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;position:relative;z-index:1;}

    .tiles{padding:16px 22px 22px;}
    .tile-row{display:flex;gap:10px;overflow:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;padding-bottom:4px;}
    .tile-row::-webkit-scrollbar{display:none;}
    @media(min-width:860px){.tile-row{display:grid;grid-template-columns:repeat(3,1fr);overflow:visible;}}
    .tile{min-width:150px;flex:0 0 auto;scroll-snap-align:start;padding:16px;border-radius:var(--radius2);background:rgba(255,255,255,.03);border:1px solid var(--border);}
    .tile .k{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;}
    .tile .v{margin-top:8px;font-family:var(--font-d);font-size:28px;font-weight:800;letter-spacing:-.5px;}
    .tile .d{margin-top:8px;font-size:12px;color:var(--muted);display:flex;gap:6px;align-items:center;}
    .mini{width:20px;height:20px;border-radius:7px;display:grid;place-items:center;font-size:11px;background:var(--ys);border:1px solid rgba(254,202,87,.15);}

    .notice{padding:20px 22px;border-radius:var(--radius);background:var(--card);border:1px solid var(--border);font-size:14px;color:var(--muted);line-height:1.5;}
    .notice b{color:var(--text);display:block;margin-bottom:6px;}
    .foot{margin-top:24px;color:var(--muted);font-size:11px;text-align:center;padding:12px;}

    .modal-backdrop{position:fixed;inset:0;background:rgba(8,10,22,.7);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;padding:20px;z-index:100;}
    .modal{width:min(520px,96vw);border-radius:var(--radius);background:rgba(20,24,52,.85);backdrop-filter:blur(24px);border:1px solid var(--border);box-shadow:0 24px 64px rgba(0,0,0,.4);overflow:hidden;}
    .modal-h{padding:22px 22px 0;display:flex;justify-content:space-between;align-items:flex-start;gap:12px;}
    .modal-h b{font-family:var(--font-d);font-size:17px;font-weight:700;}
    .modal-h button{width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--muted);cursor:pointer;font-weight:700;display:grid;place-items:center;}
    .modal-b{padding:14px 22px 22px;color:var(--muted);font-size:14px;line-height:1.5;}
    .modal-actions{margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand"><div class="logo">LP</div><div class="brand-title"><b>LogicPals</b><span>Student Dashboard</span></div></div>
      <div class="center-pill"><div class="track-pill"><span class="track-dot"></span>Regular Practice</div></div>
      <div class="actions">
        <button id="btnOlympiad" class="btn btn-accent" type="button"><span>Olympiad</span><span id="olympiadState">ðŸ”’</span></button>
        <button id="btnSignOut" class="btn btn-ghost" type="button" disabled>Sign out</button>
      </div>
    </div>
    <div class="status-strip">
      <div class="status-left">
        <span class="badge" id="planBadge"><span class="chip-dot dot-warn" id="planDot"></span><b>Session:</b> <span id="planText">Bootingâ€¦</span></span>
      </div>
      <div class="status-right"><span class="badge"><b>Updated:</b> <span id="updatedText">â€”</span></span></div>
    </div>
  </div>

  <main class="wrap">
    <div id="authNotice" class="notice" style="display:none;">
      <b>Sign-in required.</b> We couldn't find your session.
      <div style="margin-top:12px;"><button class="btn btn-primary btn-wide" id="btnGoLogin" type="button">Go to Login</button></div>
    </div>

    <div id="content" style="display:none;">
      <div class="grid">
        <section class="card">
          <div class="hero">
            <div class="hero-top">
              <div>
                <div class="hello" id="helloText">Hi ðŸ‘‹</div>
                <div class="hero-head">Continue your Regular Practice</div>
                <div class="hero-focus">
                  <span class="pill"><strong>Next:</strong> <span id="heroMinutes">10</span> min</span>
                  <span class="pill">Focus: <span id="heroFocusLabel">â€”</span></span>
                </div>
              </div>
              <div class="ring" id="goalRing" style="--p:0%;"><div><span id="goalPct">0%</span></div></div>
            </div>
            <div class="hero-actions">
              <button id="btnStart" class="btn btn-primary btn-wide" type="button">Start now</button>
              <button id="btnPickTopic" class="btn btn-secondary btn-wide" type="button">Choose topic</button>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="tiles">
            <div class="tile-row">
              <div class="tile"><div class="k">Problems solved</div><div class="v" id="kpiSolved">â€”</div><div class="d"><span class="mini">ðŸ”¥</span> Total</div></div>
              <div class="tile"><div class="k">Accuracy</div><div class="v" id="kpiAccuracy">â€”</div><div class="d"><span class="mini">âœ“</span> Last 7 days</div></div>
              <div class="tile"><div class="k">Hints used</div><div class="v" id="kpiHints">â€”</div><div class="d"><span class="mini">ðŸ’¡</span> Avg</div></div>
            </div>
          </div>
        </section>
      </div>

      <div class="foot">Regular dashboard Â· Track boundary enforced Â· No Olympiad data loaded</div>
    </div>
  </main>

  <div class="modal-backdrop" id="olymModal">
    <div class="modal">
      <div class="modal-h">
        <div><b>Olympiad Track</b><div class="sub">A separate advanced track.</div></div>
        <button type="button" id="closeOlymp">âœ•</button>
      </div>
      <div class="modal-b">
        <p id="olymModalBody">Olympiad is a separate advanced track. Upgrade to unlock it.</p>
        <div class="modal-actions">
          <a class="btn btn-primary btn-wide" href="subscriptions.html">View plans</a>
          <button class="btn btn-ghost btn-wide" id="olymCancelBtn" type="button">Not now</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';

  const STORAGE_KEY = 'logicpals.auth';
  const ENV_ENDPOINT = '/api/env';
  const LOGIN_URL = '/login.html?next=' + encodeURIComponent('/dashboard.html');

  const $ = (id)=>document.getElementById(id);
  const planText = $('planText');
  const planDot = $('planDot');

  let sb = null;

  function setStatus(state, msg){
    planText.textContent = msg;
    planDot.classList.remove('dot-good','dot-warn','dot-bad');
    planDot.classList.add(state === 'good' ? 'dot-good' : state === 'bad' ? 'dot-bad' : 'dot-warn');
  }

  function hardClearAuthStorage(){
    try{
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(STORAGE_KEY + '-code-verifier');
      localStorage.removeItem(STORAGE_KEY + '-provider-token');
      localStorage.removeItem(STORAGE_KEY + '-provider-refresh-token');
    }catch(_){}
  }

  async function fetchEnv(){
    const res = await fetch(ENV_ENDPOINT, { cache:'no-store' });
    if(!res.ok) throw new Error('ENV_ENDPOINT failed: ' + res.status);
    const data = await res.json();
    const supabaseUrl = data.supabaseUrl || data.SUPABASE_URL || data.url;
    const supabaseAnonKey = data.supabaseAnonKey || data.SUPABASE_ANON_KEY || data.anonKey;
    if(!supabaseUrl || !supabaseAnonKey) throw new Error('Missing Supabase config from ' + ENV_ENDPOINT);
    return { supabaseUrl, supabaseAnonKey };
  }

  async function init(){
    setStatus('warn', 'Checking sessionâ€¦');

    let env;
    try{
      env = await fetchEnv();
    }catch(e){
      setStatus('bad', 'Config missing');
      $('authNotice').style.display = 'block';
      $('content').style.display = 'none';
      return;
    }

    sb = window.supabase.createClient(env.supabaseUrl, env.supabaseAnonKey, {
      auth: { storageKey: STORAGE_KEY, persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
    });

    const { data:{ session }, error } = await sb.auth.getSession();
    if(error){
      setStatus('bad', 'Session error');
      $('authNotice').style.display = 'block';
      $('content').style.display = 'none';
      return;
    }

    if(!session){
      setStatus('bad', 'Signed out');
      $('authNotice').style.display = 'block';
      $('content').style.display = 'none';
      return;
    }

    setStatus('good', 'Signed in');
    $('authNotice').style.display = 'none';
    $('content').style.display = 'block';
    $('btnSignOut').disabled = false;

    const user = session.user;
    const userName = (user.user_metadata && (user.user_metadata.full_name || user.user_metadata.name)) || (user.email ? user.email.split('@')[0] : 'there');
    $('helloText').textContent = 'Hi ' + userName + ' ðŸ‘‹';
    $('updatedText').textContent = 'just now';

    $('btnSignOut').addEventListener('click', async ()=>{
      $('btnSignOut').disabled = true;
      setStatus('warn', 'Signing outâ€¦');
      try{ await sb.auth.signOut({ scope:'global' }); }catch(_){}
      hardClearAuthStorage();
      location.replace('/index.html');
    });

    sb.auth.onAuthStateChange((evt, s)=>{
      if(evt === 'SIGNED_OUT' || !s){
        hardClearAuthStorage();
        location.replace('/index.html');
      }
    });

    $('btnStart').addEventListener('click', ()=> location.assign('/learn.html?track=regular'));
    $('btnPickTopic').addEventListener('click', ()=> location.assign('/learn.html?track=regular'));
  }

  $('btnGoLogin').addEventListener('click', ()=> location.assign(LOGIN_URL));

  $('btnOlympiad').addEventListener('click', ()=> $('olymModal').style.display = 'flex');
  $('closeOlymp').addEventListener('click', ()=> $('olymModal').style.display = 'none');
  $('olymCancelBtn').addEventListener('click', ()=> $('olymModal').style.display = 'none');
  $('olymModal').addEventListener('click', (e)=>{ if(e.target.id==='olymModal') $('olymModal').style.display='none'; });

  window.addEventListener('pageshow', (e)=>{ if(e.persisted) location.reload(); });

  init();
})();
</script>
</body>
</html>
