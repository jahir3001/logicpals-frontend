<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LogicPals — Student Dashboard</title>

  <!-- Keep your existing CSS as-is if you had it -->

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <!-- Keep your existing dashboard HTML layout as-is.
       This patch focuses on auth/session + fixing the missing script dependency. -->

  <!-- If you already have header buttons, this "Back to Admin" will appear only for admin accounts -->
  <a id="backToAdmin" href="/admin.html" style="display:none; position:fixed; top:12px; right:12px; z-index:9999; padding:10px 14px; border-radius:10px; background:#ffffffcc; border:1px solid #ddd; font-weight:600; text-decoration:none;">
    Back to Admin
  </a>

  <script>
    (function () {
      let sb = null;

      async function getEnv() {
        try {
          const res = await fetch('/api/env?ts=' + Date.now(), { cache: 'no-store' });
          if (!res.ok) throw new Error('env_http_' + res.status);
          return await res.json();
        } catch (e) {
          return null;
        }
      }

      async function initSupabase() {
        const env = await getEnv();
        if (!env || !env.SUPABASE_URL || !env.SUPABASE_ANON_KEY) {
          console.error('Missing Supabase config. Ensure /api/env is deployed and reachable.');
          return null;
        }
        const SB_URL = env.SUPABASE_URL;
        const SB_KEY = env.SUPABASE_ANON_KEY;

        // Standard client config (shared across pages)
        sb = supabase.createClient(
          SB_URL,
          SB_KEY,
          { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
        );
        return sb;
      }

      // LP_SESSION_MIGRATION (enterprise): accept sessions stored under legacy keys and/or other pages.
      async function maybeMigrateLegacySession(legacyKey){
        try{
          const raw = localStorage.getItem(legacyKey);
          if(!raw) return false;
          const data = JSON.parse(raw);
          if(!data?.access_token || !data?.refresh_token) return false;
          await sb.auth.setSession({ access_token: data.access_token, refresh_token: data.refresh_token });
          // Remove legacy key to avoid split-brain sessions.
          localStorage.removeItem(legacyKey);
          return true;
        }catch(e){ return false; }
      }

      // Minimal guard (replaces external /subscription-guard.js to avoid 404 + broken auth).
      // Contract: returns true if logged in, else false (does NOT silently auto-login).
      const SubscriptionGuard = {
        async requireLogin(){
          const s = (await sb.auth.getSession()).data.session;
          if(s) return true;

          // Migrate legacy keys used by older builds/pages
          await maybeMigrateLegacySession('lp_auth');
          await maybeMigrateLegacySession('lp_admin_auth');

          const s2 = (await sb.auth.getSession()).data.session;
          return !!s2;
        }
      };

      async function showAdminLinkIfAdmin() {
        try{
          const { data: roleVal } = await sb.rpc('get_my_role');
          const r = (roleVal || '').toString();
          if(r.includes('admin') || r === 'super_admin'){
            const el = document.getElementById('backToAdmin');
            if(el) el.style.display = 'inline-block';
          }
        }catch(e){}
      }

      async function boot() {
        await initSupabase();
        if (!sb) return;

        // Require login (but do not silently auto-login)
        const ok = await SubscriptionGuard.requireLogin();
        if (!ok) {
          // Keep your current “Go to Login” UX.
          // If your existing HTML already shows that state, do nothing.
          // If not, you can redirect:
          // window.location.href = '/login.html';
          return;
        }

        // If logged in, show admin link for admin users.
        await showAdminLinkIfAdmin();

        // Continue with your existing dashboard initialization logic below.
        // If your current dashboard already has its own boot code, keep it.
        // This patch only ensures session exists.
      }

      boot();
    })();
  </script>
</body>
</html>