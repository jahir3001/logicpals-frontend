<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LogicPals Admin — Payments</title>

  
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--accent:#4f46e5;--accent2:#06b6d4;--good:#16a34a;--warn:#b45309;--bad:#dc2626;--shadow:0 18px 45px rgba(2,6,23,.08);--r:18px}
    *{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--text);background:linear-gradient(180deg,#ffffff 0%, #f6f7fb 100%)}
    a{color:inherit;text-decoration:none}
    .shell{max-width:1200px;margin:28px auto;padding:0 18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;background:var(--card);border:1px solid var(--line);border-radius:22px;padding:14px 16px;box-shadow:var(--shadow)}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:grid;place-items:center;color:#fff;font-weight:800}
    .bt{font-size:14px;font-weight:800;margin:0}.st{font-size:12px;color:var(--muted);margin:0}
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;font-size:13px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:999px;background:#94a3b8}
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    .h{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .h h2{margin:0;font-size:18px}.hint{color:var(--muted);font-size:13px}
    .form{display:grid;grid-template-columns:1.3fr .7fr;gap:12px;margin-top:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted);font-weight:700}
    input,select{border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;outline:none}
    textarea{border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:13px;min-height:160px;resize:vertical;outline:none;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .note{margin-top:8px;font-size:12px;color:var(--muted)}
    @media (max-width:900px){.form{grid-template-columns:1fr}}

/* === Enterprise auth UI states (injected) === */
.pill.is-ready, .chip.is-ready { border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.08); }
.pill.is-loading, .chip.is-loading { border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.08); }
.pill.is-error, .chip.is-error { border-color: rgba(225,29,72,.35); background: rgba(225,29,72,.08); }
.dot.err, .statusDot.err { background: #e11d48 !important; }
#loginMsg.msgErr { color: #e11d48; }
#loginMsg.msgOk { color: #16a34a; }
#loginMsg.msgInfo { color: #64748b; }
/* DOM warning cleanup (not required, but nicer) */
dialog form { margin: 0; }
</style>
  <script src="/assets/js/env-loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="shell">
    <header class="top">
      <div class="brand">
        <div class="logo">LP</div>
        <div>
          <p class="bt">Payments</p>
          <p class="st">Admin-only — list / refund / reconcile (RPC-only)</p>
        </div>
      </div>
      <div class="right">
        <span class="pill" id="status"><span class="dot" id="dot"></span><span id="statusTxt">Loading…</span></span>
        <a class="btn" href="/admin.html">Back to Admin</a>
        <button class="btn primary" id="btnSignIn">Sign in</button>
        <button class="btn" id="btnSignOut" style="display:none">Sign out</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="h">
          <h2>Payment Operations</h2>
          <div class="hint" id="who"></div>
        </div>

        <div class="form">
          <div class="field">
            <label>Customer email</label>
            <input id="email" placeholder="student_or_parent@email.com" autocomplete="email" />
          </div>
          <div class="field">
            <label>Track</label>
            <select id="track">
              <option value="regular">Regular</option>
              <option value="olympiad">Olympiad</option>
            </select>
          </div>

          <div class="field">
            <label>Action</label>
            <select id="action">
              <option value="list">List payments</option>
              <option value="refund">Refund payment</option>
              <option value="reconcile">Reconcile payment</option>
            </select>
          </div>
          <div class="field">
            <label>Reference (receipt/txn id)</label>
            <input id="ref" placeholder="optional" />
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="run">Run</button>
          <button class="btn" id="trust">Load trust summary</button>
        </div>

        <p class="note">Expected RPCs: <code>admin_list_payments</code>, <code>admin_refund_payment</code>, <code>admin_reconcile_payment</code>, <code>admin_trust_summary</code>. (If your function names differ, tell me and I will wire them.)</p>
      </section>

      <section class="card">
        <div class="h"><h2>Output</h2><div class="hint">RPC responses + errors</div></div>
        <textarea id="out" readonly>Waiting…</textarea>
      </section>
    </div>
  </div>

  <dialog id="dlg" style="border:none;border-radius:16px;max-width:420px;width:calc(100% - 24px);padding:0;box-shadow:0 20px 70px rgba(2,6,23,.25)">
    <form method="dialog" style="padding:16px 16px 14px;background:#fff;border:1px solid var(--line);border-radius:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div style="font-weight:900">Admin sign in</div>
        <button class="btn" value="cancel">✕</button>
      </div>
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
        <div class="field"><label>Email</label><input id="lgEmail" type="email" autocomplete="email" required placeholder="admin@email.com"/></div>
        <div class="field"><label>Password</label><input id="lgPass" type="password" autocomplete="current-password" required /></div>
        <button class="btn primary" id="doLogin" value="default">Sign in</button>
        <div class="hint" id="authOut"></div>
      </div>
    </form>
  </dialog>

  <script>
(() => {
  'use strict';

  const ADMIN_ALLOWED = new Set(['super_admin','admin','admin_regular','admin_olympiad']);
  const ROLE_RPC_CANDIDATES = [
    'get_my_role',
    'rpc_lp_my_role',
    'admin_get_my_role',
    'admin_get_role',
    'rp_admin_get_role',
    'current_role'
  ];
  const AUTH_STORAGE_KEY = 'lp_admin_auth_v1';

  const $ = (id) => document.getElementById(id);
  const pick = (...ids) => ids.map($).find(Boolean) || null;

  const elStatus = pick('status','chipStatus');
  const elDot = pick('dot','statusDot');
  const elStatusTxt = pick('statusTxt','statusText');

  const btnSignIn = pick('btnSignIn');
  const btnSignOut = pick('btnSignOut','btnTopLogout');

  const who = pick('who','signedIn');
  const role = pick('role','kvRole');

  const inEmail = pick('email','inEmail');
  const inTrack = pick('track','inTrack');
  const inAction = pick('action','inAction');
  const inRef = pick('ref','inRef');

  const btnRun = pick('run','btnRun');
  const out = pick('out');

  // Optional login dialog on this page (kept for backward-compat)
  const dlg = pick('dlg');
  const lgEmail = pick('lgEmail');
  const lgPass = pick('lgPass');
  const doLoginBtn = pick('doLogin');
  const authOut = pick('authOut');

  let supa = null;
  let env = null;

  function setStatus(state, text) {
    elStatus?.classList.remove('is-ready','is-loading','is-error');
    elDot?.classList.remove('ok','warn','err');
    if (state === 'ready') { elStatus?.classList.add('is-ready'); elDot?.classList.add('ok'); }
    else if (state === 'error') { elStatus?.classList.add('is-error'); elDot?.classList.add('err'); }
    else { elStatus?.classList.add('is-loading'); elDot?.classList.add('warn'); }
    if (elStatusTxt) elStatusTxt.textContent = text;
  }

  function writeOut(x) {
    if (!out) return;
    out.textContent = (typeof x === 'string') ? x : JSON.stringify(x, null, 2);
  }

  async function fetchEnv() {
    const res = await fetch('/api/env', { cache: 'no-store' });
    if (!res.ok) throw new Error(`env_fetch_failed_${res.status}`);
    const j = await res.json();
    const url = j.supabase_url || j.SUPABASE_URL || j.NEXT_PUBLIC_SUPABASE_URL;
    const anon = j.supabase_anon_key || j.SUPABASE_ANON_KEY || j.NEXT_PUBLIC_SUPABASE_ANON_KEY;
    if (!url || !anon) throw new Error('env_missing_supabase');
    return { url, anon };
  }

  function createSupabaseClient() {
    if (!window.supabase || !window.supabase.createClient) throw new Error('supabase_js_missing');
    if (!env) throw new Error('env_not_loaded');
    if (supa) return supa;
    supa = window.supabase.createClient(env.url, env.anon, {
      auth: {
        storageKey: AUTH_STORAGE_KEY,
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: false,
        lock: false,
      },
      global: { headers: { 'X-Client-Info': 'logicpals-admin-static' } }
    });
    return supa;
  }

  async function rpcTryGetRole() {
    for (const fn of ROLE_RPC_CANDIDATES) {
      try {
        const { data, error } = await supa.rpc(fn, {});
        if (error) continue;
        if (typeof data === 'string') return data;
        if (data && typeof data === 'object') {
          if (typeof data.role === 'string') return data.role;
          if (typeof data.current_role === 'string') return data.current_role;
        }
      } catch (_) {}
    }
    return null;
  }

  async function ensureAdmin() {
    const { data: { session } } = await supa.auth.getSession();
    if (!session) {
      setStatus('error', 'Sign-in required');
      btnSignOut && (btnSignOut.style.display = 'none');
      btnSignIn && (btnSignIn.style.display = 'inline-flex');
      if (who) who.textContent = '—';
      if (role) role.textContent = 'signed_out';
      writeOut('Not signed in. Use the Admin Console to sign in.');
      return false;
    }

    const email = session.user?.email || '—';
    if (who) who.textContent = email;

    const roleVal = await rpcTryGetRole();
    if (!roleVal) {
      setStatus('error', 'Role RPC missing');
      if (role) role.textContent = 'unknown';
      writeOut('Role verification RPC missing. Create public.get_my_role() then reload.');
      return false;
    }

    const roleStr = String(roleVal);
    if (role) role.textContent = roleStr;

    if (!ADMIN_ALLOWED.has(roleStr)) {
      setStatus('error', 'Not authorized');
      writeOut(`Your role "${roleStr}" is not allowed. Redirecting…`);
      try { await supa.auth.signOut(); } catch (_) {}
      setTimeout(() => (window.location.href = '/admin.html'), 500);
      return false;
    }

    setStatus('ready', 'Ready');
    btnSignIn && (btnSignIn.style.display = 'none');
    btnSignOut && (btnSignOut.style.display = 'inline-flex');
    return true;
  }

  async function doSignOut() {
    setStatus('loading', 'Signing out…');
    try { await supa.auth.signOut(); } catch (_) {}
    window.location.href = '/admin.html';
  }

  async function doLoginInline() {
    // Optional inline login (kept if you still want it)
    const email = (lgEmail?.value || '').trim();
    const password = (lgPass?.value || '').trim();
    if (!email || !password) { authOut && (authOut.textContent = 'Email + password required.'); return; }
    authOut && (authOut.textContent = 'Signing in…');
    const { error } = await supa.auth.signInWithPassword({ email, password });
    if (error) { authOut && (authOut.textContent = error.message); return; }
    authOut && (authOut.textContent = 'Signed in.');
    dlg?.close?.();
    await ensureAdmin();
  }

  async function runRpc() {
    setStatus('loading', 'Running…');
    writeOut('Waiting…');

    if (!(await ensureAdmin())) return;

    const email = (inEmail?.value || '').trim() || null;
    const track = (inTrack?.value || '').trim() || null; // regular/olympiad
    const action = (inAction?.value || '').trim();        // list/refund/reconcile
    const reference = (inRef?.value || '').trim() || null;

    let fn = null;
    if (action === 'list') fn = 'admin_list_payments';
    if (action === 'refund') fn = 'admin_refund_payment';
    if (action === 'reconcile') fn = 'admin_reconcile_payment';

    if (!fn) { setStatus('error', 'Bad action'); writeOut('Invalid action.'); return; }

    const payload = { p_email: email, p_track: track, p_reference: reference };
    const { data, error } = await supa.rpc(fn, payload);

    if (error) {
      setStatus('error', 'RPC error');
      writeOut({ rpc: fn, payload, error });
      return;
    }

    setStatus('ready', 'Ready');
    writeOut({ rpc: fn, payload, data });
  }

  function wire() {
    btnSignIn?.addEventListener('click', () => (window.location.href = '/admin.html'));
    btnSignOut?.addEventListener('click', (e) => { e.preventDefault(); doSignOut(); });
    btnRun?.addEventListener('click', (e) => { e.preventDefault(); runRpc(); });

    // optional inline login dialog
    $('btnOpenLogin')?.addEventListener('click', () => dlg?.showModal?.());
    doLoginBtn?.addEventListener('click', (e) => { e.preventDefault(); doLoginInline(); });

    inTrack && (inTrack.value = inTrack.value || 'regular');
  }

  async function boot() {
    try {
      setStatus('loading', 'Loading…');
      env = await fetchEnv();
      createSupabaseClient();
      wire();
      await ensureAdmin();
    } catch (err) {
      console.error(err);
      setStatus('error', 'Boot error');
      writeOut(String(err?.message || err));
    }
  }

  boot();
})();
</script>
</body>
</html>
