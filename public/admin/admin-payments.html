<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LogicPals Admin — Payments</title>
  <style>
    :root{--bg:#f5f7ff;--card:#fff;--muted:#6b7280;--pri:#4f46e5;--danger:#ef4444;--ok:#10b981;--warn:#f59e0b;}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;background:var(--card);border-radius:18px;padding:14px 16px;box-shadow:0 10px 30px rgba(0,0,0,.06);}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#6d28d9,#4f46e5);display:grid;place-items:center;color:#fff;font-weight:800}
    h1{font-size:16px;margin:0}
    .sub{margin:2px 0 0;color:var(--muted);font-size:12px}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{font-size:12px;color:var(--muted);border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;background:#fff;display:flex;align-items:center;gap:8px}
    .dot{width:8px;height:8px;border-radius:50%}
    .btn{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--pri);border-color:var(--pri);color:#fff}
    .btn.danger{border-color:#fecaca;color:var(--danger)}
    .grid{margin-top:16px;display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:var(--card);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);}
    .banner{border-radius:14px;padding:12px 12px;border:1px solid #e5e7eb;background:#f9fafb;font-size:13px;display:none}
    .banner.ok{border-color:#bbf7d0;background:#f0fdf4}
    .banner.warn{border-color:#fde68a;background:#fffbeb}
    .banner.bad{border-color:#fecaca;background:#fef2f2}
    .kv{display:flex;gap:14px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .form{display:grid;grid-template-columns: 1.2fr .8fr;gap:12px;margin-top:12px}
    @media (max-width:900px){.form{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted)}
    input,select{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-size:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .out{margin-top:14px;border:1px dashed #e5e7eb;border-radius:16px;padding:12px;background:#fafafa;min-height:90px}
    pre{margin:0;white-space:pre-wrap;word-break:break-word;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">LP</div>
        <div>
          <h1>Payments</h1>
          <div class="sub">Admin-only — list / refund / reconcile (RPC-only)</div>
        </div>
      </div>
      <div class="actions">
        <div id="bootPill" class="pill"><span class="dot" id="bootDot" style="background:#9ca3af"></span><span id="bootText">Loading…</span></div>
        <button class="btn" id="btnBack">Back to Admin</button>
        <button class="btn danger" id="btnOut">Sign out</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="kv">
          <div>Signed in: <b id="who">—</b></div>
          <div>Role: <b id="role">unknown</b></div>
        </div>

        <div id="alert" class="banner warn"></div>

        <div class="form">
          <div>
            <label>Customer email</label>
            <input id="customer_email" placeholder="student_or_parent@email.com" />
          </div>
          <div>
            <label>Track</label>
            <select id="track">
              <option value="regular">Regular</option>
              <option value="olympiad">Olympiad</option>
            </select>
          </div>
          <div class="row" style="grid-column:1/-1">
            <div>
              <label>Action</label>
              <select id="action">
                <option value="list">List payments</option>
                <option value="refund">Refund payment</option>
                <option value="reconcile">Reconcile receipt</option>
              </select>
            </div>
            <div>
              <label>Reference (receipt/txn id)</label>
              <input id="reference" placeholder="optional" />
            </div>
          </div>
          <div style="grid-column:1/-1;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn primary" id="btnRun">Run</button>
            <span class="sub">Expected RPCs: <code>admin_list_payments</code>, <code>admin_refund_payment</code>, <code>admin_reconcile_payment</code></span>
          </div>
        </div>

        <div class="out">
          <div class="sub" style="margin-bottom:6px">RPC responses + errors</div>
          <pre id="out">Waiting…</pre>
        </div>
      </div>
    </div>
  </div>

  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    const CFG = {
      envEndpoint: '/api/env',
      adminHome: '/admin.html',
      allowedRoles: new Set(['super_admin','admin_regular','admin_olympiad']),
      roleRpcCandidates: ['get_my_role','admin_get_role','rp_admin_get_role','current_role','rp_current_role','get_user_role'],
      roleRpcCacheKey: 'lp_role_rpc_v1'
    };
    const UI = {
      pill: document.getElementById('bootPill'),
      dot: document.getElementById('bootDot'),
      text: document.getElementById('bootText'),
      who: document.getElementById('who'),
      role: document.getElementById('role'),
      alert: document.getElementById('alert'),
      btnBack: document.getElementById('btnBack'),
      btnOut: document.getElementById('btnOut'),
      btnIn: document.getElementById('btnIn')
    };
    function setPill(state, text, color){
      UI.text.textContent=text;
      UI.dot.style.background=color;
      if(state==='error'){ UI.pill.style.borderColor='#fecaca'; UI.pill.style.background='#fef2f2'; }
      else if(state==='ok'){ UI.pill.style.borderColor='#bbf7d0'; UI.pill.style.background='#f0fdf4'; }
      else { UI.pill.style.borderColor='#e5e7eb'; UI.pill.style.background='#fff'; }
    }
    function showAlert(kind, msg){
      UI.alert.style.display='block';
      UI.alert.className='banner ' + kind;
      UI.alert.textContent=msg;
    }
    function hideAlert(){ UI.alert.style.display='none'; }
    function assertSupabaseLoaded(){
      if(!window.supabase || typeof window.supabase.createClient!=='function'){
        const e=new Error('supabase_js_missing'); e.code='supabase_js_missing'; throw e;
      }
    }
    async function fetchEnv(){
      const r=await fetch(CFG.envEndpoint,{cache:'no-store'});
      if(!r.ok){ throw new Error('env_fetch_failed'); }
      const j=await r.json();
      const url=j?.SUPABASE_URL||j?.supabaseUrl||j?.url;
      const key=j?.SUPABASE_ANON_KEY||j?.anonKey||j?.key;
      if(!url||!key) throw new Error('env_missing');
      return {url,key};
    }
    function createClient(url,key){
      assertSupabaseLoaded();
      return window.supabase.createClient(url,key,{auth: { persistSession: true, autoRefreshToken: false, detectSessionInUrl: false, storageKey: 'lp_admin_auth', storage: window.sessionStorage }});
    }
    let sb=null;

    async function safeSignOut(){
      try{ if(sb) await sb.auth.signOut(); }catch(_e){}
      UI.who.textContent='—';
      UI.role.textContent='no_role';
      setPill('ok','Signed out','#10b981');
    }

    async function callRoleRpc(){
      const cached=localStorage.getItem(CFG.roleRpcCacheKey);
      const candidates=cached?[cached,...CFG.roleRpcCandidates.filter(x=>x!==cached)]:[...CFG.roleRpcCandidates];
      let last=null;
      for(const name of candidates){
        try{
          const {data,error}=await sb.rpc(name,{});
          if(error){
            last=error;
            const msg=(error.message||'').toLowerCase();
            if(msg.includes('not found')||msg.includes('could not find')) continue;
            throw error;
          }
          let role=null;
          if(typeof data==='string') role=data;
          else if(data&&typeof data==='object') role=data.role||data.current_role||data.name||null;
          if(role){ localStorage.setItem(CFG.roleRpcCacheKey,name); return String(role); }
          localStorage.setItem(CFG.roleRpcCacheKey,name); return 'no_role';
        }catch(e){
          last=e;
          const msg=String(e?.message||e||'').toLowerCase();
          if(msg.includes('not found')||msg.includes('could not find')||msg.includes('pgrst202')) continue;
        }
      }
      const e=new Error('role_rpc_missing'); e.detail=last; throw e;
    }

    async function verifyAccess(){
      const {data:{user}}=await sb.auth.getUser();
      if(!user){
        showAlert('warn','You are signed out. Sign in from Admin Console.');
        return {ok:false, reason:'no_session'};
      }
      let role='unknown';
      try{ role=await callRoleRpc(); }catch(e){
        await safeSignOut();
        showAlert('bad','Access verification RPC missing or failing. Create/Expose a role RPC (e.g., get_my_role).');
        return {ok:false, reason:'role_rpc_missing'};
      }
      UI.who.textContent=user.email||'—';
      UI.role.textContent=role;
      if(!CFG.allowedRoles.has(role)){
        await safeSignOut();
        showAlert('bad','Not authorized for admin pages. Session terminated.');
        return {ok:false, reason:'not_admin'};
      }
      hideAlert();
      return {ok:true, role};
    }

    async function bootstrap(){
      setPill('loading','Loading…','#9ca3af');
      try{
        const env=await fetchEnv();
        sb=createClient(env.url, env.key);

        UI.btnBack.addEventListener('click', ()=> location.href = CFG.adminHome);
        UI.btnOut.addEventListener('click', async ()=>{ setPill('loading','Signing out…','#f59e0b'); await safeSignOut(); location.href = CFG.adminHome; });
        if(UI.btnIn) UI.btnIn.addEventListener('click', ()=> location.href = CFG.adminHome);

        sb.auth.onAuthStateChange(async ()=>{ await verifyAccess(); });

        const verdict=await verifyAccess();
        setPill('ok', verdict.ok ? 'Ready' : 'Locked', verdict.ok ? '#10b981' : '#f59e0b');
      }catch(e){
        console.error(e);
        if(String(e?.message||e).includes('supabase_js_missing')){
          showAlert('bad','Supabase JS failed to load. Check if your network blocks cdn.jsdelivr.net.');
        } else if(String(e?.message||e).includes('env')){
          showAlert('bad','/api/env failed or missing keys. Ensure Vercel function /api/env is deployed and correct.');
        } else {
          showAlert('bad','Boot failure: ' + String(e?.message||e));
        }
        setPill('error','Boot error','#ef4444');
      }
    }
    bootstrap();
  </script>


  <script>
    // Payments actions (runs only when access OK)
    const outEl = document.getElementById('out');
    const btnRun = document.getElementById('btnRun');

    function setOut(obj){
      outEl.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    }

    async function requireReady(){
      if(!window.sb) throw new Error('sb_not_ready');
    }

    // Expose sb from bootstrap script (shared)
    // (shared script defines "sb" as local; we also attach to window for pages that need it)
  </script>

  <script>
    // Patch: attach sb to window for action layer
    // We can't edit the shared bootstrap's closure, so we re-create a client here after bootstrap finished.
    // This is safe because it uses the same persisted session.
    (async function(){
      // Wait a tick to let shared bootstrap run first
      await new Promise(r=>setTimeout(r,0));
      try{
        const r=await fetch('/api/env',{cache:'no-store'});
        const j=await r.json();
        const url=j?.SUPABASE_URL||j?.supabaseUrl||j?.url;
        const key=j?.SUPABASE_ANON_KEY||j?.anonKey||j?.key;
        if(window.supabase && url && key){
          window.sb = window.supabase.createClient(url,key,{auth: { persistSession: true, autoRefreshToken: false, detectSessionInUrl: false, storageKey: 'lp_admin_auth', storage: window.sessionStorage }});
        }
      }catch(_e){}
    })();
  </script>

  <script>
    btnRun.addEventListener('click', async ()=>{
      try{
        if(!window.sb){ setOut('Not ready yet.'); return; }
        // Simple access check: if role in UI is unknown/no_role, refuse
        const role = (document.getElementById('role').textContent||'').trim();
        if(!['super_admin','admin_regular','admin_olympiad'].includes(role)){ setOut('Locked: not authorized.'); return; }

        const customer_email = document.getElementById('customer_email').value.trim() || null;
        const track = document.getElementById('track').value;
        const action = document.getElementById('action').value;
        const reference = document.getElementById('reference').value.trim() || null;

        setOut('Running…');

        if(action==='list'){
          const { data, error } = await window.sb.rpc('admin_list_payments', { customer_email, track });
          if(error) throw error;
          setOut(data);
        } else if(action==='refund'){
          const { data, error } = await window.sb.rpc('admin_refund_payment', { customer_email, track, reference });
          if(error) throw error;
          setOut(data);
        } else if(action==='reconcile'){
          const { data, error } = await window.sb.rpc('admin_reconcile_payment', { customer_email, track, reference });
          if(error) throw error;
          setOut(data);
        }
      }catch(e){
        setOut({ error: true, message: e?.message || String(e), details: e });
      }
    });
  </script>
</body>
</html>
