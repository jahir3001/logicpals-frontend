<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LogicPals Admin — Payments</title>

  
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--accent:#4f46e5;--accent2:#06b6d4;--good:#16a34a;--warn:#b45309;--bad:#dc2626;--shadow:0 18px 45px rgba(2,6,23,.08);--r:18px}
    *{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--text);background:linear-gradient(180deg,#ffffff 0%, #f6f7fb 100%)}
    a{color:inherit;text-decoration:none}
    .shell{max-width:1200px;margin:28px auto;padding:0 18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;background:var(--card);border:1px solid var(--line);border-radius:22px;padding:14px 16px;box-shadow:var(--shadow)}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:grid;place-items:center;color:#fff;font-weight:800}
    .bt{font-size:14px;font-weight:800;margin:0}.st{font-size:12px;color:var(--muted);margin:0}
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;font-size:13px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:999px;background:#94a3b8}
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    .h{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .h h2{margin:0;font-size:18px}.hint{color:var(--muted);font-size:13px}
    .form{display:grid;grid-template-columns:1.3fr .7fr;gap:12px;margin-top:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted);font-weight:700}
    input,select{border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;outline:none}
    textarea{border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:13px;min-height:160px;resize:vertical;outline:none;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .note{margin-top:8px;font-size:12px;color:var(--muted)}
    @media (max-width:900px){.form{grid-template-columns:1fr}}
  </style>
  <script src="/assets/js/env-loader.js"></script>
</head>

<body>
  <div class="shell">
    <header class="top">
      <div class="brand">
        <div class="logo">LP</div>
        <div>
          <p class="bt">Payments</p>
          <p class="st">Admin-only — list / refund / reconcile (RPC-only)</p>
        </div>
      </div>
      <div class="right">
        <span class="pill" id="status"><span class="dot" id="dot"></span><span id="statusTxt">Loading…</span></span>
        <a class="btn" href="/admin.html">Back to Admin</a>
        <button class="btn primary" id="btnSignIn">Sign in</button>
        <button class="btn" id="btnSignOut" style="display:none">Sign out</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="h">
          <h2>Payment Operations</h2>
          <div class="hint" id="who"></div>
        </div>

        <div class="form">
          <div class="field">
            <label>Customer email</label>
            <input id="email" placeholder="student_or_parent@email.com" autocomplete="email" />
          </div>
          <div class="field">
            <label>Track</label>
            <select id="track">
              <option value="regular">Regular</option>
              <option value="olympiad">Olympiad</option>
            </select>
          </div>

          <div class="field">
            <label>Action</label>
            <select id="action">
              <option value="list">List payments</option>
              <option value="refund">Refund payment</option>
              <option value="reconcile">Reconcile payment</option>
            </select>
          </div>
          <div class="field">
            <label>Reference (receipt/txn id)</label>
            <input id="ref" placeholder="optional" />
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="run">Run</button>
          <button class="btn" id="trust">Load trust summary</button>
        </div>

        <p class="note">Expected RPCs: <code>admin_list_payments</code>, <code>admin_refund_payment</code>, <code>admin_reconcile_payment</code>, <code>admin_trust_summary</code>. (If your function names differ, tell me and I will wire them.)</p>
      </section>

      <section class="card">
        <div class="h"><h2>Output</h2><div class="hint">RPC responses + errors</div></div>
        <textarea id="out" readonly>Waiting…</textarea>
      </section>
    </div>
  </div>

  <dialog id="dlg" style="border:none;border-radius:16px;max-width:420px;width:calc(100% - 24px);padding:0;box-shadow:0 20px 70px rgba(2,6,23,.25)">
    <form method="dialog" style="padding:16px 16px 14px;background:#fff;border:1px solid var(--line);border-radius:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div style="font-weight:900">Admin sign in</div>
        <button class="btn" value="cancel">✕</button>
      </div>
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
        <div class="field"><label>Email</label><input id="lgEmail" type="email" autocomplete="email" required placeholder="admin@email.com"/></div>
        <div class="field"><label>Password</label><input id="lgPass" type="password" autocomplete="current-password" required /></div>
        <button class="btn primary" id="doLogin" value="default">Sign in</button>
        <div class="hint" id="authOut"></div>
      </div>
    </form>
  </dialog>

  <script type="module">
/**
 * LogicPals Admin — Payments (RPC-only)
 * Enterprise guard: admin-only, auto sign-out non-admins.
 */
const UI = {
  chipStatus: document.getElementById("chipStatus"),
  statusText: document.getElementById("statusText"),
  dot: document.getElementById("dot"),
  signedInEmail: document.getElementById("signedInEmail"),
  roleName: document.getElementById("roleName"),
  btnBack: document.getElementById("btnBack"),
  btnSignOut: document.getElementById("btnSignOut"),
  btnSignIn: document.getElementById("btnSignIn"),
  btnDoLogin: document.getElementById("btnDoLogin"),
  btnCancel: document.getElementById("btnCancel"),
  dlg: document.getElementById("dlg"),
  email: document.getElementById("email"),
  inPass: document.getElementById("inPass"),
  out: document.getElementById("out"),
  track: document.getElementById("track"),
  action: document.getElementById("action"),
  reference: document.getElementById("reference"),
  btnRun: document.getElementById("btnRun"),
  btnTrust: document.getElementById("btnTrust"),
};

function setStatus(kind, text){
  if(UI.statusText) UI.statusText.textContent = text || "";
  if(UI.chipStatus){
    UI.chipStatus.classList.remove("ok","warn","err");
    UI.chipStatus.classList.add(kind);
  }
}

function openDlg(){ UI.dlg?.classList.add("open"); }
function closeDlg(){ UI.dlg?.classList.remove("open"); }

const ADMIN_ROLES = new Set(["super_admin", "admin_regular", "admin_olympiad"]);

function isAdminRole(role){ return ADMIN_ROLES.has(String(role||"").trim()); }

async function loadSupabaseLib(){
  if (window.__lp_supabase_lib_ready) return window.__lp_supabase_lib_ready;
  window.__lp_supabase_lib_ready = (async()=>{
    try{
      const mod = await import("https://esm.sh/@supabase/supabase-js@2");
      return { createClient: mod.createClient };
    }catch(e){
      await new Promise((resolve,reject)=>{
        const s=document.createElement("script");
        s.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
        s.async=true; s.onload=resolve; s.onerror=reject;
        document.head.appendChild(s);
      });
      if(!window.supabase?.createClient) throw new Error("supabase_js_missing");
      return { createClient: window.supabase.createClient };
    }
  })();
  return window.__lp_supabase_lib_ready;
}

async function fetchEnv(){
  const res = await fetch("/api/env",{cache:"no-store"});
  if(!res.ok) throw new Error(`env_fetch_failed_${res.status}`);
  const env = await res.json();
  if(!env?.SUPABASE_URL || !env?.SUPABASE_ANON_KEY) throw new Error("env_missing_supabase");
  return env;
}

async function getSupabase(){
  if(window.__lp_admin_supabase) return window.__lp_admin_supabase;
  const [{createClient}, env] = await Promise.all([loadSupabaseLib(), fetchEnv()]);
  window.__lp_admin_supabase = createClient(env.SUPABASE_URL, env.SUPABASE_ANON_KEY, {
    auth:{
      persistSession:true,
      autoRefreshToken:true,
      detectSessionInUrl:false,
      storageKey:"lp_admin_auth"
    },
    global:{headers:{"x-client-info":"logicpals-admin-ui/enterprise"}}
  });
  return window.__lp_admin_supabase;
}

async function safeGetRole(supabase){
  const candidates=["get_my_role","admin_get_role","rp_admin_get_role","current_role","get_current_role"];
  for(const fn of candidates){
    try{
      const {data,error}=await supabase.rpc(fn);
      if(!error){
        const role = (typeof data==="string")?data:(data?.role ?? data?.current_role ?? data?.name ?? null);
        if(role) return String(role);
      }
    }catch(_e){}
  }
  return "no_role";
}

async function enforceAdminOrSignOut({supabase, session, onDenied}){
  if(!session) return {ok:false, role:"no_role"};
  const role = await safeGetRole(supabase);
  if(!isAdminRole(role)){
    try{ await supabase.auth.signOut(); }catch{}
    if(onDenied) onDenied(role);
    return {ok:false, role};
  }
  return {ok:true, role};
}

async function refreshAuthUI(){
  const supabase = await getSupabase();
  const { data: { session } } = await supabase.auth.getSession();

  UI.signedInEmail.textContent = session?.user?.email || "—";
  UI.roleName.textContent = "unknown";

  UI.btnSignOut.style.display = session ? "inline-flex" : "none";
  UI.btnSignIn.style.display = session ? "none" : "inline-flex";

  if(!session){
    setStatus("warn","Sign-in required");
    openDlg();
    return;
  }

  const gate = await enforceAdminOrSignOut({
    supabase,
    session,
    onDenied: (role) => {
      setStatus("err","Access denied (admin only). You were signed out.");
      UI.roleName.textContent = role || "no_role";
      openDlg();
    }
  });

  UI.roleName.textContent = gate.role;
  if(!gate.ok) return;

  setStatus("ok","Ready");
  closeDlg();
}

function appendOut(line){
  const prev = UI.out.textContent || "";
  UI.out.textContent = (prev ? prev + "
" : "") + line;
}

async function callRpc(fn, payload){
  const supabase = await getSupabase();
  const { data: { session } } = await supabase.auth.getSession();
  const gate = await enforceAdminOrSignOut({
    supabase, session,
    onDenied: ()=>{}
  });
  if(!gate.ok) {
    throw new Error("not_admin_or_signed_out");
  }
  const { data, error } = await supabase.rpc(fn, payload);
  if(error) throw error;
  return data;
}

async function runAction(){
  UI.out.textContent = "";
  setStatus("warn","Running…");
  const track = UI.track.value;
  const email = (document.getElementById("customer_email")?.value || "").trim() || null;
  const action = UI.action.value;
  const ref = (UI.reference.value || "").trim() || null;

  try {
    if(action === "list") {
      const data = await callRpc("admin_list_payments", { p_email: email, p_track: track });
      appendOut(JSON.stringify(data, null, 2));
    } else if(action === "refund") {
      if(!ref) throw new Error("Reference required for refund");
      const data = await callRpc("admin_refund_payment", { p_reference: ref, p_email: email, p_track: track });
      appendOut(JSON.stringify(data, null, 2));
    } else if(action === "reconcile") {
      if(!ref) throw new Error("Reference required for reconcile");
      const data = await callRpc("admin_reconcile_payment", { p_reference: ref, p_email: email, p_track: track });
      appendOut(JSON.stringify(data, null, 2));
    } else {
      throw new Error("unknown_action");
    }
    setStatus("ok","Done");
  } catch (e) {
    appendOut(String(e?.message || e));
    setStatus("err","Error");
  }
}

async function doSignIn(){
  const supabase = await getSupabase();
  const email = (UI.email.value || "").trim();
  const password = UI.inPass.value || "";
  if(!email || !password) {
    setStatus("warn","Email + password required");
    return;
  }
  setStatus("warn","Signing in…");
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if(error) {
    setStatus("err", error.message || "Sign in failed");
    return;
  }
  // Verify role immediately
  const gate = await enforceAdminOrSignOut({
    supabase, session: data?.session,
    onDenied: () => setStatus("err","Not an admin account. Signed out.")
  });
  if(gate.ok) setStatus("ok","Signed in");
  await refreshAuthUI();
}

async function doSignOut(){
  const supabase = await getSupabase();
  setStatus("warn","Signing out…");
  try{ await supabase.auth.signOut(); }catch{}
  await refreshAuthUI();
}

async function bootstrap(){
  try {
    await getSupabase();
    UI.btnBack?.addEventListener("click", () => { window.location.href = "/admin.html"; });
    UI.btnSignOut?.addEventListener("click", (e)=>{ e.preventDefault(); doSignOut(); });
    UI.btnSignIn?.addEventListener("click", (e)=>{ e.preventDefault(); openDlg(); });
    UI.btnDoLogin?.addEventListener("click", (e)=>{ e.preventDefault(); doSignIn(); });
    UI.btnCancel?.addEventListener("click", (e)=>{ e.preventDefault(); closeDlg(); });
    UI.btnRun?.addEventListener("click", (e)=>{ e.preventDefault(); runAction(); });
    UI.btnTrust?.addEventListener("click", (e)=>{ e.preventDefault(); window.location.href="/admin.html#trust"; });

    const supabase = await getSupabase();
    if(!window.__lp_admin_auth_listener){
      window.__lp_admin_auth_listener = supabase.auth.onAuthStateChange(()=>{ setTimeout(()=>refreshAuthUI().catch(()=>{}),0); });
    }
    await refreshAuthUI();
  } catch(e) {
    setStatus("err", (e?.message||String(e)));
    openDlg();
  }
}
bootstrap();
</script>
</body>
</html>
