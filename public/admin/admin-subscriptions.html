<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LogicPals Admin — Subscriptions</title>

  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--accent:#4f46e5;--accent2:#06b6d4;--good:#16a34a;--warn:#b45309;--bad:#dc2626;--shadow:0 18px 45px rgba(2,6,23,.08);--r:18px}
    *{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:linear-gradient(180deg,#ffffff 0%, #f6f7fb 100%)}
    a{color:inherit;text-decoration:none}
    .shell{max-width:1200px;margin:28px auto;padding:0 18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;background:var(--card);border:1px solid var(--line);border-radius:22px;padding:14px 16px;box-shadow:var(--shadow)}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:grid;place-items:center;color:#fff;font-weight:800}
    .bt{font-size:14px;font-weight:800;margin:0}.st{font-size:12px;color:var(--muted);margin:0}
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;font-size:13px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:999px;background:#94a3b8}
    .dot.ok{background:var(--good)} .dot.warn{background:#f59e0b} .dot.err{background:var(--bad)}
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    .h{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .h h2{margin:0;font-size:18px}.hint{color:var(--muted);font-size:13px}
    .form{display:grid;grid-template-columns:1.3fr .7fr;gap:12px;margin-top:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted);font-weight:700}
    input,select{border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;outline:none}
    textarea{border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:13px;min-height:180px;resize:vertical;outline:none;font-family:ui-monospace,Menlo,Consolas,monospace}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .note{margin-top:8px;font-size:12px;color:var(--muted)}
    @media (max-width:900px){.form{grid-template-columns:1fr}}
  </style>

  <script src="/assets/js/env-loader.js"></script>
</head>

<body>
  <div class="shell">
    <header class="top">
      <div class="brand">
        <div class="logo">LP</div>
        <div>
          <p class="bt">Subscriptions</p>
          <p class="st">Admin-only — list / extend / cancel (RPC-only)</p>
        </div>
      </div>
      <div class="right">
        <span class="pill" id="status"><span class="dot" id="dot"></span><span id="statusTxt">Loading…</span></span>
        <a class="btn" href="/admin.html">Back to Admin</a>
        <button class="btn primary" id="btnOpenLogin">Sign in</button>
        <button class="btn" id="btnSignOut" style="display:none">Sign out</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="h">
          <h2>Subscription Operations</h2>
          <div class="hint" id="who">—</div>
        </div>

        <div class="form">
          <div class="field">
            <label>Customer email</label>
            <input id="customerEmail" placeholder="student_or_parent@email.com" autocomplete="email" />
          </div>
          <div class="field">
            <label>Track</label>
            <select id="track">
              <option value="regular">Regular</option>
              <option value="olympiad">Olympiad</option>
            </select>
          </div>

          <div class="field">
            <label>Action</label>
            <select id="action">
              <option value="list">List subscriptions</option>
              <option value="extend">Extend subscription</option>
              <option value="cancel">Cancel subscription</option>
            </select>
          </div>
          <div class="field">
            <label>Days to extend (extend only)</label>
            <input id="days" type="number" min="1" placeholder="e.g. 30" />
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnRun">Run</button>
        </div>

        <p class="note">
          Expected RPCs: <code>admin_list_subscriptions</code>, <code>admin_extend_subscription</code>, <code>admin_cancel_subscription</code>.
        </p>
      </section>

      <section class="card">
        <div class="h"><h2>Output</h2><div class="hint">RPC responses + errors</div></div>
        <textarea id="out" readonly>Waiting…</textarea>
      </section>
    </div>
  </div>

  <dialog id="dlg">
    <div style="padding:16px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;background:#fff">
      <strong>Admin sign in</strong>
      <button class="btn" id="btnCloseDlg" type="button">✕</button>
    </div>
    <div style="padding:16px 18px;background:#fff">
      <form id="loginForm">
        <div class="field"><label>Email</label><input id="lgEmail" type="email" autocomplete="email" required placeholder="admin@email.com"/></div>
        <div class="field"><label>Password</label><input id="lgPass" type="password" autocomplete="current-password" required /></div>
        <button class="btn primary" type="submit">Sign in</button>
      </form>
      <div class="hint" id="authOut" style="margin-top:10px">Waiting…</div>
    </div>
  </dialog>

  <script>
  (function(){
    "use strict";

    const ADMIN_ROLES = new Set(["super_admin","admin_regular","admin_olympiad"]);

    const UI = {
      dot: document.getElementById("dot"),
      statusTxt: document.getElementById("statusTxt"),
      who: document.getElementById("who"),
      btnOpenLogin: document.getElementById("btnOpenLogin"),
      btnSignOut: document.getElementById("btnSignOut"),
      btnRun: document.getElementById("btnRun"),
      out: document.getElementById("out"),
      track: document.getElementById("track"),
      action: document.getElementById("action"),
      customerEmail: document.getElementById("customerEmail"),
      days: document.getElementById("days"),
      dlg: document.getElementById("dlg"),
      btnCloseDlg: document.getElementById("btnCloseDlg"),
      loginForm: document.getElementById("loginForm"),
      lgEmail: document.getElementById("lgEmail"),
      lgPass: document.getElementById("lgPass"),
      authOut: document.getElementById("authOut"),
    };

    function setStatus(kind, txt){
      UI.dot.classList.remove("ok","warn","err");
      UI.dot.classList.add(kind);
      UI.statusTxt.textContent = txt;
    }

    async function loadSupabaseLib(){
      if (window.supabase && window.supabase.createClient) return window.supabase;
      if (window.__LP_SUPABASE_LIB_PROMISE) return window.__LP_SUPABASE_LIB_PROMISE;
      window.__LP_SUPABASE_LIB_PROMISE = new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js";
        s.async = true; s.defer = true;
        s.onload = () => (window.supabase && window.supabase.createClient) ? resolve(window.supabase) : reject(new Error("supabase_umd_load_failed"));
        s.onerror = () => reject(new Error("supabase_umd_load_failed"));
        document.head.appendChild(s);
      });
      return window.__LP_SUPABASE_LIB_PROMISE;
    }

    async function getEnv(){
      if (window.__LP_ENV && (window.__LP_ENV.SUPABASE_URL || window.__LP_ENV.supabase_url)) return window.__LP_ENV;
      const res = await fetch("/api/env",{cache:"no-store"});
      if(!res.ok) throw new Error("env_fetch_failed_"+res.status);
      const env = await res.json();
      window.__LP_ENV = env;
      return env;
    }

    async function getSupabase(){
      if (window.__LP_ADMIN_SB) return window.__LP_ADMIN_SB;
      const env = await getEnv();
      const url = env.supabase_url || env.SUPABASE_URL;
      const anon = env.supabase_anon_key || env.SUPABASE_ANON_KEY;
      if (!url || !anon) throw new Error("env_missing_supabase");
      const lib = await loadSupabaseLib();
      const sb = lib.createClient(url, anon, {
        auth: {
          storageKey: "lp_admin_auth",
          persistSession: true,
          autoRefreshToken: false,
          detectSessionInUrl: false
        }
      });
      window.__LP_ADMIN_SB = sb;
      return sb;
    }

    function isAdminRole(role){
      return ADMIN_ROLES.has(String(role||"").trim());
    }

    async function resolveRole(sb){
      const candidates = ["get_my_role","rp_get_my_role","admin_get_role","rp_admin_get_user_role","get_current_user_role","current_role"];
      for (const fn of candidates){
        try{
          const { data, error } = await sb.rpc(fn);
          if (!error){
            if (typeof data === "string") return data;
            if (data && typeof data === "object") return String(data.role || data.current_role || data.name || "no_role");
            return "no_role";
          }
        }catch(_e){}
      }
      return "no_role";
    }

    function openDlg(){ UI.dlg.showModal(); }
    function closeDlg(){ try{ UI.dlg.close(); }catch(_e){} }

    function setOut(obj){
      UI.out.value = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }

    async function enforceAdmin(){
      const sb = await getSupabase();
      const { data:{session} } = await sb.auth.getSession();
      if (!session){
        setStatus("warn","Sign-in required");
        UI.who.textContent = "—";
        UI.btnSignOut.style.display = "none";
        UI.btnOpenLogin.style.display = "inline-flex";
        UI.authOut.textContent = "Please sign in with an admin account.";
        openDlg();
        return { ok:false };
      }

      const role = await resolveRole(sb);
      UI.who.textContent = `Signed in: ${session.user.email}  •  Role: ${role}`;
      UI.btnSignOut.style.display = "inline-flex";
      UI.btnOpenLogin.style.display = "none";

      if (!isAdminRole(role)){
        try{ await sb.auth.signOut(); }catch(_e){}
        setStatus("err","Access denied (admin only)");
        UI.authOut.textContent = "Not an admin account. Signed out.";
        openDlg();
        return { ok:false };
      }

      setStatus("ok","Ready");
      return { ok:true, sb };
    }

    async function signIn(email, password){
      const sb = await getSupabase();
      setStatus("warn","Signing in…");
      UI.authOut.textContent = "Signing in…";
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error){
        setStatus("err","Sign in failed");
        UI.authOut.textContent = error.message || "Sign in failed";
        return;
      }
      await enforceAdmin();
      closeDlg();
    }

    async function signOut(){
      const sb = await getSupabase();
      setStatus("warn","Signing out…");
      try{ await sb.auth.signOut(); }catch(_e){}
      await enforceAdmin();
    }

    async function run(){
      UI.out.value = "Running…";
      const gate = await enforceAdmin();
      if (!gate.ok) return;

      const sb = gate.sb;
      const action = UI.action.value;
      const track = UI.track.value;
      const email = (UI.customerEmail.value || "").trim() || null;
      const days = parseInt((UI.days.value || "").trim(), 10);

      try{
        let data;
        if (action === "list"){
          data = await sb.rpc("admin_list_subscriptions", { p_email: email, p_track: track }).then(r => { if(r.error) throw r.error; return r.data; });
        } else if (action === "extend"){
          if (!days || days < 1) throw new Error("Days must be >= 1 for extend");
          data = await sb.rpc("admin_extend_subscription", { p_email: email, p_track: track, p_days: days }).then(r => { if(r.error) throw r.error; return r.data; });
        } else if (action === "cancel"){
          data = await sb.rpc("admin_cancel_subscription", { p_email: email, p_track: track }).then(r => { if(r.error) throw r.error; return r.data; });
        } else {
          throw new Error("Unknown action");
        }
        setOut(data);
        setStatus("ok","Done");
      }catch(e){
        setOut(String(e?.message || e));
        setStatus("err","Error");
      }
    }

    async function bootstrap(){
      try{
        setStatus("warn","Loading…");

        UI.btnOpenLogin.addEventListener("click", openDlg);
        UI.btnCloseDlg.addEventListener("click", closeDlg);
        UI.btnSignOut.addEventListener("click", signOut);
        UI.btnRun.addEventListener("click", run);

        UI.loginForm.addEventListener("submit", (e) => {
          e.preventDefault();
          signIn((UI.lgEmail.value||"").trim(), UI.lgPass.value||"");
        });

        const sb = await getSupabase();
        if (!window.__LP_ADMIN_AUTH_SUB){
          window.__LP_ADMIN_AUTH_SUB = sb.auth.onAuthStateChange(() => setTimeout(() => enforceAdmin().catch(()=>{}), 0));
        }

        await enforceAdmin();
      }catch(e){
        setStatus("err","Boot error");
        setOut(String(e?.message || e));
        openDlg();
      }
    }

    bootstrap();
  })();
  </script>
</body>
</html>