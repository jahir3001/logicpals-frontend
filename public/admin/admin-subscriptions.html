<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LogicPals Admin — Subscriptions</title>
  
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--accent:#4f46e5;--good:#16a34a;--warn:#b45309;--bad:#dc2626;--shadow:0 18px 45px rgba(2,6,23,.08);--r:18px}
    *{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--text);background:linear-gradient(180deg,#ffffff 0%, #f6f7fb 100%)}
    a{color:inherit;text-decoration:none}
    .shell{max-width:1200px;margin:28px auto;padding:0 18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;background:var(--card);border:1px solid var(--line);border-radius:22px;padding:14px 16px;box-shadow:var(--shadow)}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(135deg,#4f46e5,#06b6d4);color:#fff;font-weight:800;letter-spacing:.5px}
    .btitle{font-weight:800}
    .bsub{color:var(--muted);font-size:12px;margin-top:2px}
    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted);font-size:12px}
    .dot{width:8px;height:8px;border-radius:999px;background:#94a3b8}
    .btn{cursor:pointer;border:1px solid var(--line);background:#fff;color:var(--text);padding:10px 12px;border-radius:12px;font-weight:700}
    .btn:hover{border-color:#cbd5e1}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.primary:hover{filter:brightness(.96)}
    .btn.ghost{background:transparent}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .card .hd{padding:16px 16px 10px;border-bottom:1px solid var(--line)}
    .card .hd h2{margin:0;font-size:16px}
    .card .hd p{margin:6px 0 0;color:var(--muted);font-size:12px}
    .card .bd{padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#fff;outline:none}
    input:focus,select:focus{border-color:#b9c3ff;box-shadow:0 0 0 4px rgba(79,70,229,.12)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .stack{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    pre{margin:0;padding:14px;border-radius:14px;background:#0b1220;color:#e5e7eb;min-height:220px;overflow:auto;font-size:12px}
    .note{padding:10px 12px;border-radius:14px;border:1px dashed #dbeafe;background:#eff6ff;color:#1e3a8a;font-size:12px}
    .warn{padding:10px 12px;border-radius:14px;border:1px dashed #fed7aa;background:#fff7ed;color:#7c2d12;font-size:12px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
  </style>
  <script src="/assets/js/env-loader.js"></script>
</head>
<body>
  <div class="shell">
    <header class="top">
      <div class="brand">
        <div class="logo">LP</div>
        <div>
          <div class="btitle">Subscriptions</div>
          <div class="bsub">Admin-only — list / extend / cancel (RPC-only)</div>
        </div>
      </div>
      <div class="actions">
        <span class="chip" id="chipStatus"><span class="dot" id="dot"></span><span id="statusText">Loading…</span></span>
        <button class="btn ghost" id="btnBack">← Back to Admin</button>
        <button class="btn" id="btnDashboard">Dashboard</button>
        <button class="btn primary" id="btnSignIn">Sign in</button>
        <button class="btn" id="btnSignOut" style="display:none">Log out</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="hd">
          <h2>Manage a customer</h2>
          <p>All actions must route through RPCs so RLS + audit rules apply (Step 7).</p>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Customer email</label>
              <input id="email" placeholder="student_or_parent@email.com" autocomplete="email" />
            </div>
            <div>
              <label>Track</label>
              <select id="track">
                <option value="regular">Regular</option>
                <option value="olympiad">Olympiad</option>
              </select>
            </div>
          </div>

          <div class="row3" style="margin-top:12px">
            <div>
              <label>Extend months</label>
              <input id="months" type="number" min="1" value="1" />
            </div>
            <div>
              <label>Plan</label>
              <select id="plan">
                <option value="monthly">Monthly</option>
                <option value="annual">Annual</option>
                <option value="manual">Manual</option>
              </select>
            </div>
            <div>
              <label>Reason / note</label>
              <input id="note" placeholder="Support extension" />
            </div>
          </div>

          <div class="stack">
            <button class="btn" id="btnLoad">Load subscriptions</button>
            <button class="btn" id="btnTrust">Load trust summary</button>
            <button class="btn primary" id="btnExtend">Extend</button>
            <button class="btn" id="btnCancel">Cancel</button>
          </div>

          <div class="warn" style="margin-top:12px">
            Expected RPCs (you can rename — just update here):
            <code>admin_list_subscriptions</code>, <code>admin_extend_subscription</code>, <code>admin_cancel_subscription</code>, <code>admin_trust_summary</code>.
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <h2>Output</h2>
          <p>Raw JSON from your RPC responses.</p>
        </div>
        <div class="bd">
          <pre id="out">Waiting…</pre>
          <div class="note" style="margin-top:12px">
            If you see “permission denied”, that’s GOOD — it means RLS is enforcing. Then assign your admin role and retry.
          </div>
        </div>
      </section>
    </div>
  </div>

  <dialog id="dlg" style="border:none;border-radius:16px;max-width:420px;width:calc(100% - 24px);padding:0;box-shadow:0 25px 90px rgba(2,6,23,.25)">
    <form method="dialog" style="padding:16px 16px 14px;background:#fff;border-radius:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div style="font-weight:900">Admin sign-in</div>
        <button class="btn" value="cancel" style="padding:8px 10px">✕</button>
      </div>
      <div style="margin-top:12px">
        <label>Email</label>
        <input id="inEmail" autocomplete="email" />
      </div>
      <div style="margin-top:10px">
        <label>Password</label>
        <input id="inPass" type="password" autocomplete="current-password" />
      </div>
      <div class="stack" style="margin-top:12px">
        <button class="btn primary" id="btnDoLogin" value="default" type="button">Sign in</button>
        <button class="btn" value="cancel">Cancel</button>
      </div>
      <div style="margin-top:10px;color:var(--muted);font-size:12px">Use email/password for staff accounts. (Student/parent login stays in the main app.)</div>
    </form>
  </dialog>

  <script type="module">
/**
 * LogicPals Admin — Subscriptions (RPC-only)
 * Enterprise guard: admin-only, auto sign-out non-admins.
 */
const UI = {
  chipStatus: document.getElementById("chipStatus"),
  statusText: document.getElementById("statusText"),
  signedInEmail: document.getElementById("signedInEmail"),
  roleName: document.getElementById("roleName"),
  btnBack: document.getElementById("btnBack"),
  btnSignOut: document.getElementById("btnSignOut"),
  btnSignIn: document.getElementById("btnSignIn"),
  btnDoLogin: document.getElementById("btnDoLogin"),
  btnCancel: document.getElementById("btnCancel"),
  dlg: document.getElementById("dlg"),
  email: document.getElementById("email"),
  inPass: document.getElementById("inPass"),
  out: document.getElementById("out"),
  track: document.getElementById("track"),
  action: document.getElementById("action"),
  reference: document.getElementById("reference"),
  days: document.getElementById("days"),
  btnRun: document.getElementById("btnRun"),
  btnTrust: document.getElementById("btnTrust"),
};

function setStatus(kind, text){
  if(UI.statusText) UI.statusText.textContent = text || "";
  if(UI.chipStatus){
    UI.chipStatus.classList.remove("ok","warn","err");
    UI.chipStatus.classList.add(kind);
  }
}

function openDlg(){ UI.dlg?.classList.add("open"); }
function closeDlg(){ UI.dlg?.classList.remove("open"); }

const ADMIN_ROLES = new Set(["super_admin", "admin_regular", "admin_olympiad"]);

function isAdminRole(role){ return ADMIN_ROLES.has(String(role||"").trim()); }

async function loadSupabaseLib() {
      // Enterprise-grade: avoid ESM import edge cases by loading the UMD bundle once.
      if (window.supabase && window.supabase.createClient) return window.supabase;
      if (window.__LP_SUPABASE_LIB_PROMISE) return window.__LP_SUPABASE_LIB_PROMISE;

      window.__LP_SUPABASE_LIB_PROMISE = new Promise((resolve, reject) => {
        const existing = document.querySelector('script[data-lp-supabase-umd="1"]');
        if (existing) {
          existing.addEventListener('load', () => resolve(window.supabase));
          existing.addEventListener('error', reject);
          return;
        }
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
        s.async = true;
        s.defer = true;
        s.setAttribute('data-lp-supabase-umd', '1');
        s.onload = () => {
          if (window.supabase && window.supabase.createClient) resolve(window.supabase);
          else reject(new Error('supabase_umd_load_failed'));
        };
        s.onerror = () => reject(new Error('supabase_umd_load_failed'));
        document.head.appendChild(s);
      });

      return window.__LP_SUPABASE_LIB_PROMISE;
    }

async function fetchEnv(){
  const res = await fetch("/api/env",{cache:"no-store"});
  if(!res.ok) throw new Error(`env_fetch_failed_${res.status}`);
  const env = await res.json();
  if(!env?.SUPABASE_URL || !env?.SUPABASE_ANON_KEY) throw new Error("env_missing_supabase");
  return env;
}

async function getSupabase() {
      // Singleton Supabase client per page (prevents GoTrue lock/timeouts)
      if (window.__LP_SUPABASE_ADMIN_CLIENT) return window.__LP_SUPABASE_ADMIN_CLIENT;

      const env = await getEnv();
      const url = env.supabase_url || env.SUPABASE_URL;
      const anonKey = env.supabase_anon_key || env.SUPABASE_ANON_KEY;
      if (!url || !anonKey) throw new Error("supabase_env_missing");

      const lib = await loadSupabaseLib();
      const client = lib.createClient(url, anonKey, {
        auth: {
          storageKey: "lp_admin_auth",
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: false
        }
      });

      window.__LP_SUPABASE_ADMIN_CLIENT = client;
      return client;
    }

async function safeGetRole(supabase){
  const candidates=["get_my_role","admin_get_role, rp_get_my_role","rp_admin_get_role, rp_get_my_role","","get_current_role"];
  for(const fn of candidates){
    try{
      const {data,error}=await supabase.rpc(fn);
      if(!error){
        const role = (typeof data==="string")?data:(data?.role ?? data?.?? data?.name ?? null);
        if(role) return String(role);
      }
    }catch(_e){}
  }
  return "no_role";
}

async function enforceAdminOrSignOut({supabase, session, onDenied}){
  if(!session) return {ok:false, role:"no_role"};
  const role = await safeGetRole(supabase);
  if(!isAdminRole(role)){
    try{ await supabase.auth.signOut(); }catch{}
    if(onDenied) onDenied(role);
    return {ok:false, role};
  }
  return {ok:true, role};
}

async function refreshAuthUI(){
  const supabase = await getSupabase();
  const { data: { session } } = await supabase.auth.getSession();

  UI.signedInEmail.textContent = session?.user?.email || "—";
  UI.roleName.textContent = "unknown";

  UI.btnSignOut.style.display = session ? "inline-flex" : "none";
  UI.btnSignIn.style.display = session ? "none" : "inline-flex";

  if(!session){
    setStatus("warn","Sign-in required");
    openDlg();
    return;
  }

  const gate = await enforceAdminOrSignOut({
    supabase,
    session,
    onDenied: (role) => {
      setStatus("err","Access denied (admin only). You were signed out.");
      UI.roleName.textContent = role || "no_role";
      openDlg();
    }
  });

  UI.roleName.textContent = gate.role;
  if(!gate.ok) return;

  setStatus("ok","Ready");
  closeDlg();
}

function appendOut(line){
  const prev = UI.out.textContent || "";
  UI.out.textContent = (prev ? prev + "
" : "") + line;
}

async function callRpc(fn, payload){
  const supabase = await getSupabase();
  const { data: { session } } = await supabase.auth.getSession();
  const gate = await enforceAdminOrSignOut({
    supabase, session,
    onDenied: ()=>{}
  });
  if(!gate.ok) throw new Error("not_admin_or_signed_out");
  const { data, error } = await supabase.rpc(fn, payload);
  if(error) throw error;
  return data;
}

async function runAction(){
  UI.out.textContent = "";
  setStatus("warn","Running…");
  const track = UI.track.value;
  const email = (document.getElementById("customer_email")?.value || "").trim() || null;
  const action = UI.action.value;
  const ref = (UI.reference.value || "").trim() || null;
  const days = parseInt(UI.days?.value || "0", 10);

  try {
    if(action === "list") {
      const data = await callRpc("admin_list_subscriptions", { p_email: email, p_track: track });
      appendOut(JSON.stringify(data, null, 2));
    } else if(action === "cancel") {
      if(!ref) throw new Error("Reference required for cancel");
      const data = await callRpc("admin_cancel_subscription", { p_reference: ref, p_email: email, p_track: track });
      appendOut(JSON.stringify(data, null, 2));
    } else if(action === "extend") {
      if(!ref) throw new Error("Reference required for extend");
      if(!days || days <= 0) throw new Error("Days must be > 0");
      const data = await callRpc("admin_extend_subscription", { p_reference: ref, p_days: days, p_email: email, p_track: track });
      appendOut(JSON.stringify(data, null, 2));
    } else {
      throw new Error("unknown_action");
    }
    setStatus("ok","Done");
  } catch (e) {
    appendOut(String(e?.message || e));
    setStatus("err","Error");
  }
}

async function doSignIn(){
  const supabase = await getSupabase();
  const email = (UI.email.value || "").trim();
  const password = UI.inPass.value || "";
  if(!email || !password) {
    setStatus("warn","Email + password required");
    return;
  }
  setStatus("warn","Signing in…");
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if(error) {
    setStatus("err", error.message || "Sign in failed");
    return;
  }
  const gate = await enforceAdminOrSignOut({
    supabase, session: data?.session,
    onDenied: () => setStatus("err","Not an admin account. Signed out.")
  });
  if(gate.ok) setStatus("ok","Signed in");
  await refreshAuthUI();
}

async function doSignOut(){
  const supabase = await getSupabase();
  setStatus("warn","Signing out…");
  try{ await supabase.auth.signOut(); }catch{}
  await refreshAuthUI();
}

async function bootstrap(){
  try {
    await getSupabase();
    UI.btnBack?.addEventListener("click", () => { window.location.href = "/admin.html"; });
    UI.btnSignOut?.addEventListener("click", (e)=>{ e.preventDefault(); doSignOut(); });
    UI.btnSignIn?.addEventListener("click", (e)=>{ e.preventDefault(); openDlg(); });
    UI.btnDoLogin?.addEventListener("click", (e)=>{ e.preventDefault(); doSignIn(); });
    UI.btnCancel?.addEventListener("click", (e)=>{ e.preventDefault(); closeDlg(); });
    UI.btnRun?.addEventListener("click", (e)=>{ e.preventDefault(); runAction(); });
    UI.btnTrust?.addEventListener("click", (e)=>{ e.preventDefault(); window.location.href="/admin.html#trust"; });

    const supabase = await getSupabase();
    if(!window.__lp_admin_auth_listener){
      window.__lp_admin_auth_listener = supabase.auth.onAuthStateChange(()=>{ setTimeout(()=>refreshAuthUI().catch(()=>{}),0); });
    }
    await refreshAuthUI();
  } catch(e) {
    setStatus("err", (e?.message||String(e)));
    openDlg();
  }
}
bootstrap();
</script>
</body>
</html>
