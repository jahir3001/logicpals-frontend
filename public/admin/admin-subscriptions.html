<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LogicPals Admin — Subscriptions</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--accent:#4f46e5;--good:#16a34a;--warn:#b45309;--bad:#dc2626;--shadow:0 18px 45px rgba(2,6,23,.08);--r:18px}
    *{box-sizing:border-box}body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:linear-gradient(180deg,#ffffff 0%, #f6f7fb 100%)}
    a{color:inherit;text-decoration:none}
    .shell{max-width:1200px;margin:28px auto;padding:0 18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;background:var(--card);border:1px solid var(--line);border-radius:22px;padding:14px 16px;box-shadow:var(--shadow)}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(135deg,#4f46e5,#06b6d4);color:#fff;font-weight:800;letter-spacing:.5px}
    .btitle{font-weight:800}
    .bsub{color:var(--muted);font-size:12px;margin-top:2px}
    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted);font-size:12px}
    .dot{width:8px;height:8px;border-radius:999px;background:#94a3b8}
    .btn{cursor:pointer;border:1px solid var(--line);background:#fff;color:var(--text);padding:10px 12px;border-radius:12px;font-weight:800}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .card .hd{padding:16px 16px 10px;border-bottom:1px solid var(--line)}
    .card .hd h2{margin:0;font-size:16px}
    .card .hd p{margin:6px 0 0;color:var(--muted);font-size:12px}
    .card .bd{padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px;font-weight:800}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#fff;outline:none}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .stack{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    pre{margin:0;padding:14px;border-radius:14px;background:#0b1220;color:#e5e7eb;min-height:220px;overflow:auto;font-size:12px}
    .note{padding:10px 12px;border-radius:14px;border:1px dashed #dbeafe;background:#eff6ff;color:#1e3a8a;font-size:12px}
    .lock{margin-top:14px;padding:12px 14px;border-radius:14px;border:1px solid rgba(220,38,38,.25);background:#fef2f2;color:#991b1b;font-size:13px;display:none}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="shell">
    <header class="top">
      <div class="brand">
        <div class="logo">LP</div>
        <div>
          <div class="btitle">Subscriptions</div>
          <div class="bsub">Admin-only — list / extend / cancel (RPC-only)</div>
        </div>
      </div>
      <div class="actions">
        <span class="chip" id="chipStatus"><span class="dot" id="dot"></span><span id="statusText">Booting…</span></span>
        <a class="btn" href="/admin.html">← Back to Admin</a>
        <a class="btn" href="/dashboard.html">Dashboard</a>
        <button class="btn primary" id="btnSignIn">Sign in</button>
        <button class="btn" id="btnSignOut" style="display:none">Sign out</button>
      </div>
    </header>

    <div id="lockBox" class="lock"></div>

    <div class="grid">
      <section class="card">
        <div class="hd">
          <h2>Manage a customer</h2>
          <p>All actions must route through RPCs so RLS + audit rules apply (Step 7).</p>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Customer email</label>
              <input id="email" placeholder="student_or_parent@email.com" autocomplete="email" />
            </div>
            <div>
              <label>Track</label>
              <select id="track">
                <option value="regular">Regular</option>
                <option value="olympiad">Olympiad</option>
              </select>
            </div>
          </div>

          <div class="row3" style="margin-top:12px">
            <div>
              <label>Extend months</label>
              <input id="months" type="number" min="1" value="1" />
            </div>
            <div>
              <label>Plan</label>
              <select id="plan">
                <option value="monthly">Monthly</option>
                <option value="annual">Annual</option>
                <option value="manual">Manual</option>
              </select>
            </div>
            <div>
              <label>Reason / note</label>
              <input id="note" placeholder="Support extension" />
            </div>
          </div>

          <div class="stack">
            <button class="btn" id="btnLoad" disabled>Load subscriptions</button>
            <button class="btn" id="btnTrust" disabled>Load trust summary</button>
            <button class="btn primary" id="btnExtend" disabled>Extend</button>
            <button class="btn" id="btnCancel" disabled>Cancel</button>
          </div>

          <div class="note" style="margin-top:12px">
            Expected RPCs: <code>admin_list_subscriptions</code>, <code>admin_extend_subscription</code>, <code>admin_cancel_subscription</code>, <code>admin_trust_summary</code>.
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <h2>Output</h2>
          <p>Raw JSON from your RPC responses.</p>
        </div>
        <div class="bd">
          <pre id="out">Waiting…</pre>
        </div>
      </section>
    </div>
  </div>

  <dialog id="dlg" style="border:none;border-radius:16px;max-width:420px;width:calc(100% - 24px);padding:0;box-shadow:0 25px 90px rgba(2,6,23,.25)">
    <form method="dialog" style="padding:16px 16px 14px;background:#fff;border-radius:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div style="font-weight:900">Admin sign-in</div>
        <button class="btn" value="cancel" style="padding:8px 10px">✕</button>
      </div>
      <div style="margin-top:12px">
        <label>Email</label>
        <input id="inEmail" autocomplete="email" />
      </div>
      <div style="margin-top:10px">
        <label>Password</label>
        <input id="inPass" type="password" autocomplete="current-password" />
      </div>
      <div class="stack" style="margin-top:12px">
        <button class="btn primary" id="btnDoLogin" value="default" type="button">Sign in</button>
        <button class="btn" value="cancel">Cancel</button>
      </div>
      <div style="margin-top:10px;color:var(--muted);font-size:12px">Use email/password for staff accounts.</div>
    </form>
  </dialog>

<script>
(function(){
  'use strict';

  const STORAGE_KEY = 'logicpals.auth';     // must match login/dashboard/admin
  const ENV_ENDPOINT = '/api/env';

  const $ = (id)=>document.getElementById(id);
  const out = (v)=>{ $('out').textContent = typeof v === 'string' ? v : JSON.stringify(v, null, 2); };

  const setStatus = (text, kind='idle')=>{
    $('statusText').textContent = text;
    $('dot').style.background = kind === 'good' ? 'var(--good)' : kind === 'bad' ? 'var(--bad)' : kind === 'warn' ? 'var(--warn)' : '#94a3b8';
  };

  const lock = (msg)=>{
    $('lockBox').style.display='block';
    $('lockBox').textContent = msg;
    ['btnLoad','btnTrust','btnExtend','btnCancel'].forEach(id=>$(id).disabled=true);
  };
  const unlock = ()=>{
    $('lockBox').style.display='none';
    $('lockBox').textContent='';
    ['btnLoad','btnTrust','btnExtend','btnCancel'].forEach(id=>$(id).disabled=false);
  };

  function hardClearAuthStorage(){
    try{
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(STORAGE_KEY + '-code-verifier');
      localStorage.removeItem(STORAGE_KEY + '-provider-token');
      localStorage.removeItem(STORAGE_KEY + '-provider-refresh-token');
    }catch(_){}
  }

  async function fetchEnv(){
    const res = await fetch(ENV_ENDPOINT, { cache:'no-store' });
    if(!res.ok) throw new Error('ENV_ENDPOINT failed: ' + res.status);
    const data = await res.json();
    const supabaseUrl = data.supabaseUrl || data.SUPABASE_URL || data.url;
    const supabaseAnonKey = data.supabaseAnonKey || data.SUPABASE_ANON_KEY || data.anonKey;
    if(!supabaseUrl || !supabaseAnonKey) throw new Error('Missing Supabase config from ' + ENV_ENDPOINT);
    return { supabaseUrl, supabaseAnonKey };
  }

  let sb = null;

  async function roleCheckFailClosed(){
    try{
      const rpcsToTry = ['get_my_role','my_role','get_current_role'];
      for(const fn of rpcsToTry){
        const { data, error } = await sb.rpc(fn);
        if(!error && data) return String(data);
      }
      return null;
    }catch(_){
      return null;
    }
  }

  async function syncAuthUI(){
    const { data:{ session } } = await sb.auth.getSession();
    const signedIn = !!session;
    $('btnSignIn').style.display = signedIn ? 'none' : '';
    $('btnSignOut').style.display = signedIn ? '' : 'none';

    if(!signedIn){
      lock('Sign-in required.');
      setStatus('Signed out','warn');
      return;
    }

    setStatus('Verifying access…','warn');
    const role = await roleCheckFailClosed();
    if(!role){
      lock('Access verification RPC missing. Add get_my_role() (or tell me your role RPC name). Locked by design.');
      setStatus('Locked','bad');
      return;
    }

    const allowed = ['super_admin','admin_regular','admin_olympiad','admin'].includes(role);
    if(!allowed){
      lock(`Not an admin. Role="${role}". Locked.`);
      setStatus('Locked','bad');
      return;
    }

    unlock();
    setStatus('Ready','good');
  }

  async function rpc(fn, args){
    const { data, error } = await sb.rpc(fn, args);
    if(error) throw error;
    return data;
  }

  async function init(){
    setStatus('Booting…','idle');
    lock('Booting…');

    let env;
    try{
      env = await fetchEnv();
    }catch(e){
      setStatus('Missing env','bad');
      lock('Missing Supabase config from /api/env. Fix /api/env first.');
      out('Missing env: ' + (e && e.message ? e.message : String(e)));
      $('btnSignIn').disabled = true;
      return;
    }

    sb = window.supabase.createClient(env.supabaseUrl, env.supabaseAnonKey, {
      auth: { storageKey: STORAGE_KEY, persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
    });

    $('btnSignIn').onclick = ()=> $('dlg').showModal();
    $('btnSignOut').onclick = async ()=>{ setStatus('Signing out…','warn'); try{ await sb.auth.signOut({ scope:'global' }); }catch(_){ } hardClearAuthStorage(); await syncAuthUI(); };

    $('btnDoLogin').onclick = async ()=>{
      const email = $('inEmail').value.trim();
      const password = $('inPass').value;
      if(!email || !password) return;
      out('Signing in…');
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error) out({ error: error.message });
      else out('Signed in.');
      $('dlg').close();
      await syncAuthUI();
    };

    const getInputs = ()=>({
      email: $('email').value.trim(),
      track: $('track').value,
      months: Math.max(1, parseInt($('months').value || '1',10)),
      plan: $('plan').value,
      note: $('note').value.trim() || null,
    });

    $('btnLoad').onclick = async ()=>{
      try{
        const { email, track } = getInputs();
        if(!email) return out('Enter a customer email first.');
        out(await rpc('admin_list_subscriptions', { p_email: email, p_track: track }));
      }catch(e){ out({ error: e.message }); }
    };
    $('btnTrust').onclick = async ()=>{
      try{
        const { email, track } = getInputs();
        if(!email) return out('Enter a customer email first.');
        out(await rpc('admin_trust_summary', { p_email: email, p_track: track }));
      }catch(e){ out({ error: e.message }); }
    };
    $('btnExtend').onclick = async ()=>{
      try{
        const { email, track, months, plan, note } = getInputs();
        if(!email) return out('Enter a customer email first.');
        out(await rpc('admin_extend_subscription', { p_email: email, p_track: track, p_months: months, p_plan: plan, p_note: note }));
      }catch(e){ out({ error: e.message }); }
    };
    $('btnCancel').onclick = async ()=>{
      try{
        const { email, track, note } = getInputs();
        if(!email) return out('Enter a customer email first.');
        out(await rpc('admin_cancel_subscription', { p_email: email, p_track: track, p_note: note }));
      }catch(e){ out({ error: e.message }); }
    };

    await syncAuthUI();
    sb.auth.onAuthStateChange(()=> syncAuthUI());
  }

  window.addEventListener('pageshow', (e)=>{ if(e.persisted) location.reload(); });

  init();
})();
</script>
</body>
</html>
