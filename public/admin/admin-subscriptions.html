<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LogicPals Admin — Subscriptions</title>
  
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--accent:#4f46e5;--good:#16a34a;--warn:#b45309;--bad:#dc2626;--shadow:0 18px 45px rgba(2,6,23,.08);--r:18px}
    *{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--text);background:linear-gradient(180deg,#ffffff 0%, #f6f7fb 100%)}
    a{color:inherit;text-decoration:none}
    .shell{max-width:1200px;margin:28px auto;padding:0 18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;background:var(--card);border:1px solid var(--line);border-radius:22px;padding:14px 16px;box-shadow:var(--shadow)}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(135deg,#4f46e5,#06b6d4);color:#fff;font-weight:800;letter-spacing:.5px}
    .btitle{font-weight:800}
    .bsub{color:var(--muted);font-size:12px;margin-top:2px}
    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted);font-size:12px}
    .dot{width:8px;height:8px;border-radius:999px;background:#94a3b8}
    .btn{cursor:pointer;border:1px solid var(--line);background:#fff;color:var(--text);padding:10px 12px;border-radius:12px;font-weight:700}
    .btn:hover{border-color:#cbd5e1}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.primary:hover{filter:brightness(.96)}
    .btn.ghost{background:transparent}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .card .hd{padding:16px 16px 10px;border-bottom:1px solid var(--line)}
    .card .hd h2{margin:0;font-size:16px}
    .card .hd p{margin:6px 0 0;color:var(--muted);font-size:12px}
    .card .bd{padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#fff;outline:none}
    input:focus,select:focus{border-color:#b9c3ff;box-shadow:0 0 0 4px rgba(79,70,229,.12)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .stack{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    pre{margin:0;padding:14px;border-radius:14px;background:#0b1220;color:#e5e7eb;min-height:220px;overflow:auto;font-size:12px}
    .note{padding:10px 12px;border-radius:14px;border:1px dashed #dbeafe;background:#eff6ff;color:#1e3a8a;font-size:12px}
    .warn{padding:10px 12px;border-radius:14px;border:1px dashed #fed7aa;background:#fff7ed;color:#7c2d12;font-size:12px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
  </style>
  <script src="/assets/js/env-loader.js"></script>
</head>
<body>
  <div class="shell">
    <header class="top">
      <div class="brand">
        <div class="logo">LP</div>
        <div>
          <div class="btitle">Subscriptions</div>
          <div class="bsub">Admin-only — list / extend / cancel (RPC-only)</div>
        </div>
      </div>
      <div class="actions">
        <span class="chip" id="chipStatus"><span class="dot" id="dot"></span><span id="statusText">Loading…</span></span>
        <button class="btn ghost" id="btnBack">← Back to Admin</button>
        <button class="btn" id="btnDashboard">Dashboard</button>
        <button class="btn primary" id="btnSignIn">Sign in</button>
        <button class="btn" id="btnSignOut" style="display:none">Log out</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="hd">
          <h2>Manage a customer</h2>
          <p>All actions must route through RPCs so RLS + audit rules apply (Step 7).</p>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Customer email</label>
              <input id="email" placeholder="student_or_parent@email.com" autocomplete="email" />
            </div>
            <div>
              <label>Track</label>
              <select id="track">
                <option value="regular">Regular</option>
                <option value="olympiad">Olympiad</option>
              </select>
            </div>
          </div>

          <div class="row3" style="margin-top:12px">
            <div>
              <label>Extend months</label>
              <input id="months" type="number" min="1" value="1" />
            </div>
            <div>
              <label>Plan</label>
              <select id="plan">
                <option value="monthly">Monthly</option>
                <option value="annual">Annual</option>
                <option value="manual">Manual</option>
              </select>
            </div>
            <div>
              <label>Reason / note</label>
              <input id="note" placeholder="Support extension" />
            </div>
          </div>

          <div class="stack">
            <button class="btn" id="btnLoad">Load subscriptions</button>
            <button class="btn" id="btnTrust">Load trust summary</button>
            <button class="btn primary" id="btnExtend">Extend</button>
            <button class="btn" id="btnCancel">Cancel</button>
          </div>

          <div class="warn" style="margin-top:12px">
            Expected RPCs (you can rename — just update here):
            <code>admin_list_subscriptions</code>, <code>admin_extend_subscription</code>, <code>admin_cancel_subscription</code>, <code>admin_trust_summary</code>.
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <h2>Output</h2>
          <p>Raw JSON from your RPC responses.</p>
        </div>
        <div class="bd">
          <pre id="out">Waiting…</pre>
          <div class="note" style="margin-top:12px">
            If you see “permission denied”, that’s GOOD — it means RLS is enforcing. Then assign your admin role and retry.
          </div>
        </div>
      </section>
    </div>
  </div>

  <dialog id="dlg" style="border:none;border-radius:16px;max-width:420px;width:calc(100% - 24px);padding:0;box-shadow:0 25px 90px rgba(2,6,23,.25)">
    <form method="dialog" style="padding:16px 16px 14px;background:#fff;border-radius:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div style="font-weight:900">Admin sign-in</div>
        <button class="btn" value="cancel" style="padding:8px 10px">✕</button>
      </div>
      <div style="margin-top:12px">
        <label>Email</label>
        <input id="inEmail" autocomplete="email" />
      </div>
      <div style="margin-top:10px">
        <label>Password</label>
        <input id="inPass" type="password" autocomplete="current-password" />
      </div>
      <div class="stack" style="margin-top:12px">
        <button class="btn primary" id="btnDoLogin" value="default" type="button">Sign in</button>
        <button class="btn" value="cancel">Cancel</button>
      </div>
      <div style="margin-top:10px;color:var(--muted);font-size:12px">Use email/password for staff accounts. (Student/parent login stays in the main app.)</div>
    </form>
  </dialog>

  <script>
  // LogicPals Admin Subscriptions — Enterprise Auth Gate + RPC Runner
  (function () {
    'use strict';

    const ADMIN_ROLES = new Set(['super_admin', 'admin_regular', 'admin_olympiad', 'admin']);
    const $ = (id) => document.getElementById(id);
    const withTimeout = async (p, ms, label) => {
      let t;
      const timeout = new Promise((_, rej) => (t = setTimeout(() => rej(new Error(label || 'timeout')), ms)));
      try { return await Promise.race([p, timeout]); } finally { clearTimeout(t); }
    };

    function setHeaderStatus(kind, text) {
      const el = $('hdrStatus');
      if (!el) return;
      el.className = 'status-pill ' + (kind || '');
      el.textContent = text || '';
    }

    function setIdentity(email, role) {
      const e = $('signedInEmail'); if (e) e.textContent = email || '—';
      const r = $('signedInRole'); if (r) r.textContent = role || 'unknown';
    }

    function logOutBox(text) {
      const out = $('rpcOut');
      if (!out) return;
      out.textContent = text || '';
    }

    async function getSupabase() {
      if (window.__LP_ADMIN_SUPABASE__) return window.__LP_ADMIN_SUPABASE__;
      if (!window.supabase || !window.supabase.createClient) throw new Error('supabase_js_missing');

      let env = null;
      try { const r = await fetch('/api/env', { cache: 'no-store' }); if (r.ok) env = await r.json(); } catch (_) {}
      const url = env?.SUPABASE_URL || window.SUPABASE_URL || '';
      const anon = env?.SUPABASE_ANON_KEY || window.SUPABASE_ANON_KEY || '';
      if (!url || !anon) throw new Error('supabase_env_missing');

      const client = window.supabase.createClient(url, anon, {
        auth: {
          storageKey: 'lp_admin_auth',
          storage: window.sessionStorage,
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: false
        }
      });
      window.__LP_ADMIN_SUPABASE__ = client;
      return client;
    }

    async function inferRole(session) {
      const u = session?.user;
      const metaRole =
        u?.app_metadata?.role ||
        u?.user_metadata?.role ||
        u?.app_metadata?.lp_role ||
        u?.user_metadata?.lp_role;
      if (typeof metaRole === 'string' && metaRole.trim()) return metaRole.trim();

      const sb = await getSupabase();
      const candidates = ['get_my_role', 'rpc_lp_my_role', 'admin_get_role', 'rp_admin_get_role', 'current_role'];
      for (const fn of candidates) {
        try {
          const { data, error } = await sb.rpc(fn);
          if (!error) {
            if (typeof data === 'string') return data;
            if (data && typeof data.role === 'string') return data.role;
          }
        } catch (_) {}
      }
      return 'unknown';
    }

    async function requireAdmin() {
      const sb = await getSupabase();
      const { data } = await sb.auth.getSession();
      const session = data?.session || null;
      if (!session) {
        window.location.href = '/admin.html';
        return null;
      }
      const role = await inferRole(session);
      setIdentity(session.user.email, role);

      if (!ADMIN_ROLES.has(role)) {
        try { await withTimeout(sb.auth.signOut(), 6000, 'signout_timeout'); } catch (_) {}
        window.location.href = '/admin.html';
        return null;
      }
      return { sb, session, role };
    }

    async function signOut() {
      setHeaderStatus('warn', 'Signing out…');
      const sb = await getSupabase();
      try { await withTimeout(sb.auth.signOut(), 6000, 'signout_timeout'); } catch (_) {}
      window.location.href = '/admin.html';
    }

    async function runAction() {
      const ctx = await requireAdmin();
      if (!ctx) return;
      const { sb } = ctx;

      const email = $('customerEmail')?.value?.trim() || '';
      const track = $('track')?.value || 'regular';
      const action = $('action')?.value || 'list';
      const ref = $('reference')?.value?.trim() || null;

      logOutBox('Working…');

      try {
        let rpcName = '';
        let payload = {};

        if (action === 'list') {
          rpcName = 'admin_list_subscriptions';
          payload = { p_customer_email: email || null, p_track: track };
        } else if (action === 'activate') {
          rpcName = 'admin_activate_subscription';
          payload = { p_customer_email: email || null, p_track: track, p_reference: ref };
        } else if (action === 'cancel') {
          rpcName = 'admin_cancel_subscription';
          payload = { p_customer_email: email || null, p_track: track, p_reference: ref };
        } else {
          throw new Error('Unknown action');
        }

        const { data, error } = await withTimeout(sb.rpc(rpcName, payload), 15000, 'rpc_timeout');
        if (error) throw error;

        logOutBox(JSON.stringify({ ok: true, rpc: rpcName, data }, null, 2));
        setHeaderStatus('good', 'Ready');
      } catch (e) {
        logOutBox(JSON.stringify({ ok: false, error: e?.message || String(e) }, null, 2));
        setHeaderStatus('bad', 'Error');
      }
    }

    function bindUI() {
      $('btnBack')?.addEventListener('click', () => (window.location.href = '/admin.html'));
      $('btnSignOut')?.addEventListener('click', signOut);
      $('btnRun')?.addEventListener('click', runAction);
    }

    let booted = false;
    async function bootstrap() {
      if (booted) return;
      booted = true;
      try {
        bindUI();
        setHeaderStatus('warn', 'Loading…');
        await requireAdmin();
        setHeaderStatus('good', 'Ready');
      } catch (e) {
        console.error(e);
        setHeaderStatus('bad', 'Boot error');
        logOutBox('Boot error: ' + (e?.message || String(e)));
      }
    }

    bootstrap();
  })();
</script>
</body>
</html>
