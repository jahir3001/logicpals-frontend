<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LogicPals</title>

  <!-- Keep your existing CSS links as-is if you already have them -->
  <style>
    /* Minimal safe styling only (doesn't break your layout) */
    #lpEnvError { display:none; padding:12px; border:1px solid #f1c40f; background:#fff7db; color:#5a4b00; border-radius:10px; margin:12px 0; }
  </style>

  <!-- Supabase JS (keep) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <!-- Your existing page HTML stays the same below.
       I’m not rewriting your page layout—only patching auth/env boot. -->

  <!-- OPTIONAL: if you already have a nav login link, this will attach next to it -->
  <!-- If you do NOT have a /login.html link, search "href=\"/login.html\"" and keep it -->
  <!-- Admin link is hidden unless user role is admin -->
  <div id="lpEnvError"></div>

  <script>
    (function () {
      // Service worker disabled (service-worker.js not shipped in this static build)

      function showEnvError(msg) {
        const el = document.getElementById('lpEnvError');
        if (!el) return;
        el.style.display = 'block';
        el.textContent = msg;
      }

      async function getEnv() {
        try {
          // Cache-bust + no-store to prevent stale edge caches
          const res = await fetch('/api/env?ts=' + Date.now(), { cache: 'no-store' });
          if (!res.ok) throw new Error('env_http_' + res.status);
          return await res.json();
        } catch (e) {
          return null;
        }
      }

      async function boot() {
        const env = await getEnv();
        if (!env || !env.SUPABASE_URL || !env.SUPABASE_ANON_KEY) {
          // Don’t hard-fail the landing page, but show a clear warning.
          showEnvError('Missing Supabase config. Ensure /api/env is deployed and reachable.');
          return;
        }

        const SB_URL = env.SUPABASE_URL;
        const SB_KEY = env.SUPABASE_ANON_KEY;

        // IMPORTANT: Use standard Supabase auth behavior (persist session)
        const supabaseClient = supabase.createClient(
          SB_URL,
          SB_KEY,
          { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
        );

        // If current user is admin/super_admin, show Admin link.
        (async () => {
          try {
            const session = (await supabaseClient.auth.getSession()).data.session;
            if (!session) return;
            const { data: roleVal } = await supabaseClient.rpc('get_my_role');
            const r = (roleVal || '').toString();
            if (r.includes('admin') || r === 'super_admin') {
              // Try to find an existing login link and attach admin next to it.
              // If you already have an Admin link, nothing breaks.
              let adminLink = document.getElementById('navAdmin');
              if (!adminLink) {
                adminLink = document.createElement('a');
                adminLink.id = 'navAdmin';
                adminLink.href = '/admin.html';
                adminLink.textContent = 'Admin';
                adminLink.style.display = 'inline-block';
                adminLink.style.marginLeft = '16px';
                adminLink.style.fontWeight = '600';

                // Best-effort insert near header/login area
                const loginAnchor = document.querySelector('a[href="/login.html"], a[href="login.html"]');
                if (loginAnchor && loginAnchor.parentElement) {
                  loginAnchor.parentElement.insertBefore(adminLink, loginAnchor.nextSibling);
                } else {
                  document.body.insertBefore(adminLink, document.body.firstChild);
                }
              } else {
                adminLink.style.display = 'inline-block';
              }
            }
          } catch (e) {}
        })();

        // No more auth logic needed for index page.
        // Landing page should remain usable for signed-out visitors.
      }

      boot();
    })();
  </script>
</body>
</html>