<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LogicPals Console</title>

  <!-- Shared design system -->
  <link rel="stylesheet" href="/lp_design.css"/>

  <!-- Env injector (must set window.__LP_ENV) -->
  <script src="/api/env"></script>

  <!-- Supabase client (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Force “clean white” admin surface even if lp_design.css changes later */
    body{background:var(--lp-bg, #f5f7fb);}
    .lp-shell{max-width:1200px;margin:0 auto;padding:24px;}
    .lp-topbar{display:flex;align-items:center;justify-content:space-between;gap:16px;background:#fff;border:1px solid rgba(15,23,42,.08);border-radius:16px;padding:14px 16px;box-shadow:0 10px 30px rgba(2,6,23,.06);position:sticky;top:12px;z-index:10;}
    .lp-brand{display:flex;align-items:center;gap:12px;}
    .lp-logo{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,#5b8cff,#7c3aed);color:#fff;font-weight:800;letter-spacing:.5px;}
    .lp-title{line-height:1.1}
    .lp-title b{display:block;font-size:16px;color:#0f172a}
    .lp-title span{display:block;font-size:12px;color:#64748b}
    .lp-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .lp-pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(15,23,42,.10);background:#fff;border-radius:999px;padding:8px 12px;font-size:12px;color:#0f172a}
    .dot{width:8px;height:8px;border-radius:999px;background:#94a3b8}
    .dot.ok{background:#22c55e}
    .dot.bad{background:#ef4444}
    .lp-btn{appearance:none;border:1px solid rgba(15,23,42,.12);background:#fff;border-radius:12px;padding:10px 12px;font-weight:600;font-size:13px;color:#0f172a;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .lp-btn.primary{background:#4f46e5;color:#fff;border-color:transparent}
    .lp-btn.danger{background:#fff;color:#b91c1c;border-color:rgba(185,28,28,.25)}
    .lp-grid{display:grid;grid-template-columns:320px 1fr;gap:18px;margin-top:18px}
    @media (max-width: 980px){.lp-grid{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid rgba(15,23,42,.08);border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.06);}
    .card h3{margin:0;padding:16px 16px 0 16px;font-size:16px;color:#0f172a}
    .card .sub{padding:6px 16px 16px 16px;color:#64748b;font-size:13px;border-bottom:1px solid rgba(15,23,42,.06)}
    .kv{padding:12px 16px;display:grid;gap:10px}
    .kv .row{display:flex;justify-content:space-between;gap:12px;color:#0f172a;font-size:13px}
    .kv .row small{color:#64748b}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;padding:14px 16px;border-bottom:1px solid rgba(15,23,42,.06)}
    .tab{padding:10px 12px;border-radius:12px;border:1px solid rgba(15,23,42,.10);background:#fff;font-weight:700;font-size:13px;color:#0f172a;cursor:pointer}
    .tab.active{background:#eef2ff;border-color:rgba(79,70,229,.25);color:#3730a3}
    .panel{display:none;padding:16px}
    .panel.active{display:block}
    .notice{border:1px solid rgba(245,158,11,.25);background:#fffbeb;border-radius:14px;padding:12px 14px;color:#92400e;font-size:13px}
    .good{border:1px solid rgba(34,197,94,.25);background:#f0fdf4;color:#166534}
    .muted{color:#64748b}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .list{margin:0;padding-left:18px}
    .list li{margin:8px 0}
  </style>
</head>

<body>
  <div class="lp-shell">
    <header class="lp-topbar">
      <div class="lp-brand">
        <div class="lp-logo">LP</div>
        <div class="lp-title">
          <b>LogicPals Console</b>
          <span>Enterprise Admin System</span>
        </div>
      </div>

      <div class="lp-actions">
        <div class="lp-pill" id="authPill"><span class="dot" id="authDot"></span><span id="authText">Loading…</span></div>
        <a class="lp-btn" href="/" id="btnVisit">Visit Site</a>
        <a class="lp-btn" href="/dashboard.html" id="btnDashboard">Dashboard</a>
        <button class="lp-btn primary" id="btnSignIn">Sign in</button>
        <button class="lp-btn danger" id="btnSignOut" style="display:none;">Log out</button>
      </div>
    </header>

    <div class="lp-grid">
      <aside class="card">
        <h3>Console Status</h3>
        <div class="sub">Access controlled via DB roles + RPC gates (Step 7)</div>
        <div class="kv">
          <div class="row"><small>Project</small><span>LogicPals-App</span></div>
          <div class="row"><small>Auth state</small><span id="authState" class="mono">unknown</span></div>
          <div class="row"><small>Role</small><span id="roleBadge" class="mono">unknown</span></div>
          <div class="row"><small>User</small><span id="userEmail" class="mono">—</span></div>
          <div class="notice" id="roleNote">
            Sign in to load admin capabilities. If your role is <span class="mono">super_admin</span>, you can assign roles and manage monetization.
          </div>
        </div>
      </aside>

      <main class="card">
        <div class="tabs">
          <button class="tab active" data-tab="overview">Overview</button>
          <button class="tab" data-tab="content">Content</button>
          <button class="tab" data-tab="monetization">Monetization</button>
          <button class="tab" data-tab="access">Access</button>
        </div>

        <section class="panel active" id="tab-overview">
          <div class="notice good"><b>Roadmap Contract:</b> Admin UI never directly writes protected tables. All mutations go through RPC + audit events.</div>
          <br/>
          <ul class="list">
            <li><b>Regular Review</b> — manage regular content (admin_regular, super_admin)</li>
            <li><b>Olympiad Review</b> — strict QC + blocking (admin_olympiad, super_admin)</li>
            <li><b>Payments / Subscriptions</b> — RPC-only actions with receipts and audit</li>
            <li><b>Role Management</b> — super_admin only</li>
          </ul>
        </section>

        <section class="panel" id="tab-content">
          <h3 style="margin:0 0 10px 0;">Content Operations</h3>
          <div class="notice">
            <b>Olympiad must remain strict & deterministic.</b> Any “approve/publish” action must be an RPC that enforces Gate results.
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;">
            <button class="lp-btn" id="btnRegularUpload">Regular: Upload / Manage</button>
            <button class="lp-btn" id="btnOlympiadUpload">Olympiad: Upload</button>
            <button class="lp-btn primary" id="btnOlympiadReview">Olympiad: QC Review Queue</button>
          </div>
          <p class="muted" style="margin-top:12px;">
            These buttons can route to dedicated pages later (recommended). For now they can open internal panels or placeholders.
          </p>
        </section>

        <section class="panel" id="tab-monetization">
          <h3 style="margin:0 0 10px 0;">Monetization (RPC-only)</h3>
          <div class="notice">
            <b>No direct DB writes from browser.</b> Payments/subscriptions actions must be admin RPCs (Step 7).
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;">
            <a class="lp-btn primary" href="/admin-payments.html" id="linkPayments">Payments</a>
            <a class="lp-btn" href="/admin-subscriptions.html" id="linkSubs">Subscriptions</a>
          </div>
        </section>

        <section class="panel" id="tab-access">
          <h3 style="margin:0 0 10px 0;">Access & Roles</h3>
          <div class="notice">
            Role assignment should be <b>super_admin</b> only. If your current user is not super_admin, this section will be read-only.
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;">
            <button class="lp-btn" id="btnRoleManager">Open Role Manager</button>
            <button class="lp-btn" id="btnAudit">View Admin Audit</button>
          </div>
          <p class="muted" style="margin-top:12px;">We can wire these to Step 7 RPCs once you confirm your function names.</p>
        </section>

      </main>
    </div>
  </div>

  <!-- Sign-in modal (simple, reliable) -->
  <dialog id="dlgLogin" style="border:none;border-radius:16px;max-width:420px;width:calc(100% - 24px);padding:0;box-shadow:0 20px 70px rgba(2,6,23,.25);">
    <div style="padding:16px 16px 0 16px;background:#fff;border-bottom:1px solid rgba(15,23,42,.08);border-top-left-radius:16px;border-top-right-radius:16px;">
      <b style="font-size:16px;color:#0f172a;">Admin Sign in</b>
      <div class="muted" style="font-size:13px;margin-top:4px;">Use your admin account email + password.</div>
    </div>
    <div style="padding:16px;background:#fff;border-bottom-left-radius:16px;border-bottom-right-radius:16px;">
      <label class="muted" style="font-size:12px;">Email</label>
      <input id="loginEmail" type="email" autocomplete="email" placeholder="you@example.com"
             style="width:100%;margin-top:6px;padding:12px;border-radius:12px;border:1px solid rgba(15,23,42,.12);"/>
      <div style="height:10px;"></div>
      <label class="muted" style="font-size:12px;">Password</label>
      <input id="loginPass" type="password" autocomplete="current-password" placeholder="••••••••"
             style="width:100%;margin-top:6px;padding:12px;border-radius:12px;border:1px solid rgba(15,23,42,.12);"/>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap;">
        <button class="lp-btn" id="btnCancelLogin" type="button">Cancel</button>
        <button class="lp-btn primary" id="btnDoLogin" type="button">Sign in</button>
      </div>
      <pre id="loginOut" class="mono" style="white-space:pre-wrap;background:#0b1220;color:#e5e7eb;padding:12px;border-radius:12px;margin-top:12px;display:none;"></pre>
    </div>
  </dialog>

  <script>
    // --- Guard: stop hard failures from killing the UI ---
    function safe(fn){ try{ fn(); } catch(e){ console.error(e); } }

    const $ = (id)=>document.getElementById(id);

    function setAuthPill(state, email){
      const dot = $('authDot');
      const text = $('authText');
      $('authState').textContent = state;
      $('userEmail').textContent = email || '—';
      if(state === 'authenticated'){
        dot.className = 'dot ok';
        text.textContent = `Signed in${email ? ': ' + email : ''}`;
      }else{
        dot.className = 'dot';
        text.textContent = 'Signed out';
      }
    }

    function setRole(role){
      $('roleBadge').textContent = role || 'none';
      // optional: show/hide certain buttons based on role
    }

    function initTabs(){
      document.querySelectorAll('.tab').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
          document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
          btn.classList.add('active');
          const id = 'tab-' + btn.dataset.tab;
          const panel = document.getElementById(id);
          if(panel) panel.classList.add('active');
        });
      });
    }

    // --- Supabase init ---
    let supabase = null;

    function getEnv(){
      // window.__LP_ENV comes from /api/env
      if(!window.__LP_ENV || !window.__LP_ENV.SUPABASE_URL || !window.__LP_ENV.SUPABASE_ANON_KEY){
        throw new Error('Missing window.__LP_ENV. /api/env did not load or did not set SUPABASE_URL/ANON_KEY.');
      }
      return window.__LP_ENV;
    }

    async function fetchRole(userId){
      // Best-effort role lookup.
      // If you already have an RPC like public.rpc_lp_my_role() use it here.
      // Fallback: try view/table read (will succeed only if your RLS permits).
      try{
        // Preferred: RPC (change name if needed)
        const { data, error } = await supabase.rpc('rpc_lp_my_role');
        if(!error && data) return data;
      }catch(_){}
      try{
        const { data, error } = await supabase
          .from('user_roles')
          .select('role')
          .eq('user_id', userId)
          .maybeSingle();
        if(!error && data && data.role) return data.role;
      }catch(_){}
      return 'none';
    }

    async function refreshAuth(){
      const { data } = await supabase.auth.getSession();
      const session = data?.session || null;
      if(!session){
        setAuthPill('none', null);
        setRole('none');
        $('btnSignIn').style.display = '';
        $('btnSignOut').style.display = 'none';
        return;
      }
      const email = session.user?.email || '';
      setAuthPill('authenticated', email);
      $('btnSignIn').style.display = 'none';
      $('btnSignOut').style.display = '';
      const role = await fetchRole(session.user.id);
      setRole(role);
    }

    async function doLogin(){
      const email = $('loginEmail').value.trim();
      const pass = $('loginPass').value;
      $('loginOut').style.display = 'none';
      const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if(error){
        $('loginOut').style.display = 'block';
        $('loginOut').textContent = 'Login failed: ' + error.message;
        return;
      }
      $('dlgLogin').close();
      await refreshAuth();
    }

    async function doLogout(){
      await supabase.auth.signOut();
      await refreshAuth();
    }

    safe(async ()=>{
      initTabs();

      // Always keep “Payments/Subscriptions/Visit/Dashboard” as real links even if JS fails.
      // (They are anchors already.)

      // Build supabase client using env
      const env = getEnv();
      if(!window.supabase || !window.supabase.createClient){
        throw new Error('Supabase UMD did not load. Check network for https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
      }
      supabase = window.supabase.createClient(env.SUPABASE_URL, env.SUPABASE_ANON_KEY);

      // wire buttons
      $('btnSignIn').addEventListener('click', ()=> $('dlgLogin').showModal());
      $('btnCancelLogin').addEventListener('click', ()=> $('dlgLogin').close());
      $('btnDoLogin').addEventListener('click', doLogin);
      $('btnSignOut').addEventListener('click', doLogout);

      // placeholder actions
      $('btnRegularUpload').addEventListener('click', ()=>alert('Regular upload/manage: wire to your content admin page (RPC-only).'));
      $('btnOlympiadUpload').addEventListener('click', ()=>alert('Olympiad upload: wire to your Olympiad content pipeline (QC gating).'));
      $('btnOlympiadReview').addEventListener('click', ()=>alert('Olympiad QC review queue: wire to Step 7 review RPC + fail reasons.'));
      $('btnRoleManager').addEventListener('click', ()=>alert('Role manager: super_admin-only RPC.'));
      $('btnAudit').addEventListener('click', ()=>alert('Audit viewer: read-only safe view.'));

      supabase.auth.onAuthStateChange(()=>{ refreshAuth(); });

      await refreshAuth();
    });
  </script>
</body>
</html>
