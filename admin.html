<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LogicPals Admin Console</title>
  

  <link rel="stylesheet" href="lp_design.css" />
</head>
<body>
  <div class="wrap">
    <div class="lp-topbar">
      <div class="lp-brand">
        <div class="lp-logo"></div>
        <div>
          <div class="lp-title">LogicPals Admin Console</div>
          <div class="lp-sub">Enterprise review console — Regular + Olympiad tracks</div>
        </div>
      </div>

      <div class="lp-nav" id="nav"></div>

      <div class="lp-right">
        <div class="lp-badge" id="who">Signed out</div>
        <button class="lp-btn" id="btnVisit">Visit site</button>
        <button class="lp-btn" id="btnStudent">Student dashboard</button>
        <button class="lp-btn" id="btnRoles" style="display:none">Admin roles</button>
        <button class="lp-btn primary" id="btnSignIn">Sign in</button>
        <button class="lp-btn danger" id="btnSignOut" style="display:none">Log out</button>
      </div>
    </div>

    <div class="lp-grid">
      <div class="lp-card" id="leftCard">
        <div class="lp-panelTitle">
          <h3>Console status</h3>
          <span class="lp-statusPill" id="roleBadge">role: -</span>
        </div>
        <div class="lp-small muted" id="statusText">Sign in to start.</div>
        <div style="height:10px"></div>
        <div class="k"><div class="muted small">Project</div><div class="mono small" id="projectName">LogicPals-App</div></div>
        <div class="k"><div class="muted small">Auth</div><div class="mono small" id="authState">none</div></div>
        <div class="k"><div class="muted small">Role source</div><div class="mono small" id="roleSource">-</div></div>
        <div class="k"><div class="muted small">Notes</div><div class="lp-small muted">Access is controlled by <span class="lp-mono">public.user_roles</span> and enforced by RPCs + RLS.</div></div>
      </div>

      <div class="lp-card" id="mainCard">
        <div class="lp-panelTitle">
          <h3 id="viewTitle">Dashboard</h3>
          <span class="lp-statusPill" id="accessPill">Ready</span>
        </div>

        <div id="viewDashboard">
          <div class="lp-muted">This console supports:</div>
          <ul class="lp-muted" style="margin-top:8px">
            <li><b>Regular review</b> (admin_regular, super_admin)</li>
            <li><b>Olympiad review</b> (admin_olympiad, super_admin)</li>
            <li><b>Role assignment</b> (super_admin only)</li>
          </ul>
          <div class="lp-hint">Tip: keep <span class="lp-mono">super_admin</span> very small (1–2 people).</div>
        </div>

        <div id="viewQueue" style="display:none">
          <div class="filters">
            <div class="full">
              <label>Search</label>
              <input id="qSearch" placeholder="title / tag / category / skill_track..." />
            </div>
            <div>
              <label>Difficulty</label>
              <select id="qDifficulty">
                <option value="">Any</option>
                <option>easy</option><option>medium</option><option>hard</option>
              </select>
            </div>
            <div>
              <label>Age</label>
              <select id="qAge">
                <option value="">Any</option>
                <option>8-9</option><option>9-10</option><option>10-11</option><option>11-12</option>
              </select>
            </div>
            <div>
              <label>Only Active</label>
              <select id="qActive">
                <option value="">Any</option>
                <option value="true">Yes</option>
                <option value="false">No</option>
              </select>
            </div>
            <div>
              <label>Sort</label>
              <select id="qSort">
                <option value="new">Newest first</option>
                <option value="old">Oldest first</option>
              </select>
            </div>
            <div class="full row">
              <button class="lp-btn primary" id="btnApply">Apply filters</button>
              <button class="lp-btn" id="btnRefresh">Refresh</button>
              <button class="lp-btn" id="btnAdd" title="Create a new problem (requires DB permissions)">Add problem</button>
              <div class="lp-badge" id="rowsBadge">Rows 0</div>
            </div>
          </div>

          <div id="queueEmpty" class="lp-muted">No rows yet. Try adjusting filters, or refresh.</div>
          <div style="overflow:auto" id="queueTableWrap"></div>
        </div>

        <div id="viewUsers" style="display:none">
          <div class="lp-muted">Use this panel to check roles for emails. Role assignment is in <b>Admin roles</b> (super_admin only).</div>
          <div class="filters" style="margin-top:12px">
            <div class="full">
              <label>User email</label>
              <input id="uEmail" placeholder="e.g. jahir3001@gmail.com" />
            </div>
            <div class="full row">
              <button class="lp-btn primary" id="btnLookup">Lookup role</button>
              <button class="lp-btn" id="btnListMe">List my roles</button>
            </div>
          </div>
          <pre class="lp-mono" id="usersOut" style="white-space:pre-wrap;margin:0;background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:14px;padding:10px;min-height:80px"></pre>
        </div>

        <div id="viewPayments" style="display:none">
          <div class="lp-muted">Payments dashboard lives on its own page. Open it in a new tab (keeps your admin session here).</div>
          <div class="lp-row" style="margin-top:12px">
            <button class="lp-btn primary" id="btnOpenPayments">Open Payments page</button>
          </div>
        </div>

        <div id="viewSubs" style="display:none">
          <div class="lp-muted">Subscriptions dashboard lives on its own page. Open it in a new tab (keeps your admin session here).</div>
          <div class="lp-row" style="margin-top:12px">
            <button class="lp-btn primary" id="btnOpenSubs">Open Subscriptions page</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Login overlay -->
  <div class="lp-overlay" id="loginOverlay" aria-hidden="true">
    <div class="loginCard">
      <div class="loginHead">
        <div class="loginTitle">
          <div class="lp-logo" style="width:36px;height:36px;border-radius:12px"></div>
          <div>
            <h2>LogicPals Admin Console</h2>
            <div class="lp-sub">Secure console access (enterprise-grade)</div>
          </div>
        </div>
        <button class="x" id="loginClose" title="Close">✕</button>
      </div>

      <div style="display:grid;grid-template-columns:1fr;gap:10px">
        <div>
          <label>Email</label>
          <input id="loginEmail" placeholder="Email" autocomplete="email" />
        </div>
        <div>
          <label>Password</label>
          <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password" />
        </div>

        <div class="lp-row" style="justify-content:space-between;align-items:center">
          <button class="lp-btn primary" id="loginBtn">Sign in</button>
          <div class="lp-small muted">Only users with admin roles can access this console.</div>
        </div>
        <div class="lp-hint">Tip: If you opened this file by double-click (file:///...), use a local server. Modules + CORS require http://localhost.</div>
        <pre class="lp-mono" id="loginOut" style="white-space:pre-wrap;margin:0;background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:14px;padding:10px;min-height:52px"></pre>
      </div>
    </div>
  </div>

  <!-- Role assignment modal (super_admin only) -->
  <div class="lp-modal" id="rolesModal" aria-hidden="true">
    <div class="lp-modalCard">
      <div class="lp-panelTitle">
        <h3>Admin roles</h3>
        <button class="x" id="rolesClose" title="Close">✕</button>
      </div>
      <div class="muted small">Assign enterprise-grade roles for this console. Only <b>super_admin</b> can change roles.</div>
      <div class="filters" style="margin-top:12px">
        <div class="full">
          <label>User email</label>
          <input id="rEmail" placeholder="e.g. reviewer@logicpals.com" />
          <div class="lp-hint">The user must have signed up at least once (exists in <span class="lp-mono">auth.users</span>).</div>
        </div>
        <div class="full">
          <label>Role</label>
          <select id="rRole">
            <option value="admin_regular">admin_regular — manage Regular problems</option>
            <option value="admin_olympiad">admin_olympiad — manage Olympiad review</option>
            <option value="super_admin">super_admin — full control</option>
          </select>
        </div>
        <div class="full row">
          <button class="lp-btn primary" id="rAssign">Assign role</button>
          <button class="lp-btn" id="rList">List my roles</button>
        </div>
      </div>
      <pre class="lp-mono" id="rolesOut" style="white-space:pre-wrap;margin:0;background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:14px;padding:10px;min-height:80px"></pre>
    </div>
  </div>

  <div class="lp-toast" id="toast"><div class="t1" id="toastT1"></div><div class="t2" id="toastT2"></div></div>

  <script src="/api/env"></script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // =====================
    // CONFIG (same as before)
    // =====================
    // Runtime config injected by Vercel (public values only)
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.__LP_ENV || {};
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      alert("Missing Supabase config. Set SUPABASE_URL and SUPABASE_ANON_KEY in Vercel Environment Variables.");
    }


    // IMPORTANT:
    // - persistSession keeps login stable across refresh.
    // - autoRefreshToken prevents “random sign-outs” when the access token expires.
    // - detectSessionInUrl is OFF because this is a static page (no OAuth redirect hash).
    // - use localStorage explicitly so all admin pages share the same auth state.
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: false,
        storage: window.localStorage,
      }
    });

    // ===============
    // UI references
    // ===============
    const nav = document.getElementById('nav');
    const who = document.getElementById('who');
    const roleBadge = document.getElementById('roleBadge');
    const statusText = document.getElementById('statusText');
    const authState = document.getElementById('authState');
    const roleSource = document.getElementById('roleSource');
    const viewTitle = document.getElementById('viewTitle');
    const accessPill = document.getElementById('accessPill');

    const btnVisit = document.getElementById('btnVisit');
    const btnStudent = document.getElementById('btnStudent');
    const btnRoles = document.getElementById('btnRoles');
    const btnSignIn = document.getElementById('btnSignIn');
    const btnSignOut = document.getElementById('btnSignOut');

    const loginOverlay = document.getElementById('loginOverlay');
    const loginClose = document.getElementById('loginClose');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const loginBtn = document.getElementById('loginBtn');
    const loginOut = document.getElementById('loginOut');

    const rolesModal = document.getElementById('rolesModal');
    const rolesClose = document.getElementById('rolesClose');
    const rEmail = document.getElementById('rEmail');
    const rRole = document.getElementById('rRole');
    const rAssign = document.getElementById('rAssign');
    const rList = document.getElementById('rList');
    const rolesOut = document.getElementById('rolesOut');

    const viewDashboard = document.getElementById('viewDashboard');
    const viewQueue = document.getElementById('viewQueue');
    const viewUsers = document.getElementById('viewUsers');
    const viewPayments = document.getElementById('viewPayments');
    const viewSubs = document.getElementById('viewSubs');

    const qSearch = document.getElementById('qSearch');
    const qDifficulty = document.getElementById('qDifficulty');
    const qAge = document.getElementById('qAge');
    const qActive = document.getElementById('qActive');
    const qSort = document.getElementById('qSort');
    const btnApply = document.getElementById('btnApply');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnAdd = document.getElementById('btnAdd');
    const queueEmpty = document.getElementById('queueEmpty');
    const queueTableWrap = document.getElementById('queueTableWrap');
    const rowsBadge = document.getElementById('rowsBadge');

    const uEmail = document.getElementById('uEmail');
    const btnLookup = document.getElementById('btnLookup');
    const btnListMe = document.getElementById('btnListMe');
    const usersOut = document.getElementById('usersOut');

    const btnOpenPayments = document.getElementById('btnOpenPayments');
    const btnOpenSubs = document.getElementById('btnOpenSubs');

    // ===============
    // State
    // ===============
    const NAV_GROUPS = [
      { title:'Overview', items:[{ id:'dashboard', label:'System overview' }] },
      { title:'Content', items:[
          { id:'regular', label:'Regular: manage & upload' },
          { id:'olympiad', label:'Olympiad: QC review (blocked-by-design)' },
        ]},
      { title:'Monetization', items:[
          { id:'payments', label:'Payments' },
          { id:'subs', label:'Subscriptions' },
        ]},
      { title:'Access', items:[{ id:'users', label:'Users & roles' }] },
    ];

    let currentView = 'dashboard';
    let myRole = null; // 'super_admin' | 'admin_regular' | 'admin_olympiad' | null
    let myUser = null;
    let currentQueueMode = null; // 'regular' | 'olympiad'

    const AGE_OPTIONS_REGULAR = ['8-9','9-10','10-11','11-12'];
    const AGE_OPTIONS_OLYMPIAD = ['8-9','9-10','10-11','11-12','12-13','13-14','14-15','15-16'];

    function setAgeOptions(){
      const opts = (!currentQueueMode || currentQueueMode==='regular') ? AGE_OPTIONS_REGULAR : AGE_OPTIONS_OLYMPIAD;
      const prev = qAge.value || '';
      qAge.innerHTML = '<option value="">Any</option>' + opts.map(a=>`<option>${a}</option>`).join('');
      if(opts.includes(prev)) qAge.value = prev;
    }

    // ===============
    // Helpers
    // ===============
    function toast(t1, t2=''){
      const t = document.getElementById('toast');
      document.getElementById('toastT1').textContent = t1;
      document.getElementById('toastT2').textContent = t2;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 4200);
    }

    function showLoginOverlay(show){
      loginOverlay.classList.toggle('show', !!show);
      loginOverlay.setAttribute('aria-hidden', show ? 'false':'true');
    }

    function showRolesModal(show){
      rolesModal.classList.toggle('show', !!show);
      rolesModal.setAttribute('aria-hidden', show ? 'false':'true');
    }

    function setAccessPill(text, kind='ok'){
      accessPill.textContent = text;
      const map = { ok:'rgba(79,140,255,.14)', warn:'rgba(255,200,0,.12)', err:'rgba(255,77,77,.12)' };
      accessPill.style.background = map[kind] || map.ok;
      accessPill.style.borderColor = kind==='err' ? 'rgba(255,77,77,.30)' : kind==='warn' ? 'rgba(255,200,0,.28)' : 'rgba(255,255,255,.10)';
    }

    function canAccess(view){
      if(view==='dashboard') return true;
      if(!myRole) return false;
      if(myRole==='super_admin') return true;
      if(view==='regular') return myRole==='admin_regular';
      if(view==='olympiad') return myRole==='admin_olympiad';
      if(view==='users') return true; // let admins view roles (read-only)
      if(view==='payments' || view==='subs') return true; // pages can exist without DB access
      return false;
    }

    function renderNav(){
      nav.innerHTML = '';
      NAV_GROUPS.forEach(group => {
        const g = document.createElement('div');
        g.className = 'lp-nav-group';
        const t = document.createElement('div');
        t.className = 'lp-nav-title';
        t.textContent = group.title;
        g.appendChild(t);

        const itemsWrap = document.createElement('div');
        itemsWrap.className = 'lp-nav-items';

        group.items.forEach(item => {
          const el = document.createElement('button');
          el.type = 'button';
          el.className = 'lp-nav-btn' + (item.id===currentView ? ' active' : '');
          el.textContent = item.label;
          el.disabled = !!myUser && !canAccess(item.id); // show but disable when signed-in w/o permission
          el.onclick = ()=> setView(item.id);
          itemsWrap.appendChild(el);
        });

        g.appendChild(itemsWrap);
        nav.appendChild(g);
      });
    }

    function showOnly(id){
      viewDashboard.style.display = id==='dashboard' ? '' : 'none';
      viewQueue.style.display = (id==='regular' || id==='olympiad') ? '' : 'none';
      viewUsers.style.display = id==='users' ? '' : 'none';
      viewPayments.style.display = id==='payments' ? '' : 'none';
      viewSubs.style.display = id==='subs' ? '' : 'none';
    }

    async function setView(id){
      currentView = id;
      renderNav();
      showOnly(id);

      viewTitle.textContent = NAV_GROUPS.flatMap(g=>g.items).find(x=>x.id===id)?.label || 'Dashboard';

      if(!myUser){
        setAccessPill('Signed out', 'warn');
        statusText.textContent = 'Sign in to start.';
        return;
      }

      if(!canAccess(id)){
        setAccessPill('No access', 'err');
        statusText.textContent = myRole ? `Your role (${myRole}) cannot access this view.` : 'Ask a super_admin to assign you an admin role.';
        if(id==='regular' || id==='olympiad'){
          queueEmpty.textContent = 'No access.';
          queueTableWrap.innerHTML = '';
          rowsBadge.textContent = 'Rows 0';
        }
        return;
      }

      setAccessPill('Ready','ok');

      if(id==='regular'){ currentQueueMode='regular'; setAgeOptions(); await loadQueue(); }
      if(id==='olympiad'){ currentQueueMode='olympiad'; setAgeOptions(); await loadQueue(); }
    }

    // =====================
    // Role + session loading
    // =====================
    
// ---- Role cache (prevents UI flicker when RPC is slow) ----
const ROLE_CACHE_KEY = 'lp_admin_role_cache_v1';
function loadRoleCache(){
  try{ return JSON.parse(sessionStorage.getItem(ROLE_CACHE_KEY) || '{}') || {}; }catch{ return {}; }
}
function saveRoleCache(userId, role){
  if(!userId || !role) return;
  const c = loadRoleCache();
  c[userId] = { role, ts: Date.now() };
  sessionStorage.setItem(ROLE_CACHE_KEY, JSON.stringify(c));
}
function getCachedRole(userId){
  const c = loadRoleCache();
  const entry = c[userId];
  if(!entry) return null;
  // 24h TTL
  if(Date.now() - (entry.ts||0) > 24*60*60*1000) return null;
  return entry.role || null;
}


async function getMyRole() {
  // Returns: { role: string|null, source: string }
  const session = (await supabase.auth.getSession()).data.session;
  const userId = session?.user?.id;
  if(!userId) return { role: null, source: 'no-session' };

  const tryRpc = async (fn) => {
    const { data, error } = await supabase.rpc(fn);
    if (error) return { role: null, source: `rpc:${fn}:error` };
    if (data == null) return { role: null, source: `rpc:${fn}:empty` };

    const normalize = (v) => {
      if (!v) return null;
      if (typeof v === 'string') return v;
      if (typeof v === 'object') {
        if (typeof v.role === 'string') return v.role;
        for (const k of ['app_role','roles','my_role']) {
          if (typeof v[k] === 'string') return v[k];
        }
        for (const val of Object.values(v)) {
          if (typeof val === 'string') return val;
        }
      }
      return null;
    };

    if (Array.isArray(data)) return { role: normalize(data[0]), source: `rpc:${fn}` };
    return { role: normalize(data), source: `rpc:${fn}` };
  };

  const tryTable = async () => {
    const { data, error } = await supabase
      .from('user_roles')
      .select('role')
      .eq('user_id', userId)
      .maybeSingle();
    if (error) return { role: null, source: `table:user_roles:error` };
    return { role: data?.role || null, source: 'table:user_roles' };
  };

  const backoff = [0, 200, 600, 1200];
  for (let i=0; i<backoff.length; i++){
    if(backoff[i]) await new Promise(r=>setTimeout(r, backoff[i]));

    // Prefer RPCs first (RLS-safe)
    for (const fn of ['admin_get_my_role','admin_get_my_roles']){
      try{
        const r = await tryRpc(fn);
        if(r.role){
          saveRoleCache(userId, r.role);
          return r;
        }
      }catch(_){/*ignore*/}
    }

    // Fallback: direct table read (works if you have "read own role" policy)
    try{
      const r = await tryTable();
      if(r.role){
        saveRoleCache(userId, r.role);
        return r;
      }
    }catch(_){/*ignore*/}
  }

  // Final fallback: cached role to avoid flicker
  const cached = getCachedRole(userId);
  if(cached) return { role: cached, source: 'cache' };
  return { role: null, source: 'none' };
}

async function refreshSessionUI(){

      const { data } = await supabase.auth.getSession();
      const session = data?.session || null;
      myUser = session?.user || null;

      if(!myUser){
        myRole = null;
        who.textContent = 'Signed out';
        authState.textContent = 'none';
        roleBadge.textContent = 'role: -';
        roleSource.textContent = '-';
        btnSignIn.style.display = '';
        btnSignOut.style.display = 'none';
        btnRoles.style.display = 'none';
        statusText.textContent = 'Sign in to start.';
        setAccessPill('Signed out','warn');
        return;
      }

      authState.textContent = 'session';
      who.textContent = `Signed in: ${myUser.email}`;

      const r = await getMyRole();
      myRole = r?.role ?? null;
      roleSource.textContent = r?.source ?? '-';
      roleBadge.textContent = `role: ${myRole ?? 'none'}`;

      btnSignIn.style.display = 'none';
      btnSignOut.style.display = '';
      btnRoles.style.display = (myRole === 'super_admin') ? '' : 'none';

      if(!myRole){
        statusText.innerHTML = `Access denied. No admin role found for <span class="lp-mono">${myUser.email}</span>.\n\nOnly <span class="lp-mono">super_admin</span> can change roles.`;
        setAccessPill('No access','err');
      } else {
        statusText.textContent = 'Signed in. Choose a section from the top navigation.';
        setAccessPill('Ready','ok');
      }
    }

    // =====================
    // Queue logic
    // =====================
    async function loadQueue(){
      if(!myUser || !currentQueueMode) return;

      queueEmpty.textContent = 'Loading…';
      queueTableWrap.innerHTML = '';
      rowsBadge.textContent = 'Rows 0';

      // Query rules (robust):
      // We prioritize explicit Olympiad markers (tags/title/category) because is_exam_style
      // may be inconsistent in early data imports.
      let query = supabase
        .from('problems')
        .select('id,title,age_category,difficulty,category,curriculum_tags,is_exam_style,is_active,created_at');

      if(currentQueueMode === 'olympiad'){
        // Olympiad = BdMO/GSO tagged OR clearly marked in title/category OR exam-style
        query = query.or(
          'curriculum_tags.cs.{BdMO},curriculum_tags.cs.{GSO},' +
          'title.ilike.%BdMO%,title.ilike.%GSO%,' +
          'category.ilike.%bdmo%,category.ilike.%olym%,is_exam_style.eq.true'
        );
      } else {
        // Regular = exclude olympiad markers
        query = query
          .not('curriculum_tags','cs','{BdMO}')
          .not('curriculum_tags','cs','{GSO}')
          .not('title','ilike','%BdMO%')
          .not('title','ilike','%GSO%')
          .not('category','ilike','%bdmo%')
          .not('category','ilike','%olym%');
      }

      const s = (qSearch.value || '').trim();
      if(s){
        // best-effort search across title/category (ILIKE)
        query = query.or(`title.ilike.%${escapeLike(s)}%,category.ilike.%${escapeLike(s)}%`);
      }
      if(qDifficulty.value){ query = query.eq('difficulty', qDifficulty.value); }
      if(qAge.value){ query = query.eq('age_category', qAge.value); }
      if(qActive.value==='true'){ query = query.eq('is_active', true); }
      if(qActive.value==='false'){ query = query.eq('is_active', false); }

      query = (qSort.value==='old') ? query.order('created_at', { ascending:true }) : query.order('created_at', { ascending:false });
      query = query.limit(50);

      const { data, error } = await query;
      if(error){
        queueEmpty.textContent = `Error loading queue: ${error.message}`;
        setAccessPill('DB error','err');
        return;
      }

      const rows = data || [];
      rowsBadge.textContent = `Rows ${rows.length}`;
      if(!rows.length){
        queueEmpty.textContent = 'No rows yet. Try adjusting filters, or refresh.';
        return;
      }

      queueEmpty.textContent = '';
      queueTableWrap.innerHTML = renderTable(rows);
      bindRowActions(rows);
    }

    function escapeLike(s){
      // Basic escape for Supabase OR filter string.
      return s.replace(/%/g,'\\%').replace(/,/g,'\\,');
    }

    function renderTable(rows){
      const head = `
        <table>
          <thead>
            <tr>
              <th style="min-width:260px">Title</th>
              <th>Age</th>
              <th>Difficulty</th>
              <th>Category</th>
              <th>Active</th>
              <th style="min-width:220px">Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      const body = rows.map(r => {
        const safeTitle = (r.title || '(untitled)').replace(/</g,'&lt;');
        return `
          <tr data-id="${r.id}">
            <td>
              <div style="font-weight:700">${safeTitle}</div>
              <div class="mono small muted">${r.id}</div>
            </td>
            <td>${r.age_category ?? ''}</td>
            <td>${r.difficulty ?? ''}</td>
            <td>${r.category ?? ''}</td>
            <td>${r.is_active ? 'Yes' : 'No'}</td>
            <td>
              <div class="lp-actions">
                <button class="lp-btn" data-action="view">View</button>
                <button class="lp-btn primary" data-action="activate">Activate</button>
                <button class="lp-btn" data-action="deactivate">Deactivate</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      return head + body + '</tbody></table>';
    }

    async function bindRowActions(rows){
      const idToRow = new Map(rows.map(r=>[String(r.id), r]));
      queueTableWrap.querySelectorAll('tr[data-id]').forEach(tr => {
        const id = tr.getAttribute('data-id');
        tr.querySelectorAll('button[data-action]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const action = btn.getAttribute('data-action');
            const row = idToRow.get(id);
            if(!row) return;

            if(action==='view'){
              toast('Problem ID copied', id);
              navigator.clipboard?.writeText(id).catch(()=>{});
              return;
            }

            if(action==='activate'){
              await setActive(id, true);
              await loadQueue();
              return;
            }

            if(action==='deactivate'){
              await setActive(id, false);
              await loadQueue();
              return;
            }
          });
        });
      });
    }

    async function setActive(id, isActive){
      try{
        const { error } = await supabase.from('problems').update({ is_active: isActive }).eq('id', id);
        if(error){
          toast('Update failed', error.message);
          return;
        }
        toast(isActive ? 'Activated' : 'Deactivated', String(id));
      } catch(e){
        toast('Update failed', String(e?.message || e));
      }
    }

    // =====================
    // Users panel helpers
    // =====================
    async function lookupRoleByEmail(email){
      const clean = String(email||'').trim().toLowerCase();
      if(!clean) return { error:'Email required' };

      // Prefer RPC if available (lets DB do auth.users join securely)
      const candidates = ['admin_lookup_role_by_email','user_role_lookup_by_email'];
      for(const fn of candidates){
        try{
          const { data, error } = await supabase.rpc(fn, { target_email: clean });
          if(!error && data){
            return { ok:true, source:`rpc:${fn}`, data };
          }
        } catch(e){ /* ignore */ }
      }

      return { error: 'No lookup RPC found. Use Supabase SQL helper query (join auth.users) instead.' };
    }

    // =====================
    // Role assignment (super_admin)
    // =====================
    async function assignRole(email, role){
      const target_email = String(email||'').trim().toLowerCase();
      if(!target_email) return { error:'Email required' };

      // Function signature in your DB: admin_set_role(target_email text, new_role app_role)
      // We pass role as text; Postgres should cast if function argument is app_role.
      const { data, error } = await supabase.rpc('admin_set_role', { target_email, new_role: role });
      if(error) return { error: error.message };
      return { ok:true, data };
    }

    async function listMyRoles(){
      const r = await getMyRole();
      if(r && r.ok && r.data) return { ok:true, data: [{ role: r.data }] };
      if(!myUser) return { error:"Not signed in" };
      const { data: rows, error: e2 } = await supabase.from("user_roles").select("role").eq("user_id", myUser.id);
      if(e2) return { error: e2.message };
      return { ok:true, data: rows||[] };
    }

    // =====================
    // Events
    // =====================
    btnVisit.onclick = ()=> window.open('/','_blank');
    btnStudent.onclick = ()=> window.open('/dashboard.html','_blank');

    // These pages are shipped as separate static files. Keep the filenames in sync with what you deploy.
    // We use admin-payments.html and admin-subscriptions.html to avoid clashing with any future public pages.
    btnOpenPayments.onclick = ()=> window.location.href = './admin-payments.html';
    btnOpenSubs.onclick = ()=> window.location.href = './admin-subscriptions.html';

    btnSignIn.onclick = ()=> {
      const saved = localStorage.getItem('logicpals_admin_last_email');
      if(saved) loginEmail.value = saved;
      showLoginOverlay(true);
      loginOut.textContent = '';
    };
    loginClose.onclick = ()=> showLoginOverlay(false);

    loginBtn.onclick = async ()=> {
      loginOut.textContent = 'Signing in…';
      const email = String(loginEmail.value||'').trim();
      const password = String(loginPassword.value||'');
      localStorage.setItem('logicpals_admin_last_email', email);

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if(error){
        loginOut.textContent = JSON.stringify({ error: error.message }, null, 2);
        toast('Sign in failed', error.message);
        return;
      }
      loginOut.textContent = JSON.stringify({ ok:true, user: data?.user?.email }, null, 2);
      toast('Signed in', data?.user?.email || '');
      showLoginOverlay(false);
      await refreshSessionUI();
      await setView(currentView);
    };

    btnSignOut.onclick = async ()=> {
      await supabase.auth.signOut();
      toast('Signed out');
      await refreshSessionUI();
      await setView('dashboard');
    };

    btnRoles.onclick = ()=> {
      rolesOut.textContent = '';
      rEmail.value = '';
      showRolesModal(true);
    };
    rolesClose.onclick = ()=> showRolesModal(false);

    rAssign.onclick = async ()=> {
      if(myRole !== 'super_admin'){
        rolesOut.textContent = JSON.stringify({ error:'Only super_admin can assign roles' }, null, 2);
        return;
      }
      rolesOut.textContent = 'Assigning…';
      const res = await assignRole(rEmail.value, rRole.value);
      rolesOut.textContent = JSON.stringify(res, null, 2);
      if(res.ok) toast('Role assigned', `${rEmail.value} → ${rRole.value}`);
    };

    rList.onclick = async ()=> {
      rolesOut.textContent = 'Loading…';
      const res = await listMyRoles();
      rolesOut.textContent = JSON.stringify(res, null, 2);
    };

    btnApply.onclick = loadQueue;
    btnRefresh.onclick = loadQueue;
    btnAdd.onclick = async ()=>{
      // Minimal, reliable "upload" flow: paste JSON for a problem and insert.
      // You can later replace this with a full form + file uploader.
      if (!session || !session.user) return toast('Not signed in','Please sign in first.');
      if (!canAccess(currentMode)) return toast('No access','You do not have permission for this section.');

      const template = {
        title: 'Title',
        problem_text: 'Problem text...',
        answer_key: 'answer|alt1|alt2',
        solution_explanation: 'Explain why...',
        age_category: '9-10',
        difficulty: 'medium',
        category: currentMode==='olympiad' ? 'olympiad' : 'logic',
        curriculum_tags: ['Tag1','Tag2'],
        hints: ['Hint 1','Hint 2','Hint 3'],
        socratic_questions: ['Q1','Q2','Q3'],
        is_exam_style: currentMode==='olympiad',
        is_active: true
      };
      const raw = prompt('Paste a JSON object for the new problem (edit the template):', JSON.stringify(template, null, 2));
      if (!raw) return;
      let data;
      try { data = JSON.parse(raw); } catch(e){ return toast('Invalid JSON', String(e)); }

      // Normalize arrays
      if (Array.isArray(data.hints)) data.hints = JSON.stringify(data.hints);
      if (Array.isArray(data.socratic_questions)) data.socratic_questions = JSON.stringify(data.socratic_questions);

      // Insert
      setStatus('Inserting...');
      try {
        const payload = {
          title: data.title,
          problem_text: data.problem_text,
          answer_key: data.answer_key,
          solution_explanation: data.solution_explanation,
          age_category: data.age_category,
          difficulty: (data.difficulty||'').toLowerCase(),
          category: data.category || (currentMode==='olympiad' ? 'olympiad' : 'logic'),
          curriculum_tags: Array.isArray(data.curriculum_tags) ? data.curriculum_tags : [],
          hints: (typeof data.hints==='string') ? JSON.parse(data.hints) : (Array.isArray(data.hints)?data.hints:[]),
          socratic_questions: (typeof data.socratic_questions==='string') ? JSON.parse(data.socratic_questions) : (Array.isArray(data.socratic_questions)?data.socratic_questions:[]),
          is_exam_style: !!data.is_exam_style,
          is_active: data.is_active !== false
        };

        const { error } = await supabase.from('problems').insert(payload);
        if (error) throw error;
        toast('Saved','Problem inserted.');
        await listProblems();
      } catch(err){
        toast('Insert failed', err?.message || String(err));
      } finally {
        setStatus('Ready');
      }
    };

    btnLookup.onclick = async ()=> {
      usersOut.textContent = 'Loading…';
      const res = await lookupRoleByEmail(uEmail.value);
      usersOut.textContent = JSON.stringify(res, null, 2);
    };

    btnListMe.onclick = async ()=> {
      usersOut.textContent = 'Loading…';
      const res = await listMyRoles();
      usersOut.textContent = JSON.stringify(res, null, 2);
    };

    // Keep UI in sync across refresh/navigation
    supabase.auth.onAuthStateChange(async (_event, _session) => {
      await refreshSessionUI();
      await setView(currentView);
    });

    // ===============
    // Boot
    // ===============
    renderNav();
    setAgeOptions();
    await refreshSessionUI();

    // If user opens /admin.html directly while signed out, show login overlay.
    const { data } = await supabase.auth.getSession();
    if(!data?.session){
      showLoginOverlay(true);
    }

    await setView('dashboard');

  </script>

  <!-- Problem modal (Add / Edit) -->
  <div class="lp-overlay" id="problemOverlay">
    <div class="lp-modal">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div>
          <div class="lp-brand" style="margin:0;">
            <div class="lp-logo"></div>
            <div>
              <div class="lp-title" id="pmTitle">Problem editor</div>
              <div class="subtitle" id="pmSub">Add or update a problem</div>
            </div>
          </div>
        </div>
        <button class="lp-btn" id="pmClose">Close</button>
      </div>

      <div class="lp-grid" style="grid-template-columns: 1fr 1fr;">
        <div>
          <label>Title</label>
          <input id="pm_problem_title" placeholder="e.g., Mango basket logic" />
        </div>
        <div>
          <label>Category</label>
          <input id="pm_problem_category" placeholder="e.g., logic / arithmetic / patterns" />
        </div>
        <div>
          <label>Age category</label>
          <input id="pm_problem_age" placeholder="e.g., 9-10" />
        </div>
        <div>
          <label>Difficulty</label>
          <select id="pm_problem_difficulty">
            <option value="easy">easy</option>
            <option value="medium">medium</option>
            <option value="hard">hard</option>
          </select>
        </div>
      </div>

      <div class="lp-grid" style="grid-template-columns: 1fr 1fr;">
        <div>
          <label>Track</label>
          <select id="pm_problem_track">
            <option value="regular">Regular (is_exam_style = false)</option>
            <option value="olympiad">Olympiad (is_exam_style = true)</option>
          </select>
        </div>
        <div>
          <label>Active</label>
          <select id="pm_problem_active">
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Problem text</label>
        <textarea id="pm_problem_text" placeholder="Write the problem statement…"></textarea>
      </div>

      <div class="lp-grid" style="grid-template-columns: 1fr 1fr;">
        <div>
          <label>Answer key (pipe-separated)</label>
          <input id="pm_problem_answer" placeholder="e.g., 12|twelve" />
        </div>
        <div>
          <label>Curriculum tags (comma-separated)</label>
          <input id="pm_problem_tags" placeholder="e.g., Patterns, Counting, BdMO" />
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Solution explanation</label>
        <textarea id="pm_problem_solution" placeholder="Explain why the answer is correct…"></textarea>
      </div>

      <div class="lp-grid" style="grid-template-columns: 1fr 1fr;">
        <div>
          <label>Hints (JSON array)</label>
          <textarea id="pm_problem_hints" placeholder='["Hint 1", "Hint 2", "Hint 3"]'></textarea>
        </div>
        <div>
          <label>Socratic questions (JSON array)</label>
          <textarea id="pm_problem_socratic" placeholder='["What do you notice?", "What is the pattern?"]'></textarea>
        </div>
      </div>

      <div class="lp-actions" style="justify-content:flex-end; margin-top:12px;">
        <button class="lp-btn" id="pmDelete" style="display:none;">Delete</button>
        <button class="lp-btn" id="pmSave">Save</button>
      </div>
      <pre class="lp-mono" id="pmOut" style="margin-top:10px;"> </pre>
    </div>
  </div>


  <script src="lp_auth.js"></script>
</body>
</html>
