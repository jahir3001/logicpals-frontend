<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LogicPals Admin</title>
  <style>
    :root{
      --bg0:#05080c; --bg1:#071018; --card:#0b1622; --card2:#0e1c2b;
      --line:rgba(255,255,255,.10); --line2:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.68);
      --muted2:rgba(255,255,255,.52);
      --accent:#32d296; --accent2:#1ea7ff; --warn:#f59e0b; --danger:#ef4444;
      --shadow: 0 20px 70px rgba(0,0,0,.55);
      --r12:12px; --r16:16px; --r20:20px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 15% 10%, rgba(50,210,150,.20), transparent 55%),
        radial-gradient(1200px 900px at 85% 15%, rgba(30,167,255,.14), transparent 55%),
        radial-gradient(900px 700px at 35% 85%, rgba(245,158,11,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 22px;
      background: linear-gradient(180deg, rgba(8,16,24,.78), rgba(8,16,24,.46));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(50,210,150,.95), rgba(30,167,255,.9));
      box-shadow: 0 12px 35px rgba(0,0,0,.35);
    }
    .brand h1{ margin:0; font-size:16px; line-height:1.1; letter-spacing:.2px; }
    .brand .sub{ margin-top:3px; color:var(--muted2); font-size:12px; }

    .actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--line); background: rgba(255,255,255,.04); color:var(--muted); font-size:12px; }

    .btn{
      cursor:pointer; user-select:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      font-size:13px;
      display:inline-flex; align-items:center; gap:8px;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.07); border-color: var(--line2); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: rgba(50,210,150,.12); border-color: rgba(50,210,150,.35); }
    .btn.primary:hover{ background: rgba(50,210,150,.17); }
    .btn.danger{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.35); }

    /* Layout */
    .wrap{ max-width: 1200px; margin:0 auto; padding: 18px 22px 36px; }
    .grid{ display:grid; grid-template-columns: 360px 1fr; gap:16px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{ padding:16px 16px 10px; border-bottom: 1px solid rgba(255,255,255,.07); display:flex; justify-content:space-between; align-items:center; }
    .card .hd h2{ margin:0; font-size:14px; letter-spacing:.2px; }
    .card .bd{ padding:16px; }

    .tabs{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:14px; }
    .tab{ padding:8px 12px; border-radius:999px; border:1px solid var(--line); background: rgba(255,255,255,.04); color:var(--muted); font-size:12px; cursor:pointer; }
    .tab.active{ background: rgba(50,210,150,.12); border-color: rgba(50,210,150,.35); color:var(--text); }

    /* Login overlay */
    .screen{
      position:fixed; inset:0; z-index:50;
      display:flex; align-items:center; justify-content:center;
      padding:28px;
      background:
        radial-gradient(1200px 900px at 15% 10%, rgba(50,210,150,.18), transparent 55%),
        radial-gradient(1200px 900px at 85% 15%, rgba(30,167,255,.13), transparent 55%),
        linear-gradient(180deg, rgba(3,6,10,.96), rgba(6,12,18,.94));
    }
    .login{
      width:min(520px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow: 0 30px 110px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .loginTop{ padding:18px 18px 14px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,.08); }
    .loginTop .left{ display:flex; gap:12px; align-items:center; }
    .loginTop h3{ margin:0; font-size:14px; }
    .loginTop p{ margin:3px 0 0; color:var(--muted2); font-size:12px; }
    .loginBd{ padding:18px; }
    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    .field label{ color:var(--muted); font-size:12px; }
    .input{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      border-radius: 14px;
      padding: 11px 12px;
      outline:none;
    }
    .input:focus{ border-color: rgba(30,167,255,.55); box-shadow: 0 0 0 4px rgba(30,167,255,.14); }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .hint{ color:var(--muted2); font-size:12px; }
    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size:12px;
      white-space:pre-wrap;
      font-family: var(--mono);
      display:none;
    }
    .msg.show{ display:block; }

    /* Modal */
    .modalBackdrop{ position:fixed; inset:0; z-index:60; display:none; align-items:center; justify-content:center; padding:18px; background: rgba(0,0,0,.55); backdrop-filter: blur(6px); }
    .modalBackdrop.show{ display:flex; }
    .modal{ width:min(720px, 100%); border-radius: 18px; border:1px solid rgba(255,255,255,.12); background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04)); box-shadow: 0 40px 120px rgba(0,0,0,.70); overflow:hidden; }
    .modal .mhd{ padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; align-items:center; justify-content:space-between; }
    .modal .mhd strong{ font-size:14px; }
    .modal .mbd{ padding:16px; }
    .closeX{ width:34px; height:34px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color:var(--text); cursor:pointer; }
    .closeX:hover{ background: rgba(255,255,255,.07); }

    .kpi{ display:flex; gap:8px; flex-wrap:wrap; }
    .kpi .chip{ padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); color: var(--muted); font-size:12px; }

    .muted{ color:var(--muted); }
    .muted2{ color:var(--muted2); }
    .small{ font-size:12px; }
    .mono{ font-family: var(--mono); }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN (only when NOT authenticated) -->
  <div id="loginScreen" class="screen" aria-hidden="false">
    <div class="login" role="dialog" aria-modal="true" aria-label="Admin sign in">
      <div class="loginTop">
        <div class="left">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h3>LogicPals Admin</h3>
            <p>Secure console access (enterprise-grade)</p>
          </div>
        </div>
        <div class="pill" title="Project">Project: LogicPals-App</div>
      </div>
      <div class="loginBd">
        <div class="field">
          <label for="loginEmail">Email</label>
          <input id="loginEmail" class="input" type="email" placeholder="you@logicpals.com" autocomplete="username" />
        </div>
        <div class="field">
          <label for="loginPassword">Password</label>
          <input id="loginPassword" class="input" type="password" placeholder="••••••••" autocomplete="current-password" />
        </div>
        <div class="row">
          <button id="btnSignIn" class="btn primary">Sign in</button>
          <div class="hint">Only users with admin roles can access this console.</div>
        </div>
        <div id="loginMsg" class="msg" aria-live="polite"></div>
        <div style="margin-top:12px" class="muted2 small">
          Tip: If you opened this file by double-click (file:///...), use a local server. Modules + CORS require http://localhost.
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>LogicPals Admin</h1>
        <div class="sub">Enterprise review console — Regular + Olympiad tracks</div>
      </div>
    </div>

    <div class="actions">
      <span id="whoami" class="pill hidden"></span>
      <button id="btnVisit" class="btn">Visit site</button>
      <button id="btnStudent" class="btn">Student dashboard</button>
      <button id="btnRoleMgmt" class="btn hidden">Admin roles</button>
      <button id="btnLogout" class="btn danger hidden">Log out</button>
    </div>
  </header>

  <main class="wrap">
    <div class="tabs" id="mainTabs">
      <div class="tab active" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="regular">Regular review</div>
      <div class="tab" data-tab="olympiad">Olympiad review</div>
      <div class="tab" data-tab="payments">Payments</div>
      <div class="tab" data-tab="subscriptions">Subscriptions</div>
      <div class="tab" data-tab="users">Users</div>
    </div>

    <div style="height:14px"></div>

    <div class="grid">
      <section class="card">
        <div class="hd">
          <h2>Console status</h2>
          <span id="roleChips" class="kpi"></span>
        </div>
        <div class="bd">
          <div class="muted small">Access is controlled by <span class="mono">public.user_roles</span> and enforced by RPCs + RLS.</div>
          <div style="height:10px"></div>
          <div id="accessState" class="mono small muted">Checking session…</div>
          <div style="height:14px"></div>
          <button id="btnOpenRoleMgmt" class="btn hidden">Assign roles</button>
          <div class="muted2 small" style="margin-top:10px">Only <span class="mono">super_admin</span> can change roles.</div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <h2 id="panelTitle">Dashboard</h2>
          <div class="pill" id="panelHint">Ready</div>
        </div>
        <div class="bd" id="panelBody">
          <div class="muted">Sign in to start reviewing problems.</div>
        </div>
      </section>
    </div>
  </main>

  <!-- ROLE MANAGEMENT MODAL (never auto-opens) -->
  <div id="roleModal" class="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Admin roles">
      <div class="mhd">
        <strong>Admin roles</strong>
        <button id="btnCloseRoleModal" class="closeX" aria-label="Close">✕</button>
      </div>
      <div class="mbd">
        <div class="muted small">Assign enterprise-grade roles for this console. Only <span class="mono">super_admin</span> can change roles.</div>
        <div style="height:12px"></div>

        <div class="field">
          <label for="targetEmail">User email</label>
          <input id="targetEmail" class="input" type="email" placeholder="e.g. reviewer@logicpals.com" />
          <div class="muted2 small">The user must have signed up at least once (exists in <span class="mono">auth.users</span>).</div>
        </div>

        <div class="field">
          <label for="targetRole">Role</label>
          <select id="targetRole" class="input">
            <option value="admin_regular">admin_regular — manage Regular problems</option>
            <option value="admin_olympiad">admin_olympiad — manage Olympiad review</option>
            <option value="super_admin">super_admin — full control</option>
          </select>
        </div>

        <div class="row">
          <button id="btnAssignRole" class="btn primary">Assign role</button>
          <button id="btnListMyRoles" class="btn">List my roles</button>
        </div>

        <div id="roleMsg" class="msg" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ---- Supabase (same as your current project) ----
    const SUPABASE_URL = 'https://ovszuxerimbmzfblzkgd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92c3p1eGVyaW1ibXpmYmx6a2dkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDA4MzgsImV4cCI6MjA4MDA3NjgzOH0.cmMF8OsC8J_B-t0aBldiMqv4XiNZtJWSGMqg8At9V14';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---- DOM ----
    const $ = (id) => document.getElementById(id);
    const loginScreen = $('loginScreen');
    const loginEmail = $('loginEmail');
    const loginPassword = $('loginPassword');
    const loginMsg = $('loginMsg');
    const btnSignIn = $('btnSignIn');

    const whoami = $('whoami');
    const btnLogout = $('btnLogout');
    const btnVisit = $('btnVisit');
    const btnStudent = $('btnStudent');

    const btnRoleMgmt = $('btnRoleMgmt');
    const btnOpenRoleMgmt = $('btnOpenRoleMgmt');

    const roleChips = $('roleChips');
    const accessState = $('accessState');

    const roleModal = $('roleModal');
    const btnCloseRoleModal = $('btnCloseRoleModal');
    const btnAssignRole = $('btnAssignRole');
    const btnListMyRoles = $('btnListMyRoles');
    const roleMsg = $('roleMsg');
    const targetEmail = $('targetEmail');
    const targetRole = $('targetRole');

    const panelTitle = $('panelTitle');
    const panelHint = $('panelHint');
    const panelBody = $('panelBody');

    const mainTabs = $('mainTabs');

    // ---- State ----
    let session = null;
    let myRoles = [];

    function showMsg(el, objOrString){
      const s = typeof objOrString === 'string' ? objOrString : JSON.stringify(objOrString, null, 2);
      el.textContent = s;
      el.classList.add('show');
    }
    function clearMsg(el){
      el.textContent = '';
      el.classList.remove('show');
    }

    function setLoggedOutUI(){
      session = null;
      myRoles = [];
      whoami.classList.add('hidden');
      btnLogout.classList.add('hidden');
      btnRoleMgmt.classList.add('hidden');
      btnOpenRoleMgmt.classList.add('hidden');
      roleChips.innerHTML = '';
      accessState.textContent = 'Not signed in.';
      panelTitle.textContent = 'Dashboard';
      panelHint.textContent = 'Sign in';
      panelBody.innerHTML = '<div class="muted">Please sign in to access the admin console.</div>';
    }

    function setLoggedInUI(){
      const email = session?.user?.email || 'Signed in';
      whoami.textContent = `Signed in: ${email}`;
      whoami.classList.remove('hidden');
      btnLogout.classList.remove('hidden');

      // chips
      roleChips.innerHTML = '';
      const addChip = (t) => {
        const span = document.createElement('span');
        span.className = 'chip';
        span.textContent = t;
        roleChips.appendChild(span);
      };
      if (!myRoles.length) addChip('role: none');
      myRoles.forEach(r => addChip(`role: ${r}`));

      const isSuper = myRoles.includes('super_admin');
      btnRoleMgmt.classList.toggle('hidden', !isSuper);
      btnOpenRoleMgmt.classList.toggle('hidden', !isSuper);

      if (!myRoles.length){
        accessState.innerHTML = `Access denied. No admin role found for <span class="mono">${email}</span>.`;
        panelHint.textContent = 'No access';
        panelBody.innerHTML = '<div class="muted">Ask a super_admin to assign you an admin role.</div>';
        return;
      }

      accessState.innerHTML = `Access OK. Roles loaded for <span class="mono">${email}</span>.`;
      panelHint.textContent = 'Ready';
      renderTab(document.querySelector('.tab.active')?.dataset?.tab || 'dashboard');
    }

    async function fetchMyRoles(){
      // Uses your existing RPC from earlier versions. Expected to return array of rows like [{role:"super_admin"}, ...]
      const { data, error } = await supabase.rpc('admin_get_my_roles');
      if (error){
        // fallback: try direct table read (works only if RLS allows for own row)
        const fallback = await supabase.from('user_roles').select('role').limit(10);
        if (!fallback.error){
          return (fallback.data || []).map(r => r.role);
        }
        throw error;
      }
      if (Array.isArray(data)){
        return data.map(r => r.role).filter(Boolean);
      }
      // some implementations return {roles:[...]}
      if (data?.roles && Array.isArray(data.roles)) return data.roles;
      return [];
    }

    async function refreshAuthState(){
      const res = await supabase.auth.getSession();
      session = res?.data?.session || null;

      if (!session){
        loginScreen.classList.remove('hidden');
        loginScreen.setAttribute('aria-hidden','false');
        setLoggedOutUI();
        return;
      }

      loginScreen.classList.add('hidden');
      loginScreen.setAttribute('aria-hidden','true');

      try{
        myRoles = await fetchMyRoles();
      }catch(e){
        myRoles = [];
        console.error(e);
      }

      setLoggedInUI();
    }

    // ---- Navigation ----
    function setActiveTab(name){
      [...document.querySelectorAll('.tab')].forEach(t => t.classList.toggle('active', t.dataset.tab === name));
    }

    function renderTab(name){
      setActiveTab(name);

      const canRegular = myRoles.includes('admin_regular') || myRoles.includes('super_admin');
      const canOlympiad = myRoles.includes('admin_olympiad') || myRoles.includes('super_admin');

      if (name === 'dashboard'){
        panelTitle.textContent = 'Dashboard';
        panelBody.innerHTML = `
          <div class="muted">Welcome. Use the tabs to review problems or manage roles.</div>
          <div style="height:12px"></div>
          <div class="muted2 small">Current roles: <span class="mono">${(myRoles.length? myRoles.join(', ') : 'none')}</span></div>
        `;
        return;
      }

      if (name === 'regular'){
        panelTitle.textContent = 'Regular review';
        if (!canRegular){
          panelBody.innerHTML = '<div class="muted">You do not have permission for Regular review.</div>';
          return;
        }
        panelBody.innerHTML = '<div class="muted">Regular Review Queue — connect to your problems table / filters next.</div>';
        return;
      }

      if (name === 'olympiad'){
        panelTitle.textContent = 'Olympiad review';
        if (!canOlympiad){
          panelBody.innerHTML = '<div class="muted">You do not have permission for Olympiad review.</div>';
          return;
        }
        panelBody.innerHTML = '<div class="muted">Olympiad Review Queue — connect to olympiad rubric gating next.</div>';
        return;
      }

      if (name === 'payments'){
        window.location.href = './admin-payments.html';
        return;
      }
      if (name === 'subscriptions'){
        window.location.href = './admin-subscriptions.html';
        return;
      }
      if (name === 'users'){
        panelTitle.textContent = 'Users';
        panelBody.innerHTML = '<div class="muted">User tools placeholder (roles are managed via the Admin roles dialog).</div>';
        return;
      }
    }

    // ---- Role modal ----
    function openRoleModal(){
      clearMsg(roleMsg);
      roleModal.classList.add('show');
      roleModal.setAttribute('aria-hidden','false');
      targetEmail.focus();
    }
    function closeRoleModal(){
      roleModal.classList.remove('show');
      roleModal.setAttribute('aria-hidden','true');
    }

    // ---- Handlers ----
    btnVisit.addEventListener('click', () => { window.location.href = './index.html'; });
    btnStudent.addEventListener('click', () => { window.location.href = './dashboard.html'; });

    btnLogout.addEventListener('click', async () => {
      try{ await supabase.auth.signOut(); }catch(e){ console.warn(e); }
      await refreshAuthState();
    });

    btnSignIn.addEventListener('click', async () => {
      clearMsg(loginMsg);
      const email = (loginEmail.value || '').trim();
      const password = (loginPassword.value || '').trim();
      if (!email || !password){
        showMsg(loginMsg, 'Please enter email and password.');
        return;
      }
      btnSignIn.disabled = true;
      btnSignIn.textContent = 'Signing in…';
      try{
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        await refreshAuthState();
      }catch(e){
        showMsg(loginMsg, { error: e?.message || String(e) });
      }finally{
        btnSignIn.disabled = false;
        btnSignIn.textContent = 'Sign in';
      }
    });

    // Enter-to-submit on password
    loginPassword.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') btnSignIn.click();
    });

    // Role management open buttons
    btnRoleMgmt.addEventListener('click', openRoleModal);
    btnOpenRoleMgmt.addEventListener('click', openRoleModal);
    btnCloseRoleModal.addEventListener('click', closeRoleModal);
    roleModal.addEventListener('click', (e) => { if (e.target === roleModal) closeRoleModal(); });

    btnListMyRoles.addEventListener('click', async () => {
      clearMsg(roleMsg);
      try{
        const roles = await fetchMyRoles();
        showMsg(roleMsg, { ok: true, roles });
      }catch(e){
        showMsg(roleMsg, { error: e?.message || String(e) });
      }
    });

    btnAssignRole.addEventListener('click', async () => {
      clearMsg(roleMsg);
      const email = (targetEmail.value || '').trim();
      const role = targetRole.value;
      if (!email){
        showMsg(roleMsg, 'Please enter a user email.');
        return;
      }
      if (!myRoles.includes('super_admin')){
        showMsg(roleMsg, { error: 'Not authorized. Only super_admin can assign roles.' });
        return;
      }

      btnAssignRole.disabled = true;
      btnAssignRole.textContent = 'Assigning…';
      try{
        // IMPORTANT: Use supabase.rpc so it carries the user JWT. Do NOT use fetch to /rest/v1/rpc.
        const { data, error } = await supabase.rpc('admin_set_role', { target_email: email, new_role: role });
        if (error) throw error;
        showMsg(roleMsg, data || { ok:true });
      }catch(e){
        showMsg(roleMsg, { error: e?.message || String(e) });
      }finally{
        btnAssignRole.disabled = false;
        btnAssignRole.textContent = 'Assign role';
      }
    });

    // Tabs
    mainTabs.addEventListener('click', (e) => {
      const tab = e.target?.closest?.('.tab');
      if (!tab) return;
      renderTab(tab.dataset.tab);
    });

    // Supabase auth subscription
    supabase.auth.onAuthStateChange(async (_evt, newSession) => {
      session = newSession;
      await refreshAuthState();
    });

    // Boot
    await refreshAuthState();

    // Safety: never auto-open role modal.
    closeRoleModal();

  </script>
</body>
</html>
