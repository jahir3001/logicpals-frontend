<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogicPals Tutor - Final Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { --primary: #4F46E5; --bg: #F3F4F6; }
        body { font-family: 'Nunito', sans-serif; background: var(--bg); height: 100vh; display: flex; flex-direction: column; margin: 0; }

        /* HEADER */
        header { background: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10; }
        .left-section { display: flex; flex-direction: column; }
        .logo { font-weight: 800; color: var(--primary); font-size: 18px; display: flex; align-items: center; gap: 5px; }
        
        .badges { display: flex; gap: 8px; margin-top: 4px; }
        .badge { font-size: 10px; padding: 3px 8px; border-radius: 10px; font-weight: 800; letter-spacing: 0.5px; }
        .badge.age { background: #E0E7FF; color: #4338CA; }
        .badge.level { background: #FEF3C7; color: #D97706; }

        .header-controls { display: flex; align-items: center; gap: 10px; }
        .timer-badge { background: #F3F4F6; color: #6B7280; font-weight: 700; padding: 6px 12px; border-radius: 20px; font-size: 14px; font-family: monospace; border: 1px solid #E5E7EB; }
        
        .finish-btn { display: none; background: #10B981; color: white; font-weight: 700; padding: 8px 16px; border-radius: 20px; border:none; cursor: pointer; animation: pulse 1.5s infinite; }

        /* CHAT AREA */
        .chat-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; max-width: 800px; margin: 0 auto; width: 100%; scroll-behavior: smooth; }
        .message { max-width: 85%; padding: 14px 18px; border-radius: 18px; font-size: 16px; line-height: 1.5; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .message.ai { align-self: flex-start; background: white; color: #1F2937; border-bottom-left-radius: 4px; }
        .message.user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .message.hint { align-self: center; background: #FFFBEB; color: #B45309; border: 1px dashed #F59E0B; font-size: 14px; text-align: center; width: 90%; }

        /* INPUT AREA */
        .input-area { background: white; padding: 15px 20px; border-top: 1px solid #E5E7EB; display: flex; flex-direction: column; align-items: center; }
        
        /* üî• GOLDEN HINT BADGE */
        .hint-pill { 
            background: #FEF3C7; color: #D97706; border: 2px solid #FCD34D;
            padding: 8px 20px; border-radius: 25px; font-size: 14px; font-weight: 800; 
            margin-bottom: 15px; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.15);
            animation: popIn 0.3s ease-out;
        }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .input-wrapper { width: 100%; max-width: 800px; display: flex; gap: 10px; align-items: center; }
        
        .hint-btn { background: #FBBF24; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(251, 191, 36, 0.4); }
        .hint-btn:hover { transform: scale(1.1); }
        
        input { flex: 1; padding: 12px 15px; border: 2px solid #E5E7EB; border-radius: 50px; font-size: 16px; outline: none; transition: border-color 0.2s; }
        input:focus { border-color: var(--primary); }
        
        /* üé§ MICROPHONE BUTTON */
        .mic-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: #F3F4F6; font-size: 20px; cursor: pointer; transition: 0.2s; }
        .mic-btn.recording { background: #EF4444; color: white; animation: pulse 1.5s infinite; }
        
        .send-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: var(--primary); color: white; font-size: 18px; cursor: pointer; transition: 0.2s; }
        .send-btn:hover { background: #4338CA; }
        .send-btn:disabled { background: #D1D5DB; cursor: not-allowed; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .typing { font-size: 13px; color: #6B7280; font-style: italic; opacity: 0; transition: 0.3s; margin-bottom: 5px; width: 100%; max-width: 800px; text-align: left; padding-left: 60px; }
        .typing.active { opacity: 1; }
    </style>
</head>
<body>

    <header>
        <div class="left-section">
            <div class="logo">üß† LogicPals</div>
            <div class="badges">
                <span class="badge age">AGE 8-10</span>
                <span class="badge level">üìä MEDIUM</span>
            </div>
        </div>
        <div class="header-controls">
            <div class="timer-badge">‚è±Ô∏è <span id="timeDisplay">00:00</span></div>
            <button id="finishBtn" onclick="finishSession()" class="finish-btn">üéâ Done!</button>
        </div>
    </header>

    <div class="chat-container" id="chatContainer"></div>

    <div class="input-area">
        <div class="typing" id="typingIndicator">LogicPals is thinking...</div>
        <div class="hint-pill" id="hintStatus">
            <span>üí° Hints Used:</span>
            <span id="hintCount">0/3</span>
        </div>
        <div class="input-wrapper">
            <button id="hintBtn" class="hint-btn" onclick="useHint()" title="Get a Hint">üí°</button>
            <input type="text" id="textInput" placeholder="Type or use microphone..." autocomplete="off">
            <button class="mic-btn" id="micBtn" onclick="toggleRecording()" title="Speak">üé§</button>
            <button id="sendBtn" class="send-btn" onclick="sendText()">‚û§</button>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://ovszuxerimbmzfblzkgd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92c3p1eGVyaW1ibXpmYmx6a2dkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDA4MzgsImV4cCI6MjA4MDA3NjgzOH0.cmMF8OsC8J_B-t0aBldiMqv4XiNZtJWSGMqg8At9V14'; 
        
        let conversationLog = [];
        let currentHints = [];
        let hintsUsedCount = 0;
        const totalHints = 3;
        let isProcessing = false;
        let supabaseClient;
        let currentChildId = null;
        let currentProblem = null; 
        let puzzleSolved = false;
        let startTime;
        let OPENAI_API_KEY = "";

        // üß† DATA BANK (Problem + Answer Key)
        const localPuzzles = [
            { 
                id: 999, 
                text: "A farmer has 17 sheep and all but 9 die. How many are left?", 
                answer: "9",
                explanation: "The phrase 'all but 9 die' means 9 sheep survived. The rest died.",
                hints: ["Read 'all but 9' carefully.", "It means 9 are alive.", "The rest died."] 
            },
            { 
                id: 998, 
                text: "I am an odd number. Take away a letter and I become even. What number am I?", 
                answer: "Seven",
                explanation: "The word SEVEN is odd. Remove the letter 'S' and it becomes 'EVEN'.",
                hints: ["It's a word trick.", "Write down 'Seven'.", "Take away 'S'."] 
            }
        ];

        window.onload = function() {
            // 1. Key Check
            const storedKey = localStorage.getItem('user_openai_key');
            if (storedKey) {
                OPENAI_API_KEY = storedKey;
            } else {
                const userKey = prompt("‚ö†Ô∏è DEV MODE: Please enter your OpenAI API Key:");
                if (userKey && userKey.startsWith("sk-")) {
                    localStorage.setItem('user_openai_key', userKey);
                    OPENAI_API_KEY = userKey;
                }
            }

            // 2. Supabase Check
            if (typeof supabase !== 'undefined') {
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                supabaseClient.auth.getSession().then(({ data }) => {
                    if (data.session) {
                        supabaseClient.from('children').select('id').eq('parent_id', data.session.user.id).single()
                        .then(({data: child}) => { if(child) currentChildId = child.id; });
                    }
                });
            }

            // 3. Restore Session
            const savedSession = localStorage.getItem('lp_session');
            if (savedSession) {
                const data = JSON.parse(savedSession);
                // üß† RE-BIND PROBLEM: This ensures the AI remembers the answer key after refresh
                currentProblem = localPuzzles.find(x => x.id === data.id) || localPuzzles[0];
                
                currentHints = data.hints;
                hintsUsedCount = data.hintsCount;
                conversationLog = data.log || [];
                puzzleSolved = data.solved;

                document.getElementById('hintCount').innerText = `${hintsUsedCount}/${totalHints}`;
                
                conversationLog.forEach(msg => {
                    if (msg.role !== 'system') addMessage(msg.role, msg.content, false);
                });
                
                if (puzzleSolved) document.getElementById('finishBtn').style.display = 'block';
            } else {
                const p = localPuzzles[Math.floor(Math.random() * localPuzzles.length)];
                initGame(p);
            }
            startTimer();
        };

        function initGame(p) {
            currentProblem = p;
            currentHints = p.hints;
            hintsUsedCount = 0;
            puzzleSolved = false;
            conversationLog = [];
            
            document.getElementById('hintCount').innerText = `0/${totalHints}`;
            
            const intro = `Here is your mystery:<br><br><strong>"${p.text}"</strong><br><br>Ready?`;
            addMessage('ai', intro);
            speak(`Here is your mystery: ${p.text}`); // üîä VOICE
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                // Strip HTML for clean speech
                const cleanText = text.replace(/<[^>]*>/g, '');
                
                const utterance = new SpeechSynthesisUtterance(cleanText);
                const voices = window.speechSynthesis.getVoices();
                const preferred = voices.find(v => v.name.includes('Google US English') || v.name.includes('Samantha'));
                if (preferred) utterance.voice = preferred;
                
                utterance.rate = 1.0; 
                utterance.pitch = 1.1;
                window.speechSynthesis.speak(utterance);
            }
        }

        function saveState() {
            const state = {
                id: currentProblem.id,
                hints: currentHints,
                hintsCount: hintsUsedCount,
                log: conversationLog,
                solved: puzzleSolved
            };
            localStorage.setItem('lp_session', JSON.stringify(state));
        }

        async function sendText() {
            const textInput = document.getElementById('textInput');
            const text = textInput.value.trim();
            if(!text || isProcessing) return; 
            
            isProcessing = true; 
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('typingIndicator').classList.add('active');
            
            addMessage('user', text);
            conversationLog.push({ role: 'user', content: text });
            textInput.value = ""; 

            try {
                if (!OPENAI_API_KEY) throw new Error("Missing API Key. Refresh page.");

                // üß† THE "NO AMNESIA" PROMPT INJECTION
                // We inject the system instruction FRESH every single time.
                const messagesToSend = [
                    { 
                        role: 'system', 
                        content: `You are LogicPals, a Socratic Tutor for a child.
                        
                        CURRENT PROBLEM: "${currentProblem.text}"
                        SECRET ANSWER: "${currentProblem.answer}"
                        EXPLANATION: "${currentProblem.explanation}"

                        RULES:
                        1. If user is Correct: Say "Correct! üéâ" and explain why.
                        2. If user is Wrong: Validate their thought, then guide them back.
                        3. NEVER give the answer directly.
                        4. If the user says "what problem?", remind them of the text above.
                        5. Keep replies short (max 40 words).` 
                    },
                    ...conversationLog // Append history
                ];

                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: messagesToSend,
                        temperature: 0.7,
                        max_tokens: 150
                    })
                });

                if (!response.ok) throw new Error("AI Connection Failed");
                const data = await response.json();
                const reply = data.choices[0].message.content;

                addMessage('ai', reply);
                conversationLog.push({ role: 'assistant', content: reply });
                
                speak(reply); // üîä VOICE REPLY

                if (reply.toLowerCase().includes("correct") || reply.includes("üéâ")) {
                    puzzleSolved = true;
                    document.getElementById('finishBtn').style.display = 'block'; 
                    confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
                }

            } catch (error) {
                console.error(error);
                addMessage('ai', `‚ö†Ô∏è Error: ${error.message}`);
            } finally {
                isProcessing = false; 
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('typingIndicator').classList.remove('active');
                textInput.focus();
                saveState();
            }
        }

        function useHint() {
            if (hintsUsedCount < totalHints) {
                const hint = currentHints[hintsUsedCount];
                hintsUsedCount++;
                addMessage('hint', `üí° HINT: ${hint}`);
                speak(`Hint: ${hint}`); // üîä VOICE HINT
                document.getElementById('hintCount').innerText = `${hintsUsedCount}/${totalHints}`;
                saveState();
            }
        }

        function addMessage(sender, text, shouldSave = true) {
            const container = document.getElementById('chatContainer');
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', sender);
            if (sender === 'assistant') msgDiv.classList.add('ai');
            
            msgDiv.innerHTML = text; 
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
            if (shouldSave) saveState();
        }

        // üé§ BROWSER NATIVE MICROPHONE (Fixes "Voice Issue" without Server)
        function toggleRecording() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Voice input requires Chrome/Edge/Android.");
                return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = "en-US";
            
            recognition.onstart = () => {
                document.getElementById('micBtn').classList.add('recording');
            };
            
            recognition.onend = () => {
                document.getElementById('micBtn').classList.remove('recording');
            };
            
            recognition.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                document.getElementById('textInput').value = transcript;
                sendText(); // Auto-send
            };
            
            recognition.start();
        }

        async function finishSession() {
            const btn = document.getElementById('finishBtn');
            btn.innerText = "Saving...";
            
            if (supabaseClient && currentChildId) {
                try {
                    await supabaseClient.from('attempts').insert([{ 
                        child_id: currentChildId, 
                        problem_id: currentProblem.id, 
                        solved_correctly: true, 
                        hints_used: hintsUsedCount
                    }]);
                } catch(e) {}
            }
            localStorage.removeItem('lp_session'); 
            window.location.href = 'dashboard.html';
        }

        function startTimer() {
            startTime = Date.now();
            setInterval(() => {
                const delta = Math.floor((Date.now() - startTime) / 1000);
                const mins = Math.floor(delta / 60).toString().padStart(2, '0');
                const secs = (delta % 60).toString().padStart(2, '0');
                document.getElementById('timeDisplay').innerText = `${mins}:${secs}`;
            }, 1000);
        }
        
        document.getElementById('textInput').addEventListener('keydown', (e) => { if(e.key === 'Enter') sendText(); });
    </script>
</body>
</html>