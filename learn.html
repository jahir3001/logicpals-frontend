<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogicPals Tutor - Smart AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { --primary: #4F46E5; --bg: #F3F4F6; }
        body { font-family: 'Nunito', sans-serif; background: var(--bg); height: 100vh; display: flex; flex-direction: column; margin: 0; }
        
        header { background: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo { font-weight: 800; color: var(--primary); font-size: 18px; }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .action-btn { display: none; padding: 8px 16px; border-radius: 20px; border:none; cursor: pointer; font-weight: 700; background: #10B981; color: white; animation: pulse 1.5s infinite; }
        .dash-btn { background: #E5E7EB; color: #374151; text-decoration: none; padding: 8px 12px; border-radius: 12px; font-size: 12px; font-weight: 700; }

        .chat-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; max-width: 800px; margin: 0 auto; width: 100%; }
        .message { max-width: 85%; padding: 14px 18px; border-radius: 18px; font-size: 16px; line-height: 1.5; }
        .message.ai { align-self: flex-start; background: white; color: #1F2937; border-bottom-left-radius: 4px; }
        .message.user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        
        .input-area { background: white; padding: 15px 20px; border-top: 1px solid #E5E7EB; }
        .input-wrapper { max-width: 800px; margin: 0 auto; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px 15px; border: 2px solid #E5E7EB; border-radius: 50px; font-size: 16px; outline: none; }
        button { background: none; border: none; font-size: 20px; cursor: pointer; }
        .send-btn { color: var(--primary); font-size: 24px; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } }
        .typing { font-size: 13px; color: #6B7280; font-style: italic; margin-left: 20px; margin-bottom: 5px; opacity: 0; }
        .typing.active { opacity: 1; }
    </style>
</head>
<body>

    <header>
        <div class="logo">ðŸ§  LogicPals</div>
        <div class="header-controls">
            <a href="dashboard.html" class="dash-btn">Exit</a>
            <button id="nextBtn" onclick="loadNextPuzzle()" class="action-btn">ðŸŽ‰ Next Puzzle</button>
        </div>
    </header>

    <div class="chat-container" id="chatContainer"></div>

    <div class="input-area">
        <div class="typing" id="typingIndicator">LogicPals is thinking...</div>
        <div class="input-wrapper">
            <input type="text" id="textInput" placeholder="Type your answer..." autocomplete="off">
            <button class="send-btn" id="sendBtn" onclick="sendText()">âž¤</button>
        </div>
    </div>

    <script>
        const k_part1 = "sk-proj-dT54l3-DsOdBbN4RqvflV3Kv3BuIN0lBCFaDAgGgaNqGsMKS96CY8";
        const k_part2 = "2GX1gIJYa-RRmguTUOjkDT3BlbkFJmdKpyH1FXStC45hPW1983ZlAGV2j7KE7dFNyFJ3JywFTdR6YEpCQ1OEgtJ0REg1gkIOBy_vVYA";
        const OPENAI_API_KEY = k_part1 + k_part2;

        const supabaseUrl = 'https://ovszuxerimbmzfblzkgd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92c3p1eGVyaW1ibXpmYmx6a2dkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDA4MzgsImV4cCI6MjA4MDA3NjgzOH0.cmMF8OsC8J_B-t0aBldiMqv4XiNZtJWSGMqg8At9V14'; 
        const sb = supabase.createClient(supabaseUrl, supabaseKey);
        
        let conversationLog = [];
        let currentProblem = null;
        let puzzleSolved = false;
        let currentChildId = null;

        const localPuzzles = [
            { id: "999", text: "A farmer has 17 sheep and all but 9 die. How many are left?", answer_key: "9" },
            { id: "998", text: "I am an odd number. Take away a letter and I become even. What number am I?", answer_key: "7" }
        ];

        window.onload = async function() {
            let availablePuzzles = localPuzzles;
            
            // 1. Get Real Puzzles & User
            const { data: { session } } = await sb.auth.getSession();
            if (session) {
                const { data: child } = await sb.from('children').select('id').eq('parent_id', session.user.id).maybeSingle();
                if (child) currentChildId = child.id;

                const { data: dbProblems } = await sb.from('problems').select('*').eq('is_active', true);
                if (dbProblems && dbProblems.length > 0) availablePuzzles = dbProblems;
            }

            // 2. Start
            loadNextPuzzle(availablePuzzles);
        };

        function loadNextPuzzle(puzzles) {
            if (puzzles) window.puzzles = puzzles;
            const p = window.puzzles[Math.floor(Math.random() * window.puzzles.length)];
            currentProblem = p;
            puzzleSolved = false;
            conversationLog = [];
            
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('chatContainer').innerHTML = '';
            document.getElementById('textInput').value = '';
            
            addMessage('ai', `Here is your mystery:<br><br><strong>"${p.text || p.problem_text}"</strong><br><br>What do you think?`);
        }

        async function sendText() {
            const input = document.getElementById('textInput');
            const text = input.value.trim();
            if (!text) return;

            addMessage('user', text);
            conversationLog.push({ role: 'user', content: text });
            input.value = '';
            
            document.getElementById('typingIndicator').classList.add('active');

            try {
                // 3. ANSWER KEY LOGIC (The Brain Fix)
                const answerKey = currentProblem.answer_key || "unknown";
                
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            { 
                                role: 'system', 
                                content: `You are LogicPals Tutor. 
                                PROBLEM: "${currentProblem.text || currentProblem.problem_text}"
                                OFFICIAL ANSWER KEY: "${answerKey}"
                                
                                RULES:
                                1. IF the user's answer matches the KEY (e.g. "${answerKey}"), you MUST say "Correct! ðŸŽ‰" immediately.
                                2. IF the answer is "25" and key is "25", ACCEPT IT. Don't say "guessing".
                                3. If wrong, give a small hint.
                                4. Keep it short.` 
                            },
                            ...conversationLog
                        ],
                        temperature: 0.3
                    })
                });

                const data = await response.json();
                const reply = data.choices[0].message.content;
                
                addMessage('ai', reply);
                conversationLog.push({ role: 'assistant', content: reply });

                if (reply.includes("Correct") || reply.includes("ðŸŽ‰")) {
                    puzzleSolved = true;
                    document.getElementById('nextBtn').style.display = 'block';
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    
                    if (currentChildId && currentProblem.id) {
                        await sb.from('attempts').insert([{ 
                            child_id: currentChildId, 
                            problem_id: currentProblem.id, 
                            solved_correctly: true 
                        }]);
                    }
                }

            } catch (e) {
                console.error(e);
            } finally {
                document.getElementById('typingIndicator').classList.remove('active');
            }
        }

        function addMessage(role, text) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = text;
            document.getElementById('chatContainer').append(div);
            document.getElementById('chatContainer').scrollTop = 9999;
        }

        document.getElementById('textInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendText();
        });
    </script>
</body>
</html>