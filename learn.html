<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogicPals - Learn</title>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; margin: 0; padding: 0; }
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f4f8; display: flex; align-items: center; justify-content: center;
            z-index: 9999; font-size: 1.2rem; color: #333;
        }
        #chat-container { max-width: 600px; margin: 20px auto; padding-bottom: 80px; }
        .message { padding: 10px 15px; margin: 10px; border-radius: 10px; max-width: 80%; }
        .user { background-color: #2563eb; color: white; align-self: flex-end; margin-left: auto; }
        .ai { background-color: white; color: #333; border: 1px solid #ddd; align-self: flex-start; }
        .input-area {
            position: fixed; bottom: 0; width: 100%; background: white; padding: 15px;
            display: flex; justify-content: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        input { width: 300px; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        button { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 50%; margin-left: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="loading">
        Loading your mystery... üïµÔ∏è‚Äç‚ôÄÔ∏è
    </div>

    <div id="chat-container">
        </div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="Type or speak..." />
        <button onclick="handleSend()">‚û§</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        // REPLACE THESE WITH YOUR ACTUAL KEYS FROM YOUR CODE
        const supabaseUrl = 'https://ovszuxerimbmzfblzkgd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92c3p1eGVyaW1ibXpmYmx6a2dkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDA4MzgsImV4cCI6MjA4MDA3NjgzOH0.cmMF8OsC8J_B-t0aBldiMqv4XiNZtJWSGMqg8At9V14'; 

        let recentHistory = [];
        let isProcessing = false;

        // --- 2. THE FIX FOR "MYSTERY NOT LOADING" ---
        window.onload = async function() {
            const loader = document.getElementById('loading');
            
            try {
                // Fetch the mystery puzzle
                const response = await fetch(`${supabaseUrl}/rest/v1/problems?select=*&limit=1`, {
                    headers: { 
                        'apikey': supabaseKey, 
                        'Authorization': 'Bearer ' + supabaseKey 
                    }
                });

                if (!response.ok) throw new Error("Database error");
                
                const data = await response.json();
                
                if (data.length > 0) {
                    addMessage('ai', "Hi! Here is your mystery: \n\n" + data[0].question);
                    // Add to history so the AI knows the context
                    recentHistory.push({ role: 'assistant', content: data[0].question });
                } else {
                    addMessage('ai', "No mysteries found today!");
                }

            } catch (error) {
                console.error("Mystery Load Failed:", error);
                addMessage('ai', "‚ö†Ô∏è Could not load the mystery. Please check your connection.");
            } finally {
                // *** CRITICAL FIX: ALWAYS REMOVE LOADING SCREEN ***
                if (loader) loader.style.display = 'none';
            }
        };

        // --- 3. THE FIX FOR "CONNECTION FAILED / STACK OVERFLOW" ---
        async function handleSend() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text || isProcessing) return;

            // UI Updates
            addMessage('user', text);
            input.value = '';
            isProcessing = true;
            
            // Add temp loading message
            const tempId = 'loading-' + Date.now();
            const chatContainer = document.getElementById('chat-container');
            const tempDiv = document.createElement('div');
            tempDiv.className = 'message ai';
            tempDiv.id = tempId;
            tempDiv.innerText = "Thinking...";
            chatContainer.appendChild(tempDiv);

            // Update History
            recentHistory.push({ role: 'user', content: text });

            // *** CRITICAL FIX: Limit History Size ***
            const safeHistory = recentHistory.slice(-4); 

            try {
                const response = await fetch(`${supabaseUrl}/functions/v1/voice-tutor`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': 'Bearer ' + supabaseKey, 
                        'Content-Type': 'application/json' 
                    },
                    // Send SAFE history to prevent server crash
                    body: JSON.stringify({ text: text, history: safeHistory }) 
                });

                if (!response.ok) throw new Error(`Server Error: ${response.status}`);

                const data = await response.json();
                
                // Remove "Thinking..." message
                document.getElementById(tempId)?.remove();

                // Show AI Reply
                if (data.reply) {
                    addMessage('ai', data.reply);
                    recentHistory.push({ role: 'assistant', content: data.reply });
                }

                // Play Audio
                if (data.audio) {
                    const audio = new Audio("data:audio/mp3;base64," + data.audio);
                    audio.play().catch(e => console.warn("Autoplay blocked:", e));
                }

            } catch (error) {
                console.error("Error:", error);
                document.getElementById(tempId)?.remove();
                addMessage('ai', "‚ö†Ô∏è Connection failed: Could not reach tutor.");
                // NOTE: No recursive call here! (No getVoiceTutor())
            } finally {
                isProcessing = false;
            }
        }

        // Helper to add messages to screen
        function addMessage(sender, text) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            div.innerText = text;
            container.appendChild(div);
            window.scrollTo(0, document.body.scrollHeight);
        }
    </script>
</body>
</html>